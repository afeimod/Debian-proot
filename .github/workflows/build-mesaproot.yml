# build-mesaproot.yml
name: Build Mesa (aarch64)

on:
  workflow_dispatch:
    inputs:
      mesa_version:
        description: 'Mesa ç‰ˆæœ¬ (åˆ†æ”¯ã€æ ‡ç­¾æˆ–æäº¤å“ˆå¸Œ)'
        required: true
        default: 'main'
        type: string
      mesa_branch:
        description: 'Mesa åˆ†æ”¯ (å¯é€‰ï¼Œç”¨äºç‰¹å®šåˆ†æ”¯æ„å»º)'
        required: false
        default: ''
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
    - name: è®¾ç½® Mesa ç‰ˆæœ¬
      id: set_version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "MESA_VERSION=${{ github.event.inputs.mesa_version }}" >> $GITHUB_ENV
          echo "MESA_BRANCH=${{ github.event.inputs.mesa_branch }}" >> $GITHUB_ENV
        else
          echo "MESA_VERSION=main" >> $GITHUB_ENV
          echo "MESA_BRANCH=" >> $GITHUB_ENV
        fi
        
        BUILD_DATE=$(date +%Y%m%d)
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        
        echo "Mesa ç‰ˆæœ¬: $MESA_VERSION"
        echo "Mesa åˆ†æ”¯: $MESA_BRANCH"
        echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"

    - name: æ£€å‡ºæºç 
      uses: actions/checkout@v4

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo sed -i "s/^Types: deb$/Types: deb deb-src/" /etc/apt/sources.list.d/ubuntu.sources
        sudo apt update
        sudo apt install -y \
          glslang-tools \
          libxrandr-dev \
          libxxf86vm-dev \
          libxcb-shm0-dev \
          libxcb-glx0-dev \
          libxext-dev \
          llvm-19 \
          libx11-dev \
          libx11-xcb-dev \
          libxcb1-dev \
          libxcb-dri3-dev \
          libxcb-present-dev \
          libxcb-randr0-dev \
          libxcb-sync-dev \
          libxcb-xfixes0-dev \
          libxshmfence-dev \
          libdrm-dev \
          libgbm-dev \
          libegl1-mesa-dev \
          libexpat1-dev \
          libwayland-dev \
          python3-pip \
          pkg-config \
          bison \
          flex

    - name: å®‰è£… Meson å’Œ Ninja
      run: |
        # æ£€æŸ¥å¹¶å®‰è£…æœ€æ–°ç‰ˆ meson
        python3 -m pip install --user meson ninja mako
        # ç¡®ä¿ç”¨æˆ· bin ç›®å½•åœ¨ PATH ä¸­
        echo "export PATH=\"$HOME/.local/bin:\$PATH\"" >> ~/.bashrc
        source ~/.bashrc
        
        # éªŒè¯å®‰è£…
        echo "Meson ç‰ˆæœ¬:"
        python3 -m pip show meson
        echo "PATH: $PATH"
        echo "which meson: $(which meson || echo 'not found')"
        
        # å¦‚æœ which æ‰¾ä¸åˆ°ï¼Œå°è¯•ç›´æ¥è°ƒç”¨
        if ! command -v meson &> /dev/null; then
          echo "ä½¿ç”¨ Python æ¨¡å—è·¯å¾„ç›´æ¥è°ƒç”¨ meson"
          echo "alias meson=\"python3 -m mesonbuild.mesonmain\"" >> ~/.bashrc
          source ~/.bashrc
        fi

    - name: éªŒè¯ Meson å¯ç”¨æ€§
      run: |
        # å°è¯•å¤šç§æ–¹å¼è°ƒç”¨ meson
        echo "æµ‹è¯• meson å‘½ä»¤..."
        
        # æ–¹æ³•1: ç›´æ¥è°ƒç”¨
        if command -v meson &> /dev/null; then
          meson --version
          echo "âœ… meson å‘½ä»¤å¯ç”¨"
        else
          echo "å°è¯•æ–¹æ³•2: é€šè¿‡ Python æ¨¡å—è°ƒç”¨"
          python3 -c "from mesonbuild.mesonmain import main; import sys; sys.argv = ['meson', '--version']; main()"
          echo "âœ… Python æ¨¡å—å¯ç”¨"
          
          # åˆ›å»ºåŒ…è£…è„šæœ¬
          cat > ~/.local/bin/meson << 'EOF'
            #!/bin/bash
            exec python3 -m mesonbuild.mesonmain "$@"
          EOF
          chmod +x ~/.local/bin/meson
          export PATH="$HOME/.local/bin:$PATH"
        fi

    - name: å…‹éš†å¹¶å‡†å¤‡ Mesa æºç 
      run: |
        # å…‹éš† Mesa ä»“åº“ - ä½¿ç”¨ä¸ prootMesa.yml ç›¸åŒçš„ä»“åº“
        git clone https://github.com/lfdevs/mesa-for-android-container.git mesa
        
        cd mesa
        
        # æ£€æŸ¥å¹¶åˆ‡æ¢åˆ°æŒ‡å®šåˆ†æ”¯
        if [ -n "$MESA_BRANCH" ]; then
          echo "åˆ‡æ¢åˆ°åˆ†æ”¯: $MESA_BRANCH"
          if git checkout mesa-$MESA_BRANCH 2>/dev/null || git checkout $MESA_BRANCH 2>/dev/null; then
            echo "âœ… åˆ‡æ¢åˆ°åˆ†æ”¯ $MESA_BRANCH"
          else
            echo "âš ï¸  åˆ†æ”¯ $MESA_BRANCH ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯"
          fi
        fi
        
        # å¦‚æœæŒ‡å®šäº†ç‰ˆæœ¬ä¸”ä¸æ˜¯ mainï¼Œå°è¯•æ£€å‡º
        if [ "$MESA_VERSION" != "main" ]; then
          echo "å°è¯•æ£€å‡ºç‰ˆæœ¬: $MESA_VERSION"
          git checkout $MESA_VERSION 2>/dev/null || echo "ç‰ˆæœ¬ $MESA_VERSION ä¸å­˜åœ¨ï¼Œä½¿ç”¨å½“å‰åˆ†æ”¯"
        fi
        
        # è·å–ç‰ˆæœ¬ä¿¡æ¯
        MESA_COMMIT_HASH=$(git rev-parse --short HEAD)
        MESA_DESCRIBE=$(git describe --tags --always 2>/dev/null || echo "custom-$MESA_COMMIT_HASH")
        MESA_TAG=$(git describe --tags --exact-match 2>/dev/null || echo "")
        
        echo "MESA_COMMIT_HASH=$MESA_COMMIT_HASH" >> $GITHUB_ENV
        echo "MESA_DESCRIBE=$MESA_DESCRIBE" >> $GITHUB_ENV
        echo "MESA_TAG=$MESA_TAG" >> $GITHUB_ENV
        
        # ä» VERSION æ–‡ä»¶è·å–ç‰ˆæœ¬å·
        if [ -f "VERSION" ]; then
          OFFICIAL_VERSION=$(cat VERSION)
        else
          OFFICIAL_VERSION="$MESA_VERSION-$MESA_COMMIT_HASH"
        fi
        
        echo "OFFICIAL_VERSION=$OFFICIAL_VERSION" >> $GITHUB_ENV
        
        echo "âœ… æºç å‡†å¤‡å®Œæˆ"
        echo "ç‰ˆæœ¬: $OFFICIAL_VERSION"
        echo "æäº¤: $MESA_COMMIT_HASH"
        echo "æè¿°: $MESA_DESCRIBE"
        echo "æ ‡ç­¾: $MESA_TAG"

    - name: é…ç½®å’Œæ„å»º Mesa
      run: |
        cd mesa
        
        # åˆ›å»ºå®‰è£…ç›®å½•å¹¶è®¾ç½®æƒé™ - ä¸ prootMesa.yml ç›¸åŒ
        sudo mkdir -p /opt/mesa
        sudo chmod 777 -R /opt
        
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p builddir
        
        # ç¡®ä¿ PATH åŒ…å« meson
        export PATH="$HOME/.local/bin:$PATH"
        export PYTHONPATH="$HOME/.local/lib/python3.10/site-packages:$PYTHONPATH"
        
        echo "å½“å‰ PATH: $PATH"
        echo "Python è·¯å¾„:"
        python3 -c "import sys; print('\n'.join(sys.path))"
        
        # ä½¿ç”¨ meson é…ç½® - ä½¿ç”¨ä¸ prootMesa.yml å®Œå…¨ç›¸åŒçš„é…ç½®
        echo "é…ç½® Mesa æ„å»º..."
        meson setup builddir \
          --libdir=lib \
          -Dprefix=/opt/mesa \
          -Dbuildtype=release \
          -Doptimization=3 \
          -Db_lto=true \
          -Dplatforms=x11 \
          -Degl-native-platform=x11 \
          -Dglx=dri \
          -Dglx-direct=true \
          -Dopengl=true \
          -Dgles1=enabled \
          -Dgles2=enabled \
          -Dglvnd=disabled \
          -Degl=enabled \
          -Dllvm=enabled \
          -Dshared-llvm=enabled \
          -Dshader-cache=enabled \
          -Dshared-glapi=enabled \
          -Dxlib-lease=enabled \
          -Dvulkan-beta=true \
          -Dlibunwind=disabled \
          -Dvalgrind=disabled \
          -Dmicrosoft-clc=disabled \
          -Dgallium-rusticl=false \
          -Dgallium-extra-hud=true \
          -Dgallium-drivers=zink,freedreno,llvmpipe,softpipe \
          -Dgallium-rusticl-enable-drivers=freedreno \
          -Dshader-cache-default=true \
          -Dvulkan-drivers=freedreno,swrast \
          -Dfreedreno-kmds=msm,kgsl \
          -Dvideo-codecs=all \
          -Dmediafoundation-codecs=all \
          -Dgbm=enabled \
          -Dtools=drm-shim,freedreno
        
        # æ„å»º
        echo "å¼€å§‹æ„å»º..."
        BUILD_START=$(date +%s)
        ninja -C builddir -j$(nproc)
        BUILD_END=$(date +%s)
        
        echo "å®‰è£…..."
        ninja -C builddir install
        
        BUILD_TIME=$((BUILD_END - BUILD_START))
        echo "âœ… æ„å»ºå®Œæˆï¼Œè€—æ—¶: ${BUILD_TIME}ç§’"
        
        # éªŒè¯æ„å»º
        echo "éªŒè¯æ„å»ºç»“æœ:"
        ls -la /opt/mesa/lib/ | head -20


    - name: æ‰“åŒ…æ„å»ºäº§ç‰©
      run: |
        echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
        
        # åˆ›å»ºç‰ˆæœ¬åŒ–çš„åŒ…å - ä¸ prootMesa.yml ç±»ä¼¼çš„å‘½å
        VERSION_SHORT=$(echo "$OFFICIAL_VERSION" | cut -c1-20)
        TAR_NAME="termux-proot-mesa-${VERSION_SHORT}-aarch64.tar.gz"
        FULL_TAR="proot-mesa-${VERSION_SHORT}-aarch64.tar.gz"
        
        echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV
        echo "FULL_TAR=$FULL_TAR" >> $GITHUB_ENV
        
        # ä»…æ‰“åŒ… Vulkan é©±åŠ¨ - ä¸ prootMesa.yml ç›¸åŒ
        cd mesa/builddir
        tar -czvf "../../${TAR_NAME}" src/freedreno/vulkan/libvulkan_freedreno.so 2>/dev/null || \
          tar -czvf "../../${TAR_NAME}" -C /opt/mesa lib/libvulkan_freedreno.so
        
        # æ‰“åŒ…å®Œæ•´å®‰è£…ç›®å½• - ä¸ prootMesa.yml ç›¸åŒ
        cd /opt
        tar -czvf "${GITHUB_WORKSPACE}/${FULL_TAR}" mesa/
        
        cd $GITHUB_WORKSPACE
        sha256sum "${TAR_NAME}" > "${TAR_NAME}.sha256"
        sha256sum "${FULL_TAR}" > "${FULL_TAR}.sha256"
        
        echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ:"
        ls -lh *.tar.gz

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: mesa-artifacts-${{ env.OFFICIAL_VERSION }}-aarch64
        path: |
          ${{ env.TAR_NAME }}
          ${{ env.FULL_TAR }}
          ${{ env.TAR_NAME }}.sha256
          ${{ env.FULL_TAR }}.sha256

    - name: åˆ›å»ºå‘å¸ƒæ ‡ç­¾å’Œ Release
      if: ${{ github.event_name == 'workflow_dispatch' }}
      run: |
        # åˆ›å»ºå‘å¸ƒæ ‡ç­¾
        if [ -n "$MESA_TAG" ] && [ "$MESA_TAG" != "" ]; then
          RELEASE_TAG="$MESA_TAG-termux"
        else
          RELEASE_TAG="mesa-$OFFICIAL_VERSION-$BUILD_DATE-termux"
        fi
        
        echo "RELEASE_TAG=$RELEASE_TAG" >> $GITHUB_ENV
        echo "å‘å¸ƒæ ‡ç­¾: $RELEASE_TAG"

    - name: å‘å¸ƒåˆ° GitHub Release
      uses: softprops/action-gh-release@v1
      if: ${{ github.event_name == 'workflow_dispatch' }}
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: Mesa ${{ env.OFFICIAL_VERSION }} (aarch64, Termux glibc)
        body: |
          Mesa 3D Graphics Library for Termux glibc
          
          æ„å»ºä¿¡æ¯:
          - **ç‰ˆæœ¬**: ${{ env.OFFICIAL_VERSION }}
          - **Git æè¿°**: ${{ env.MESA_DESCRIBE }}
          - **æäº¤å“ˆå¸Œ**: ${{ env.MESA_COMMIT_HASH }}
          - **æ„å»ºæ—¥æœŸ**: ${{ env.BUILD_DATE }}
          - **ç›®æ ‡æ¶æ„**: aarch64
          - **ç¯å¢ƒ**: Termux glibc
          
          é©±åŠ¨æ”¯æŒ:
          - âœ… Gallium Drivers: zink, freedreno, llvmpipe, softpipe
          - âœ… Vulkan Drivers: freedreno, swrast
          - âœ… OpenGL, OpenGL ES 1.x, OpenGL ES 2.x
          - âœ… EGL, GBM
          
          åŒ…å«æ–‡ä»¶:
          - `${{ env.TAR_NAME }}` - ä»… Vulkan é©±åŠ¨
          - `${{ env.FULL_TAR }}` - å®Œæ•´ Mesa å®‰è£…
          
          å®‰è£…è¯´æ˜:
          1. ä¸‹è½½å®Œæ•´åŒ…: `${{ env.FULL_TAR }}`
          2. åœ¨ Termux glibc ç¯å¢ƒä¸­è§£å‹: `tar -xzf ${{ env.FULL_TAR }} -C /`
          3. æˆ–ä»…å®‰è£… Vulkan é©±åŠ¨: `tar -xzf ${{ env.TAR_NAME }} -C /path/to/lib`
        files: |
          ${{ env.TAR_NAME }}
          ${{ env.FULL_TAR }}
          ${{ env.TAR_NAME }}.sha256
          ${{ env.FULL_TAR }}.sha256
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: è¾“å‡ºæ€»ç»“ä¿¡æ¯
      run: |
        echo "âœ… Mesa æ„å»ºå®Œæˆ"
        echo "================================"
        echo "ç‰ˆæœ¬: $OFFICIAL_VERSION"
        echo "æäº¤: $MESA_COMMIT_HASH"
        echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"
        echo "ç›®æ ‡æ¶æ„: aarch64"
        echo "ç¯å¢ƒ: Termux glibc"
        echo ""
        echo "ğŸ“¦ æ„å»ºäº§ç‰©:"
        echo "- $TAR_NAME (Vulkan é©±åŠ¨)"
        echo "- $FULL_TAR (å®Œæ•´å®‰è£…)"
        echo ""
        echo "é©±åŠ¨æ”¯æŒ:"
        echo "âœ“ Gallium: zink, freedreno, llvmpipe, softpipe"
        echo "âœ“ Vulkan: freedreno, swrast"
        echo "âœ“ OpenGL, OpenGL ES 1.x/2.x"
        echo "âœ“ EGL, GBM"
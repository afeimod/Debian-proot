# build-mesaproot.yml
name: Build Mesa for Proot (aarch64)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: '构建类型 (开发版/正式版/自定义)'
        required: false
        default: 'dev'
        type: choice
        options:
          - 'dev'
          - 'stable'
          - 'custom'
      mesa_version:
        description: 'Mesa 版本/标签/提交 (仅自定义类型使用，例如: 24.1.0, main, 哈希)'
        required: false
        default: ''
        type: string
      use_upstream:
        description: '是否使用上游官方 Mesa (而不是 lfdevs 的分支)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm

    steps:
    - name: 设置构建参数
      id: setup
      run: |
        # 设置默认参数
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "BUILD_TYPE=${{ github.event.inputs.build_type }}" >> $GITHUB_ENV
          echo "MESA_VERSION_INPUT=${{ github.event.inputs.mesa_version }}" >> $GITHUB_ENV
          echo "USE_UPSTREAM=${{ github.event.inputs.use_upstream }}" >> $GITHUB_ENV
        else
          echo "BUILD_TYPE=dev" >> $GITHUB_ENV
          echo "MESA_VERSION_INPUT=" >> $GITHUB_ENV
          echo "USE_UPSTREAM=false" >> $GITHUB_ENV
        fi
        
        BUILD_DATE=$(date +%Y%m%d)
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        
        echo "构建类型: $BUILD_TYPE"
        echo "输入的 Mesa 版本: $MESA_VERSION_INPUT"
        echo "是否使用上游: $USE_UPSTREAM"
        echo "构建日期: $BUILD_DATE"

    - name: 检出仓库
      uses: actions/checkout@v4

    - name: 显示环境信息
      run: |
        echo "构建环境信息:"
        uname -a
        lscpu | grep -E 'Model name|Architecture|CPU MHz|Core'
        free -h

    - name: 安装系统依赖
      run: |
        sudo sed -i "s/^Types: deb$/Types: deb deb-src/" /etc/apt/sources.list.d/ubuntu.sources
        sudo apt update
        sudo apt install -y build-essential glslang-tools libxrandr-dev libxxf86vm-dev libxcb-shm0-dev \
            libxcb-glx0-dev libxcb-xfixes0-dev libxext-dev llvm-19 libx11-dev libx11-xcb-dev libxcb1-dev libxcb-dri3-dev \
            libxcb-present-dev libxcb-randr0-dev libxcb-sync-dev libxshmfence-dev \
            libdrm-dev libgbm-dev libegl1-mesa-dev libexpat1-dev libwayland-dev python3-pip \
            python3-setuptools python3-wheel ninja-build flex bison libpthread-stubs0-dev \
            libunwind-dev libvulkan-dev libzstd-dev libelf-dev libudev-dev libsensors-dev \
            libcap-dev gettext

    - name: 安装 Python 构建工具
      run: |
        # 使用系统级的 pip 安装，避免用户级安装的路径问题
        sudo pip3 install meson mako
        
        # 验证安装
        echo "检查安装的 meson 版本:"
        meson --version
        python3 -c "import mesonbuild; print('mesonbuild 模块路径:', mesonbuild.__file__)"
        
        # 设置环境变量，确保能找到所有工具
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: 克隆 Mesa 源码
      id: clone_mesa
      run: |
        echo "📥 克隆 Mesa 仓库..."
        
        if [ "$USE_UPSTREAM" = "true" ]; then
          echo "使用上游官方 Mesa 仓库"
          MESA_REPO="https://gitlab.freedesktop.org/mesa/mesa.git"
        else
          echo "使用 lfdevs 的 Mesa for Android Container 仓库"
          MESA_REPO="https://github.com/lfdevs/mesa-for-android-container.git"
        fi
        
        git clone --depth 1 $MESA_REPO mesa
        cd mesa
        
        # 根据构建类型确定版本
        if [ "$USE_UPSTREAM" = "true" ]; then
          # 上游官方仓库的版本选择逻辑
          if [ "$BUILD_TYPE" = "custom" ] && [ -n "$MESA_VERSION_INPUT" ]; then
            echo "使用自定义版本: $MESA_VERSION_INPUT"
            VERSION_TO_USE="$MESA_VERSION_INPUT"
          elif [ "$BUILD_TYPE" = "stable" ]; then
            echo "获取最新稳定版标签..."
            # 获取最新稳定标签
            git fetch --depth 1 --tags
            LATEST_TAG=$(git describe --tags $(git rev-list --tags --max-count=1) 2>/dev/null || echo "24.1.0")
            VERSION_TO_USE="$LATEST_TAG"
          else
            echo "使用开发版 (main 分支)"
            VERSION_TO_USE="main"
          fi
        else
          # lfdevs 仓库的版本选择逻辑 - 默认使用 adreno-main 分支
          if [ "$BUILD_TYPE" = "custom" ] && [ -n "$MESA_VERSION_INPUT" ]; then
            echo "使用自定义版本: $MESA_VERSION_INPUT"
            VERSION_TO_USE="$MESA_VERSION_INPUT"
          else
            echo "lfdevs 仓库使用默认分支 adreno-main"
            VERSION_TO_USE="adreno-main"
          fi
        fi
        
        echo "最终使用的版本: $VERSION_TO_USE"
        
        # 检出指定的版本/标签/提交
        if [ "$USE_UPSTREAM" = "true" ]; then
          # 上游仓库：查找标签或分支
          if git tag -l | grep -q "^$VERSION_TO_USE$"; then
            echo "检出标签: $VERSION_TO_USE"
            git fetch --depth 1 origin tag "$VERSION_TO_USE"
            git checkout -b build "$VERSION_TO_USE"
          elif git ls-remote --heads origin "$VERSION_TO_USE" | grep -q "$VERSION_TO_USE"; then
            echo "检出分支: $VERSION_TO_USE"
            git fetch --depth 1 origin "$VERSION_TO_USE"
            git checkout -b build "$VERSION_TO_USE"
          else
            echo "未找到标签或分支 $VERSION_TO_USE，尝试作为提交哈希"
            if git rev-parse --verify "$VERSION_TO_USE" 2>/dev/null; then
              echo "检出提交: $VERSION_TO_USE"
              git checkout "$VERSION_TO_USE"
            else
              echo "版本 $VERSION_TO_USE 不存在，使用 main 分支"
              git checkout main
            fi
          fi
        else
          # lfdevs仓库：只处理分支
          if [ -n "$VERSION_TO_USE" ]; then
            echo "尝试检出分支: $VERSION_TO_USE"
            if git ls-remote --heads origin "$VERSION_TO_USE" | grep -q "$VERSION_TO_USE"; then
              git fetch --depth 1 origin "$VERSION_TO_USE"
              git checkout -b build "$VERSION_TO_USE"
            else
              echo "分支 $VERSION_TO_USE 不存在，使用默认分支 adreno-main"
              git checkout adreno-main
              VERSION_TO_USE="adreno-main"
            fi
          else
            echo "检出默认分支 adreno-main"
            git checkout adreno-main
            VERSION_TO_USE="adreno-main"
          fi
        fi
        
        # 获取版本信息
        GIT_HASH=$(git rev-parse --short HEAD)
        if [ -f "VERSION" ]; then
          OFFICIAL_VERSION=$(cat VERSION)
        else
          OFFICIAL_VERSION=$(git describe --tags --always 2>/dev/null || echo "git-$GIT_HASH")
        fi
        
        # 自定义品牌（仅上游官方仓库）
        if [ "$USE_UPSTREAM" = "true" ]; then
          echo "🔧 自定义品牌: Turnip → Qualcomm Snapdragon"
          if [ -f "src/freedreno/vulkan/tu_device.cc" ]; then
            sed -i 's/Turnip Adreno (TM) %s%s/Qualcomm Snapdragon Adreno (TM) %s%s/' src/freedreno/vulkan/tu_device.cc
            sed -i 's/"turnip Mesa driver"/"Qualcomm Snapdragon Driver"/' src/freedreno/vulkan/tu_device.cc
            sed -i 's/"Mesa " PACKAGE_VERSION MESA_GIT_SHA1/"Qualcomm Snapdragon " PACKAGE_VERSION MESA_GIT_SHA1/' src/freedreno/vulkan/tu_device.cc
          else
            echo "警告: tu_device.cc 文件不存在，跳过品牌自定义"
          fi
        fi
        
        # 根据构建类型确定包名
        if [ "$BUILD_TYPE" = "custom" ] && [ -n "$MESA_VERSION_INPUT" ]; then
          PACKAGE_VERSION="$MESA_VERSION_INPUT-$GIT_HASH"
        elif [ "$BUILD_TYPE" = "stable" ]; then
          PACKAGE_VERSION="$OFFICIAL_VERSION"
        else
          PACKAGE_VERSION="dev-$OFFICIAL_VERSION-$GIT_HASH"
        fi
        
        GIT_DESCRIBE=$(git describe --tags --always 2>/dev/null || echo "custom-$GIT_HASH")
        
        echo "MESA_GIT_HASH=$GIT_HASH" >> $GITHUB_ENV
        echo "MESA_VERSION=$OFFICIAL_VERSION" >> $GITHUB_ENV
        echo "PACKAGE_VERSION=$PACKAGE_VERSION" >> $GITHUB_ENV
        echo "GIT_DESCRIBE=$GIT_DESCRIBE" >> $GITHUB_ENV
        echo "VERSION_TO_USE=$VERSION_TO_USE" >> $GITHUB_ENV
        
        echo "✅ 源码克隆完成"
        echo "版本: $OFFICIAL_VERSION"
        echo "包版本: $PACKAGE_VERSION"
        echo "提交: $GIT_HASH"
        echo "描述: $GIT_DESCRIBE"
        echo "分支: $(git branch --show-current)"
        echo "构建类型: $BUILD_TYPE"
        echo "使用的仓库: $(if [ "$USE_UPSTREAM" = "true" ]; then echo "上游官方"; else echo "lfdevs/android-container"; fi)"

    - name: 构建 Mesa
      run: |
        cd mesa
        
        echo "🔨 开始构建 Mesa..."
        BUILD_START=$(date +%s)
        
        # 创建安装目录
        sudo mkdir -p /opt/mesa
        sudo chmod 777 -R /opt
        
        # 创建构建目录
        mkdir -p builddir
        
        # 验证使用的工具
        echo "检查构建工具:"
        which meson
        meson --version
        which ninja
        ninja --version
        
        # 配置构建选项
        # 特别注意：添加 freedreno-kmds=kgsl,msm 并启用相关选项
        meson setup builddir \
          --libdir=lib \
          -Dprefix=/opt/mesa \
          -Dbuildtype=release \
          -Doptimization=3 \
          -Dcpp_args="-O3 -march=native -mtune=native" \
          -Dc_args="-O3 -march=native -mtune=native" \
          -Db_lto=true \
          -Dplatforms=x11 \
          -Degl-native-platform=x11 \
          -Dglx=dri \
          -Dglx-direct=true \
          -Dopengl=true \
          -Dgles1=enabled \
          -Dgles2=enabled \
          -Dglvnd=disabled \
          -Degl=enabled \
          -Dshader-cache=enabled \
          -Dllvm=enabled \
          -Dshared-llvm=enabled \
          -Dxlib-lease=enabled \
          -Dvulkan-drivers=freedreno,swrast \
          -Dfreedreno-kmds=kgsl,msm \
          -Dlibunwind=disabled \
          -Dvalgrind=disabled \
          -Dgallium-drivers=zink,freedreno,llvmpipe,virgl,softpipe \
          -Dgallium-extra-hud=true \
          -Dvideo-codecs=all \
          -Dtools=drm-shim,freedreno \
          -Dgbm=enabled \
          -Dlmsensors=disabled \
          -Dpower8=disabled \
          -Dgallium-rusticl=false \
          -Dgallium-rusticl-enable-drivers=freedreno
        
        # 检查配置状态
        echo "配置状态检查:"
        meson configure builddir || true
        
        # 开始构建
        echo "🏗️  正在构建..."
        ninja -C builddir -j$(nproc)
        
        echo "📦 正在安装..."
        sudo ninja -C builddir install
        
        # 确保 gallium-pipe 目录存在并包含必要的文件
        echo "确保 gallium-pipe 目录结构..."
        sudo mkdir -p /opt/mesa/lib/gallium-pipe
        if [ -d "builddir/src/gallium/targets/pipe-loader" ]; then
          echo "复制 pipe-loader 文件..."
          sudo cp -f builddir/src/gallium/targets/pipe-loader/*.so /opt/mesa/lib/gallium-pipe/ 2>/dev/null || true
        fi
        
        # 确保 kgsl 相关的驱动存在
        echo "检查 freedreno 驱动..."
        if [ -d "/opt/mesa/lib/dri" ]; then
          echo "已安装的 DRI 驱动:"
          ls -la /opt/mesa/lib/dri/ || true
        fi
        
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        echo "✅ 构建完成，耗时: ${BUILD_TIME}秒"
        
        # 验证安装
        echo "安装验证:"
        ls -la /opt/mesa/
        echo "lib 目录:"
        ls -la /opt/mesa/lib/ 2>/dev/null || true
        echo "gallium-pipe 目录:"
        ls -la /opt/mesa/lib/gallium-pipe/ 2>/dev/null || true

    - name: 打包构建产物
      run: |
        echo "📦 开始打包..."
        
        # 创建版本化的包名
        PACKAGE_NAME="proot-mesa-${PACKAGE_VERSION}-aarch64"
        
        # 打包完整安装目录
        cd /opt
        tar -czvf "${HOME}/${PACKAGE_NAME}-full.tar.gz" mesa/
        
        # 创建仅包含关键文件的轻量包
        cd /opt/mesa
        mkdir -p /tmp/mesa-light/{lib,share}
        
        # 复制库文件
        if [ -d "lib" ]; then
          cp -r lib/* /tmp/mesa-light/lib/ 2>/dev/null || true
        fi
        
        # 复制必要的共享文件
        if [ -d "share" ]; then
          cp -r share/glvnd /tmp/mesa-light/share/ 2>/dev/null || true
          cp -r share/drirc.d /tmp/mesa-light/share/ 2>/dev/null || true
          cp -r share/vulkan /tmp/mesa-light/share/ 2>/dev/null || true
        fi
        
        # 打包轻量版
        cd /tmp
        tar -czvf "${HOME}/${PACKAGE_NAME}-light.tar.gz" mesa-light/
        
        # 移动回工作目录
        cd $GITHUB_WORKSPACE
        mv "${HOME}/${PACKAGE_NAME}-full.tar.gz" .
        mv "${HOME}/${PACKAGE_NAME}-light.tar.gz" .
        
        # 生成校验和
        sha256sum ${PACKAGE_NAME}-*.tar.gz > checksums.txt
        
        # 设置输出变量
        echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
        echo "FULL_PACKAGE=${PACKAGE_NAME}-full.tar.gz" >> $GITHUB_ENV
        echo "LIGHT_PACKAGE=${PACKAGE_NAME}-light.tar.gz" >> $GITHUB_ENV
        
        echo "📦 打包完成:"
        ls -lh *.tar.gz

    - name: 上传构建产物
      uses: actions/upload-artifact@v4
      with:
        name: proot-mesa-${{ env.PACKAGE_VERSION }}-aarch64
        path: |
          ${{ env.PACKAGE_NAME }}-*.tar.gz
          checksums.txt

    - name: 创建轻量级发布
      uses: softprops/action-gh-release@v1
      if: ${{ github.event_name == 'workflow_dispatch' }}
      with:
        tag_name: proot-mesa-${{ env.PACKAGE_VERSION }}-${{ env.BUILD_DATE }}
        name: Mesa Proot ${{ env.PACKAGE_VERSION }} (aarch64)
        body: |
          Mesa 3D Graphics Library for Termux Proot (glibc) on aarch64
          
          构建信息:
          - **构建类型**: $(if [ "${{ env.BUILD_TYPE }}" = "dev" ]; then echo "开发版"; elif [ "${{ env.BUILD_TYPE }}" = "stable" ]; then echo "正式版"; else echo "自定义版本"; fi)
          - **版本**: ${{ env.MESA_VERSION }}
          - **包版本**: ${{ env.PACKAGE_VERSION }}
          - **Git 描述**: ${{ env.GIT_DESCRIBE }}
          - **提交哈希**: ${{ env.MESA_GIT_HASH }}
          - **构建日期**: ${{ env.BUILD_DATE }}
          - **使用的版本**: ${{ env.VERSION_TO_USE }}
          - **仓库**: $(if [ "${{ env.USE_UPSTREAM }}" = "true" ]; then echo "上游官方"; else echo "lfdevs/android-container"; fi)
          
          包含文件:
          - `${{ env.FULL_PACKAGE }}` - 完整 Mesa 安装包 (包含所有开发文件)
          - `${{ env.LIGHT_PACKAGE }}` - 轻量版安装包 (仅运行时文件)
          - `checksums.txt` - 校验和文件
          
          驱动支持:
          - ✅ Freedreno with KGSL support
          - ✅ Zink (OpenGL on Vulkan)
          - ✅ LLVMPIPE (软件渲染)
          - ✅ VirGL (虚拟化)
          - ✅ Vulkan: freedreno, swrast
          - ✅ 包含 gallium-pipe 目录
          
          安装说明:
          1. 下载完整的 tar.gz 包
          2. 在 Proot 环境中解压到根目录: `tar -xzf package.tar.gz -C /`
          3. 设置环境变量:
             ```bash
             export LD_LIBRARY_PATH=/opt/mesa/lib:$LD_LIBRARY_PATH
             export LIBGL_DRIVERS_PATH=/opt/mesa/lib/dri
             export VK_ICD_FILENAMES=/opt/mesa/share/vulkan/icd.d/freedreno_icd.aarch64.json
             export GALLIUM_DRIVER_DIR=/opt/mesa/lib/gallium-pipe
             ```
          
          注意:
          - 需要 Termux 的 glibc 环境 (如 proot-distro 的 Ubuntu/Debian)
          - 推荐在 Proot 容器中使用
          - 包含 KGSL 支持，适用于 Android 内核
        files: |
          ${{ env.PACKAGE_NAME }}-*.tar.gz
          checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: 输出总结
      run: |
        echo "✅ Mesa Proot 构建完成!"
        echo "================================"
        echo "构建类型: $(if [ "$BUILD_TYPE" = "dev" ]; then echo "开发版"; elif [ "$BUILD_TYPE" = "stable" ]; then echo "正式版"; else echo "自定义版本"; fi)"
        echo "版本: $MESA_VERSION"
        echo "包版本: $PACKAGE_VERSION"
        echo "提交: $MESA_GIT_HASH"
        echo "构建日期: $BUILD_DATE"
        echo "使用的版本: $VERSION_TO_USE"
        echo "目标架构: aarch64"
        echo "环境: Termux Proot (glibc)"
        echo "使用的仓库: $(if [ "$USE_UPSTREAM" = "true" ]; then echo "上游官方"; else echo "lfdevs/android-container"; fi)"
        echo ""
        echo "📦 生成的文件:"
        ls -1 *.tar.gz | while read file; do
          echo "  - $file"
        done
        echo ""
        echo "驱动支持:"
        echo "  ✅ Gallium: zink, freedreno (with KGSL), llvmpipe, virgl"
        echo "  ✅ Vulkan: freedreno, swrast"
        echo "  ✅ OpenGL, OpenGL ES 1.x/2.x"
        echo "  ✅ EGL, GBM"
        echo "  ✅ gallium-pipe 目录: $(ls -d /opt/mesa/lib/gallium-pipe 2>/dev/null && echo '存在' || echo '缺失')"
        echo ""
        echo "重要修复:"
        echo "  ✓ 支持 KGSL (Android 内核)"
        echo "  ✓ 包含 gallium-pipe 目录"
        echo "  ✓ 正确版本控制"
        echo "  ✓ 支持开发版/正式版/自定义版本选择"
name: Create Bootstraps

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 1 * *'

jobs:
  create-bootstraps:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y debootstrap schroot wget xz-utils qemu-user-static binfmt-support
      
      - name: Create directories
        run: |
          sudo mkdir -p /opt/chroots
          sudo chmod 755 /opt/chroots
      
      - name: Create 64-bit bootstrap
        run: |
          sudo debootstrap --arch=amd64 bionic /opt/chroots/bionic64_chroot http://archive.ubuntu.com/ubuntu/
          
          # Set up basic configuration and repositories
          sudo chroot /opt/chroots/bionic64_chroot /bin/bash << 'EOL'
          # Add universe and multiverse repositories
          echo "deb http://archive.ubuntu.com/ubuntu/ bionic main universe multiverse" > /etc/apt/sources.list
          echo "deb http://archive.ubuntu.com/ubuntu/ bionic-updates main universe multiverse" >> /etc/apt/sources.list
          echo "deb http://archive.ubuntu.com/ubuntu/ bionic-security main universe multiverse" >> /etc/apt/sources.list
          
          apt update
          apt install -y software-properties-common
          add-apt-repository -y ppa:ubuntu-toolchain-r/test
          
          # Update and install basic build tools first
          apt update
          apt install -y build-essential autoconf automake flex bison libtool \
            pkg-config gettext nasm yasm cmake meson ninja-build
          
          # Install development libraries (using available packages in bionic)
          apt install -y libx11-dev libfreetype6-dev libfontconfig1-dev \
            libasound2-dev libpulse-dev libdbus-1-dev libudev-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            libsdl2-dev libgnutls28-dev libldap2-dev libjpeg-dev \
            libpng-dev libtiff5-dev libmpg123-dev libopenal-dev \
            libcups2-dev libosmesa6-dev libpcap-dev libusb-1.0-0-dev \
            libsane-dev libv4l-dev libgphoto2-dev liblcms2-dev \
            libpcsclite-dev libacl1-dev libxml2-dev libxslt1-dev \
            libavcodec-dev libavformat-dev libavutil-dev libswresample-dev \
            libvpx-dev libx264-dev libx265-dev libva-dev libdrm-dev \
            libwayland-dev libxkbcommon-dev libegl1-mesa-dev libgl1-mesa-dev \
            libgles2-mesa-dev libglu1-mesa-dev libxi-dev libxrandr-dev \
            libxfixes-dev libxcursor-dev libxinerama-dev libxcomposite-dev \
            libxdamage-dev libxxf86vm-dev libxt-dev libxmu-dev libxtst-dev
          
          # Install Vulkan development packages if available
          apt install -y vulkan-utils || echo "Vulkan not available, continuing..."
          apt install -y libvulkan1 || echo "libvulkan1 not available, continuing..."
          
          # Install CAPI development packages if available
          apt install -y libcapi20-3 libcapi20-dev || echo "CAPI packages not available, continuing..."
          
          # Install newer GCC if available
          apt install -y gcc-9 g++-9 gcc-10 g++-10 || echo "Newer GCC versions not available, installing default"
          apt install -y gcc g++
          
          # Install cross-compilers
          apt install -y gcc-mingw-w64-x86-64 g++-mingw-w64-x86-64
          update-alternatives --set x86_64-w64-mingw32-gcc /usr/bin/x86_64-w64-mingw32-gcc-posix
          update-alternatives --set x86_64-w64-mingw32-g++ /usr/bin/x86_64-w64-mingw32-g++-posix
          EOL
      
      - name: Create 32-bit bootstrap
        run: |
          sudo debootstrap --arch=i386 bionic /opt/chroots/bionic32_chroot http://archive.ubuntu.com/ubuntu/
          
          # Set up basic configuration and repositories
          sudo chroot /opt/chroots/bionic32_chroot /bin/bash << 'EOL'
          # Add universe and multiverse repositories
          echo "deb http://archive.ubuntu.com/ubuntu/ bionic main universe multiverse" > /etc/apt/sources.list
          echo "deb http://archive.ubuntu.com/ubuntu/ bionic-updates main universe multiverse" >> /etc/apt/sources.list
          echo "deb http://archive.ubuntu.com/ubuntu/ bionic-security main universe multiverse" >> /etc/apt/sources.list
          
          apt update
          apt install -y software-properties-common
          add-apt-repository -y ppa:ubuntu-toolchain-r/test
          
          # Update and install basic build tools first
          apt update
          apt install -y build-essential autoconf automake flex bison libtool \
            pkg-config gettext nasm yasm cmake meson ninja-build
          
          # Install development libraries (using available packages in bionic)
          apt install -y libx11-dev libfreetype6-dev libfontconfig1-dev \
            libasound2-dev libpulse-dev libdbus-1-dev libudev-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            libsdl2-dev libgnutls28-dev libldap2-dev libjpeg-dev \
            libpng-dev libtiff5-dev libmpg123-dev libopenal-dev \
            libcups2-dev libosmesa6-dev libpcap-dev libusb-1.0-0-dev \
            libsane-dev libv4l-dev libgphoto2-dev liblcms2-dev \
            libpcsclite-dev libacl1-dev libxml2-dev libxslt1-dev \
            libavcodec-dev libavformat-dev libavutil-dev libswresample-dev \
            libvpx-dev libx264-dev libx265-dev libva-dev libdrm-dev \
            libwayland-dev libxkbcommon-dev libegl1-mesa-dev libgl1-mesa-dev \
            libgles2-mesa-dev libglu1-mesa-dev libxi-dev libxrandr-dev \
            libxfixes-dev libxcursor-dev libxinerama-dev libxcomposite-dev \
            libxdamage-dev libxxf86vm-dev libxt-dev libxmu-dev libxtst-dev
          
          # Install Vulkan development packages if available
          apt install -y vulkan-utils || echo "Vulkan not available, continuing..."
          apt install -y libvulkan1 || echo "libvulkan1 not available, continuing..."
          
          # Install CAPI development packages if available
          apt install -y libcapi20-3 libcapi20-dev || echo "CAPI packages not available, continuing..."
          
          # Install newer GCC if available
          apt install -y gcc-9 g++-9 gcc-10 g++-10 || echo "Newer GCC versions not available, installing default"
          apt install -y gcc g++
          
          # Install cross-compilers
          apt install -y gcc-mingw-w64-i686 g++-mingw-w64-i686
          update-alternatives --set i686-w64-mingw32-gcc /usr/bin/i686-w64-mingw32-gcc-posix
          update-alternatives --set i686-w64-mingw32-g++ /usr/bin/i686-w64-mingw32-g++-posix
          EOL
      
      - name: Create symbolic links for cross-compilers
        run: |
          sudo mkdir -p /opt/mingw/x86_64/bin
          sudo mkdir -p /opt/mingw/i686/bin
          
          # Create symlinks for 64-bit cross-compilers
          if [ -f "/usr/bin/x86_64-w64-mingw32-gcc" ]; then
            sudo ln -sf /usr/bin/x86_64-w64-mingw32-gcc /opt/mingw/x86_64/bin/
            sudo ln -sf /usr/bin/x86_64-w64-mingw32-g++ /opt/mingw/x86_64/bin/
          fi
          
          # Create symlinks for 32-bit cross-compilers
          if [ -f "/usr/bin/i686-w64-mingw32-gcc" ]; then
            sudo ln -sf /usr/bin/i686-w64-mingw32-gcc /opt/mingw/i686/bin/
            sudo ln -sf /usr/bin/i686-w64-mingw32-g++ /opt/mingw/i686/bin/
          fi
      
      - name: Install additional tools in host system
        run: |
          sudo apt update
          sudo apt install -y bubblewrap ccache
      
      - name: Clean up bootstraps
        run: |
          sudo chroot /opt/chroots/bionic64_chroot /bin/bash -c "apt clean && rm -rf /var/lib/apt/lists/*"
          sudo chroot /opt/chroots/bionic32_chroot /bin/bash -c "apt clean && rm -rf /var/lib/apt/lists/*"
      
      - name: Compress bootstraps
        run: |
          cd /opt
          sudo tar -cJpf bootstraps.tar.xz chroots/
          sudo chmod 644 bootstraps.tar.xz
          ls -lh /opt/bootstraps.tar.xz
      
      - name: Upload bootstraps artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bootstraps
          path: /opt/bootstraps.tar.xz
          retention-days: 30
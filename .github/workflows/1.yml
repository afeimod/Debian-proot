name: Build Python3 with Obfuscation and Release

on:
  push:
    tags:
      - 'v*'  # 当推送v开头的标签时触发
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # 根据你的项目调整Python版本
        architecture: 'arm64'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev zlib1g-dev \
        libbz2-dev libreadline-dev libsqlite3-dev curl \
        libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev \
        libffi-dev liblzma-dev python3-opencv \
        python3-full python3-dev python3-pip \
        python3-lib2to3  # 添加 2to3 支持
        
    - name: Install pyminifier and dependencies
      run: |
        python -m pip install --upgrade pip
        # 先安装必要的依赖
        pip install setuptools wheel
        # 尝试安装修复版本的pyminifier，或者使用替代方案
        pip install pyminifier --no-build-isolation || \
        (echo "使用替代方法安装pyminifier..." && \
         pip install --no-deps pyminifier && \
         pip install setuptools)
        
    - name: Alternative pyminifier installation
      if: failure()
      run: |
        # 如果上述安装失败，尝试从GitHub安装
        echo "尝试从GitHub安装pyminifier..."
        pip install git+https://github.com/liftoff/pyminifier.git
        
    - name: Use pyarmor as alternative
      if: failure()
      run: |
        # 如果pyminifier仍然失败，使用pyarmor作为替代
        echo "使用pyarmor作为替代混淆工具..."
        pip install pyarmor
        
    - name: Verify installation
      run: |
        # 检查是否安装了任一混淆工具
        python -c "
        try:
            import pyminifier
            print('✓ pyminifier 可用，版本:', pyminifier.__version__)
        except ImportError:
            try:
                import pyarmor
                print('✓ pyarmor 可用，版本:', pyarmor.__version__)
            except ImportError:
                print('✗ 未安装任何混淆工具')
                exit(1)
        "
        
    - name: Find all Python files
      id: find_python_files
      run: |
        # 查找所有的Python文件
        find . -name "*.py" -type f | grep -v __pycache__ > python_files.txt
        echo "找到的Python文件:"
        cat python_files.txt
        echo "TOTAL_FILES=$(wc -l < python_files.txt)" >> $GITHUB_OUTPUT
        
    - name: Create obfuscated directory structure
      run: |
        # 创建混淆输出目录
        mkdir -p obfuscated_dist
        # 复制原始目录结构
        find . -name "*.py" -type f | while read file; do
          dir=$(dirname "$file")
          mkdir -p "obfuscated_dist/$dir"
        done
        
    - name: Obfuscate Python files
      id: obfuscate_files
      run: |
        # 根据可用的工具选择混淆方法
        if python -c "import pyminifier" 2>/dev/null; then
          echo "使用 pyminifier 进行混淆"
          OBFUSCATION_TOOL="pyminifier"
        elif python -c "import pyarmor" 2>/dev/null; then
          echo "使用 pyarmor 进行混淆"
          OBFUSCATION_TOOL="pyarmor"
        else
          echo "错误: 未找到可用的混淆工具"
          exit 1
        fi
        
        # 使用选择的工具进行混淆
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            echo "混淆文件: $file"
            rel_path="${file#./}"
            output_file="obfuscated_dist/$rel_path"
            
            if [ "$OBFUSCATION_TOOL" = "pyminifier" ]; then
              # 使用pyminifier进行混淆
              pyminifier --obfuscate "$file" > "$output_file" 2>/dev/null || {
                echo "pyminifier 混淆失败，使用原始文件"
                cp "$file" "$output_file"
              }
            else
              # 使用pyarmor进行混淆
              pyarmor obfuscate -O "temp_obfuscated" --recursive "$file" >/dev/null 2>&1 || {
                echo "pyarmor 混淆失败，使用原始文件"
                cp "$file" "$output_file"
              }
              # 复制混淆后的文件
              find "temp_obfuscated" -name "*.py" -exec cp {} "obfuscated_dist/" \; 2>/dev/null || true
              rm -rf "temp_obfuscated"
            fi
            
            # 检查混淆是否成功
            if [ -s "$output_file" ]; then
              echo "✓ 成功处理: $file"
              original_lines=$(wc -l < "$file" 2>/dev/null || echo "0")
              obfuscated_lines=$(wc -l < "$output_file" 2>/dev/null || echo "0")
              echo "  行数变化: $original_lines -> $obfuscated_lines"
            else
              echo "✗ 处理失败: $file，使用原始文件"
              cp "$file" "$output_file"
            fi
          fi
        done < python_files.txt
        
    # 其余步骤保持不变...
    - name: Test obfuscated code syntax
      run: |
        # 测试混淆后的代码语法是否正确
        cd obfuscated_dist
        echo "测试混淆后代码的语法..."
        find . -name "*.py" -type f | while read file; do
          if python -m py_compile "$file" 2>/dev/null; then
            echo "✓ 语法正确: $file"
          else
            echo "✗ 语法错误: $file"
            # 显示具体错误
            python -m py_compile "$file" || true
          fi
        done
        
    - name: Create obfuscated distribution package
      run: |
        # 创建混淆代码的发布包
        OBFS_PACKAGE="obfuscated_package_${{ github.sha }}"
        mkdir -p "$OBFS_PACKAGE"
        
        # 复制混淆后的代码
        cp -r obfuscated_dist/* "$OBFS_PACKAGE/" 2>/dev/null || true
        
        # 打包混淆后的代码
        tar -czf "obfuscated_release.tar.gz" "$OBFS_PACKAGE"
        echo "创建混淆发布包: obfuscated_release.tar.gz"
        du -h obfuscated_release.tar.gz
        
    - name: Upload obfuscated artifacts
      uses: actions/upload-artifact@v4
      with:
        name: obfuscated-python-code
        path: |
          obfuscated_release.tar.gz
          obfuscated_dist/
        retention-days: 1
        
    - name: Create Release with Obfuscated Code
      id: create_release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: "Obfuscated Release ${{ github.ref }}"
        draft: false
        prerelease: false
        files: |
          obfuscated_release.tar.gz
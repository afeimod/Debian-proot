name: Build Python3 with Obfuscation and Release

on:
  push:
    tags:
      - 'v*'  # 当推送v开头的标签时触发
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # 根据你的项目调整Python版本
        architecture: 'arm64'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libssl-dev zlib1g-dev \
        libbz2-dev libreadline-dev libsqlite3-dev curl \
        libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev \
        libffi-dev liblzma-dev python3-opencv \
        python3.11-full python3.11-dev  # 确保安装完整的Python 3.11包含2to3
        
    - name: Install pyminifier and dependencies
      run: |
        python -m pip install --upgrade pip
        # 先安装必要的依赖
        pip install setuptools wheel
        # 安装修复版本的pyminifier
        pip install --no-build-isolation pyminifier
        # 或者使用替代方案安装
        pip install opencv-python
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        
    - name: Verify pyminifier installation
      run: |
        python -c "import pyminifier; print('pyminifier版本:', pyminifier.__version__)"
        which pyminifier
        pyminifier --help
        
    - name: Find all Python files
      id: find_python_files
      run: |
        # 查找所有的Python文件
        find . -name "*.py" -type f | grep -v __pycache__ > python_files.txt
        echo "找到的Python文件:"
        cat python_files.txt
        echo "TOTAL_FILES=$(wc -l < python_files.txt)" >> $GITHUB_OUTPUT
        
    - name: Create obfuscated directory structure
      run: |
        # 创建混淆输出目录
        mkdir -p obfuscated_dist
        # 复制原始目录结构
        find . -name "*.py" -type f | while read file; do
          dir=$(dirname "$file")
          mkdir -p "obfuscated_dist/$dir"
        done
        
    - name: Obfuscate Python files with pyminifier
      run: |
        # 使用pyminifier混淆所有Python文件
        while IFS= read -r file; do
          if [ -f "$file" ]; then
            echo "混淆文件: $file"
            rel_path="${file#./}"
            output_file="obfuscated_dist/$rel_path"
            
            # 使用pyminifier进行混淆 - 简化选项避免兼容性问题
            pyminifier --obfuscate "$file" > "$output_file"
            
            # 检查混淆是否成功
            if [ $? -eq 0 ] && [ -s "$output_file" ]; then
              echo "✓ 成功混淆: $file -> $output_file"
              # 显示混淆前后的差异
              original_lines=$(wc -l < "$file")
              obfuscated_lines=$(wc -l < "$output_file")
              echo "  行数变化: $original_lines -> $obfuscated_lines"
            else
              echo "✗ 混淆失败: $file，使用原始文件"
              # 如果混淆失败，复制原始文件
              cp "$file" "$output_file"
            fi
          fi
        done < python_files.txt
        
    - name: Test obfuscated code syntax
      run: |
        # 测试混淆后的代码语法是否正确
        cd obfuscated_dist
        echo "测试混淆后代码的语法..."
        find . -name "*.py" -type f | while read file; do
          if python -m py_compile "$file" 2>/dev/null; then
            echo "✓ 语法正确: $file"
          else
            echo "✗ 语法错误: $file"
            # 显示具体错误
            python -m py_compile "$file"
          fi
        done
        
    - name: Find main Python file in obfuscated code
      id: find_obfuscated_main
      run: |
        # 在混淆后的代码中查找主文件
        OBFS_DIR="obfuscated_dist"
        if [ -f "$OBFS_DIR/main.py" ]; then
          echo "MAIN_FILE=main.py" >> $GITHUB_OUTPUT
          echo "MAIN_FILE_PATH=$OBFS_DIR/main.py" >> $GITHUB_OUTPUT
        elif [ -f "$OBFS_DIR/app.py" ]; then
          echo "MAIN_FILE=app.py" >> $GITHUB_OUTPUT
          echo "MAIN_FILE_PATH=$OBFS_DIR/app.py" >> $GITHUB_OUTPUT
        else
          # 查找包含if __name__ == '__main__'的Python文件
          MAIN_FILE=$(find "$OBFS_DIR" -name "*.py" -type f -exec grep -l "if __name__ == '__main__'" {} \; | head -1)
          if [ -n "$MAIN_FILE" ]; then
            MAIN_FILE_REL=${MAIN_FILE#$OBFS_DIR/}
            echo "MAIN_FILE=$MAIN_FILE_REL" >> $GITHUB_OUTPUT
            echo "MAIN_FILE_PATH=$MAIN_FILE" >> $GITHUB_OUTPUT
          else
            echo "在混淆代码中未找到主Python文件"
            # 使用第一个找到的Python文件作为备选
            FIRST_FILE=$(find "$OBFS_DIR" -name "*.py" -type f | head -1)
            if [ -n "$FIRST_FILE" ]; then
              FIRST_FILE_REL=${FIRST_FILE#$OBFS_DIR/}
              echo "MAIN_FILE=$FIRST_FILE_REL" >> $GITHUB_OUTPUT
              echo "MAIN_FILE_PATH=$FIRST_FILE" >> $GITHUB_OUTPUT
              echo "使用第一个找到的文件作为主文件: $FIRST_FILE_REL"
            else
              echo "错误: 未找到任何Python文件"
              exit 1
            fi
          fi
        fi
        echo "混淆后的主文件: ${{ steps.find_obfuscated_main.outputs.MAIN_FILE }}"
        echo "完整路径: ${{ steps.find_obfuscated_main.outputs.MAIN_FILE_PATH }}"
        
    - name: Create obfuscated distribution package
      run: |
        # 创建混淆代码的发布包
        OBFS_PACKAGE="obfuscated_package_${{ github.sha }}"
        mkdir -p "$OBFS_PACKAGE"
        
        # 复制混淆后的代码
        cp -r obfuscated_dist/* "$OBFS_PACKAGE/" 2>/dev/null || true
        
        
        
        
        
        # 打包混淆后的代码
        tar -czf "obfuscated_release.tar.gz" "$OBFS_PACKAGE"
        echo "创建混淆发布包: obfuscated_release.tar.gz"
        du -h obfuscated_release.tar.gz
        
    - name: Show obfuscation results
      run: |
        echo "=== 混淆结果示例 ==="
        echo "原始文件示例:"
        find . -name "*.py" -type f | head -1 | xargs head -10
        echo ""
        echo "混淆后文件示例:"
        find obfuscated_dist -name "*.py" -type f | head -1 | xargs head -10
        
    - name: Upload obfuscated artifacts
      uses: actions/upload-artifact@v4
      with:
        name: obfuscated-python-code
        path: |
          obfuscated_release.tar.gz
          obfuscated_dist/
        retention-days: 1
        
    - name: Create Release with Obfuscated Code
      id: create_release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: "Obfuscated Release ${{ github.ref }}"
        draft: false
        prerelease: false
        files: |
          obfuscated_release.tar.gz
name: Build MangoHud (aarch64)

on:
  workflow_dispatch:
    inputs:
      version_ref:
        description: 'ç‰ˆæœ¬å·/æ ‡ç­¾/æäº¤å“ˆå¸Œ (ä¾‹å¦‚: v0.7.0, master, æˆ– commit hash)'
        required: true
        default: 'master'
        type: string

permissions:
  contents: write

env:
  REPO_URL: https://github.com/flightlessmango/MangoHud.git

jobs:
  build: 
    runs-on: ubuntu-24.04-arm

    steps:
      # ğŸ§© æ£€å‡ºå½“å‰ä»“åº“
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      # ğŸ§­ å…‹éš†æŒ‡å®šç‰ˆæœ¬çš„ MangoHud æºç 
      - name: Clone MangoHud source
        run: |
          git clone --depth=1 --branch ${{ inputs.version_ref }} $REPO_URL MangoHud || \
          git clone --depth=1 $REPO_URL MangoHud
          cd MangoHud
          git checkout ${{ inputs.version_ref }} || echo "ä½¿ç”¨é»˜è®¤åˆ†æ”¯"

      # ğŸ”– è·å–æºç ç‰ˆæœ¬ä¿¡æ¯
      - name: è·å–æºç ç‰ˆæœ¬ä¿¡æ¯
        id: get_version
        run: |
          cd MangoHud
          # å°è¯•è·å–æ ‡ç­¾
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            VERSION=$(git describe --tags --abbrev=0)
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          
          AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "COMMIT=$COMMIT" >> $GITHUB_ENV
          echo "COMMIT_SHORT=$COMMIT_SHORT" >> $GITHUB_ENV
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "BUILD_TIME=$DATE" >> $GITHUB_ENV
          echo "INPUT_VERSION=${{ inputs.version_ref }}" >> $GITHUB_ENV
          
          echo "âœ… æ„å»ºä¿¡æ¯:"
          echo "ğŸ“¦ ç‰ˆæœ¬: $VERSION"
          echo "ğŸŒ¿ åˆ†æ”¯/æ ‡ç­¾: $BRANCH"
          echo "ğŸ”– æäº¤: $COMMIT_SHORT"
          echo "ğŸ‘¤ ä½œè€…: $AUTHOR"
          echo "ğŸ¯ è¾“å…¥ç‰ˆæœ¬: ${{ inputs.version_ref }}"
          echo "ğŸ•“ æ„å»ºæ—¶é—´: $DATE"

      - name: ä¿®å¤ä¾èµ–
        run: |
          sudo apt clean
          sudo apt autoclean
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt update
          sudo rm /var/lib/apt/lists/lock
          sudo rm /var/cache/apt/archives/lock

      # ğŸ“¦ å®‰è£…ä¾èµ–
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential glslang-tools python3-pip git \
            pkg-config meson libdbus-1-dev libx11-dev \
            libxext-dev libxrandr-dev libxinerama-dev \
            libxdamage-dev libxfixes-dev libdrm-dev \
            libgl1-mesa-dev libwayland-dev libxkbcommon-dev patchelf

      # ğŸ› ï¸ å‡çº§ Meson/Ninja
      - name: å‡çº§ Meson å’Œ Ninja
        run: |
          pip install --upgrade pip
          pip install --upgrade meson ninja mako
          meson --version
          ninja --version

      # âš™ï¸ åº”ç”¨ Termux æ—  root CPU é¢‘ç‡è¡¥ä¸
      - name: åº”ç”¨ Termux æ—  root CPU é¢‘ç‡è¡¥ä¸
        run: |
          cd MangoHud
          SRC_FILE="src/sysinfo/linux.cpp"
          if [ -f "$SRC_FILE" ]; then
            echo "ğŸ”§ åº”ç”¨ CPU é¢‘ç‡æ£€æµ‹ä¿®è¡¥..."
            cp "$SRC_FILE" "${SRC_FILE}.bak"
            awk '
            BEGIN {in_func=0}
            /^int get_cpu_freq\(int core\)/ {print; in_func=1; next}
            in_func && /^\{/ {print; print "    int freq = 0; std::string path;"; next}
            in_func && /return freq;/ {
                print "    // å°è¯• scaling_cur_freq"
                print "    path = \"/sys/devices/system/cpu/cpu\" + std::to_string(core) + \"/cpufreq/scaling_cur_freq\";"
                print "    { std::ifstream f(path); if(f.is_open()){ f >> freq; if(freq>0) return freq/1000; } }"
                print ""
                print "    // å°è¯• cpuinfo_cur_freq"
                print "    path = \"/sys/devices/system/cpu/cpu\" + std::to_string(core) + \"/cpufreq/cpuinfo_cur_freq\";"
                print "    { std::ifstream f(path); if(f.is_open()){ f >> freq; if(freq>0) return freq/1000; } }"
                print ""
                print "    // ä» /proc/cpuinfo è¯»å– (é root fallback)"
                print "    {"
                print "        std::ifstream cpuinfo(\"/proc/cpuinfo\");"
                print "        if(cpuinfo.is_open()){"
                print "            std::string line; int index=-1;"
                print "            while(std::getline(cpuinfo,line)){"
                print "                if(line.find(\"processor\")!=std::string::npos) index++;"
                print "                if(index==core && line.find(\"cpu MHz\")!=std::string::npos){"
                print "                    size_t pos=line.find(\":\");"
                print "                    if(pos!=std::string::npos){"
                print "                        std::istringstream iss(line.substr(pos+1));"
                print "                        iss >> freq; if(freq>0) return (int)freq;"
                print "                    }"
                print "                }"
                print "            }"
                print "        }"
                print "    }"
                print ""
                print "    // fallback é»˜è®¤å€¼"
                print "    return 2000;"
                in_func=0; next
            }
            {print}
            ' "${SRC_FILE}.bak" > "$SRC_FILE"
            echo "âœ… CPU é¢‘ç‡æ£€æµ‹è¡¥ä¸åº”ç”¨æˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° $SRC_FILE"
          fi

      - name: åº”ç”¨è·³è¿‡ /sys/class/drm è®¿é—®è¡¥ä¸
        run: |
          cd MangoHud
          echo "ğŸ”§ æŸ¥æ‰¾å¹¶ä¿®è¡¥ /sys/class/drm è®¿é—®..."
          
          # æ–¹æ³•1ï¼šæŸ¥æ‰¾å¹¶ä¿®æ”¹ä½¿ç”¨ ghc::filesystem::directory_iterator è®¿é—® /sys/class/drm çš„ä»£ç 
          find src -type f \( -name "*.cpp" -o -name "*.hpp" \) | while read file; do
            if grep -n "ghc::filesystem::directory_iterator" "$file" | grep -q "/sys/class/drm"; then
              echo "ğŸ” æ‰¾åˆ°éœ€è¦ä¿®è¡¥çš„æ–‡ä»¶: $file"
              
              # å¤‡ä»½åŸæ–‡ä»¶
              cp "$file" "${file}.bak"
              
              # ä½¿ç”¨ sed è¿›è¡Œæ›´ç²¾ç¡®çš„ä¿®æ”¹
              sed -i '
              /ghc::filesystem::directory_iterator.*\/sys\/class\/drm/ {
                # åœ¨åŒ¹é…è¡Œå‰æ·»åŠ  try-catch å—
                i\    try {
                # å½“å‰è¡Œ
                b line
                :line
                a\    } catch (const ghc::filesystem::filesystem_error& e) {
                a\        // è·³è¿‡ /sys/class/drm è®¿é—®ï¼Œæ— æƒé™
                a\        return {};
                a\    }
              }
              ' "$file"
              
              echo "âœ… $file å·²æ·»åŠ  try-catch å—"
            fi
          done
          
          # æ–¹æ³•2ï¼šç›´æ¥ä¿®æ”¹ gpu.cppï¼ˆè¿™æ˜¯æœ€å¯èƒ½è®¿é—® DRM çš„æ–‡ä»¶ï¼‰
          GPU_FILE="src/gpu.cpp"
          if [ -f "$GPU_FILE" ]; then
            echo "ğŸ”§ ç›´æ¥ä¿®è¡¥ $GPU_FILE..."
            cp "$GPU_FILE" "${GPU_FILE}.bak"
            
            # åœ¨éå† /sys/class/drm çš„å¾ªç¯å‰æ·»åŠ  try-catch
            awk '
            /for.*directory_iterator.*\/sys\/class\/drm/ || /directory_iterator.*drm.*\{/ {
                print "    try {"
                print
                next
            }
            /for \(auto.*drm.*:/ {
                print "    try {"
                print
                next
            }
            /^\s*for.*drm.*:.*directory_iterator/ {
                print "    try {"
                print
                next
            }
            {
                print
            }
            ' "${GPU_FILE}.bak" > "${GPU_FILE}.tmp"
            
            # åœ¨é€‚å½“çš„ä½ç½®æ·»åŠ  catch å—
            awk '
            /^\s*for \(auto.*drm.*:.*directory_iterator/ {
                in_drm_loop=1
                print
                next
            }
            in_drm_loop && /^\s*\{/ {
                brace_count++
                print
                next
            }
            in_drm_loop && /^\s*\}/ {
                brace_count--
                if (brace_count == 0) {
                    print "    } catch (const ghc::filesystem::filesystem_error& e) {"
                    print "        // è·³è¿‡ /sys/class/drm è®¿é—®ï¼Œæ— æƒé™"
                    print "        return {};"
                    print "    }"
                    in_drm_loop=0
                }
                print
                next
            }
            {
                print
            }
            ' "${GPU_FILE}.tmp" > "$GPU_FILE"
            
            rm "${GPU_FILE}.tmp"
            echo "âœ… $GPU_FILE å·²ä¿®è¡¥"
          fi
          

      # ğŸ—ï¸ æ„å»º MangoHud
      - name: æ„å»º MangoHud (Termux)
        run: |
          cd MangoHud
          sudo mkdir -p /opt/mesa
          sudo chmod -R 777 /opt
          meson setup build \
            --prefix=/opt/mesa \
            --libdir=lib \
            -Dbuildtype=release \
            -Dwith_x11=enabled \
            -Dwith_wayland=enabled \
            -Dwith_xnvctrl=disabled \
            -Dwith_dbus=enabled \
            -Dmangoplot=enabled \
            -Dmangoapp=false \
            -Dmangohudctl=false \
            -Dtests=disabled
          ninja -C build -j$(nproc)
          ninja -C build install

      # ğŸ”§ ä¿®æ­£ $LIB å˜é‡
      - name: ä¿®æ­£ MangoHud å¯åŠ¨è„šæœ¬
        run: |
          ROOT=/opt/mesa
          if [ -f "$ROOT/bin/mangohud" ]; then
            sed -i 's|/\\$LIB|/lib|g' "$ROOT/bin/mangohud"
          fi

      # ğŸ§± ä¿®è¡¥ ELF è§£é‡Šå™¨
      - name: ä¿®è¡¥ ELF å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          ROOT=/opt/mesa
          INTERP=$ROOT/lib/ld-linux-aarch64.so.1
          for dir in "$ROOT/bin" "$ROOT/lib"; do
            [ -d "$dir" ] || continue
            for f in "$dir"/*; do
              if file "$f" | grep -q 'ELF'; then
                patchelf --set-interpreter "$INTERP" "$f" || true
              fi
            done
          done

      # ğŸ“¦ æ‰“åŒ…ç»“æœ
      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          cd /opt
          TAR_NAME="termux-mangohud-${{ env.VERSION }}-aarch64.tar.gz"
          tar -czvf /home/runner/$TAR_NAME mesa
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV
          echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ: $TAR_NAME"

      # â˜ï¸ ä¸Šä¼ äº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: /home/runner/${{ env.TAR_NAME }}

      # ğŸš€ å‘å¸ƒ Release
      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ env.VERSION }}-${{ env.COMMIT_SHORT }}
          name: MangoHud ${{ env.VERSION }} (aarch64)
          body: |
            ## MangoHud ${{ env.VERSION }} for Termux (aarch64)

            ### ğŸ“‹ æ„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬å·**: `${{ env.VERSION }}`
            - **æ„å»ºæ¥æº**: `${{ env.INPUT_VERSION }}`
            - **åˆ†æ”¯/æ ‡ç­¾**: `${{ env.BRANCH }}`
            - **æ¶æ„**: aarch64
            - **ç¯å¢ƒ**: Termux
            - **ä½œè€…**: `${{ env.AUTHOR }}`
            - **æäº¤**: `${{ env.COMMIT_SHORT }}`
            - **å®Œæ•´æäº¤**: `${{ env.COMMIT }}`
            - **æ„å»ºæ—¶é—´**: `${{ env.BUILD_TIME }}`

            ### ğŸ“¦ æ–‡ä»¶ä¿¡æ¯
            - **æ–‡ä»¶å**: `${{ env.TAR_NAME }}`
            - **åŒ…å«**: å®Œæ•´çš„ MangoHud å®‰è£…æ–‡ä»¶

            ### ğŸ› ï¸ æ„å»ºç‰¹æ€§
            - âœ… æ”¯æŒ X11
            - âœ… æ”¯æŒ Wayland
            - âœ… æ”¯æŒ DBus
            - âœ… å¯ç”¨ MangoPlot
            - âœ… Termux æ—  root CPU é¢‘ç‡æ£€æµ‹è¡¥ä¸
            - âŒ ç¦ç”¨ XNVCtrl (NVIDIA GPU ç»Ÿè®¡)
            - âŒ ç¦ç”¨ MangoApp
            - âŒ ç¦ç”¨ MangoHudctl

            ### ğŸ“¥ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½å¹¶è§£å‹åˆ° Termux çš„ `/opt/mesa` ç›®å½•
            2. è¿è¡Œ `mangohud` å‘½ä»¤ä½¿ç”¨

            ### ğŸ”§ æ‰‹åŠ¨æ„å»ºå‚æ•°
            - **è¯·æ±‚ç‰ˆæœ¬**: `${{ inputs.version_ref }}`
            - **è§¦å‘æ—¶é—´**: `${{ github.event.workflow_dispatch.inputs.triggered_at }}`
          files: /home/runner/${{ env.TAR_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
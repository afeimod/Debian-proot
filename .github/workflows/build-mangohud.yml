name: Build MangoHud (aarch64, Termux glibc)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *'  # æ¯å¤©æ—©ä¸Š6ç‚¹è‡ªåŠ¨æ£€æŸ¥æ›´æ–°æž„å»º

permissions:
  contents: write

env:
  REPO_URL: https://github.com/flightlessmango/MangoHud.git
  LAST_COMMIT_FILE: last_mangohud_commit.txt

jobs:
  build: 
    runs-on: ubuntu-24.04-arm

    steps:
      # ðŸ§© æ£€å‡ºå½“å‰ä»“åº“ï¼ˆç”¨äºŽå­˜æ”¾è®°å½•æ–‡ä»¶ï¼‰
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      # ðŸ” èŽ·å–ä¸Šæ¬¡æž„å»ºçš„æäº¤å“ˆå¸Œ
      - name: Get last built commit
        id: get_last_commit
        run: |
          if [ -f "$LAST_COMMIT_FILE" ]; then
            echo "LAST_COMMIT=$(cat $LAST_COMMIT_FILE)" >> $GITHUB_ENV
          else
            echo "LAST_COMMIT=none" >> $GITHUB_ENV
          fi

      # ðŸ”Ž æ£€æŸ¥ä¸Šæ¸¸æºç çš„æœ€æ–°æäº¤
      - name: Check upstream latest commit
        id: check_upstream
        run: |
          LATEST_COMMIT=$(git ls-remote $REPO_URL HEAD | awk '{print $1}')
          echo "LATEST_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
          echo "æœ€æ–°æºç æäº¤: $LATEST_COMMIT"

          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ]; then
            echo "ðŸ”¸ æºç æœªæ›´æ–°ï¼Œè·³è¿‡æž„å»ºã€‚"
            echo "skip_build=true" >> $GITHUB_ENV
          else
            echo "âœ… æ£€æµ‹åˆ°æ–°æäº¤ï¼Œå°†è¿›è¡Œæž„å»ºã€‚"
            echo "skip_build=false" >> $GITHUB_ENV
          fi

      # ðŸ›‘ å¦‚æžœæ²¡æœ‰æ–°æäº¤åˆ™è·³è¿‡åŽç»­æ­¥éª¤
      - name: Stop if no new commit
        if: env.skip_build == 'true'
        run: |
          echo "æ²¡æœ‰æ–°æäº¤ï¼Œç»ˆæ­¢ workflowã€‚"
          exit 0

      # ðŸ§­ å…‹éš† MangoHud æºç 
      - name: Clone MangoHud source
        run: |
          git clone --depth=1 $REPO_URL MangoHud

      # ðŸ”– èŽ·å–æºç ç‰ˆæœ¬å·
      - name: èŽ·å–æºç ç‰ˆæœ¬å·
        id: get_version
        run: |
          cd MangoHud
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            VERSION=$(git describe --tags --abbrev=0)
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT=$(git rev-parse HEAD)
          DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "COMMIT=$COMMIT" >> $GITHUB_ENV
          echo "BUILD_TIME=$DATE" >> $GITHUB_ENV
          echo "âœ… ç‰ˆæœ¬: $VERSION"
          echo "ðŸ‘¤ ä½œè€…: $AUTHOR"
          echo "ðŸ”– æäº¤: $COMMIT"
          echo "ðŸ•“ æ—¶é—´: $DATE"

      # ðŸ“¦ å®‰è£…ä¾èµ–
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential glslang-tools python3-pip git \
            pkg-config meson libdbus-1-dev libx11-dev \
            libxext-dev libxrandr-dev libxinerama-dev \
            libxdamage-dev libxfixes-dev libdrm-dev \
            libgl1-mesa-dev libwayland-dev libxkbcommon-dev patchelf

      # ðŸ› ï¸ å‡çº§ Meson/Ninja
      - name: å‡çº§ Meson å’Œ Ninja
        run: |
          pip install --upgrade pip
          pip install --upgrade meson ninja mako
          meson --version
          ninja --version

      # âš™ï¸ åº”ç”¨ Termux æ—  root CPU é¢‘çŽ‡è¡¥ä¸
      - name: åº”ç”¨ Termux æ—  root CPU é¢‘çŽ‡è¡¥ä¸
        run: |
          cd MangoHud
          SRC_FILE="src/sysinfo/linux.cpp"
          if [ -f "$SRC_FILE" ]; then
            echo "ðŸ”§ åº”ç”¨ CPU é¢‘çŽ‡æ£€æµ‹ä¿®è¡¥..."
            cp "$SRC_FILE" "${SRC_FILE}.bak"
            awk '
            BEGIN {in_func=0}
            /^int get_cpu_freq\(int core\)/ {print; in_func=1; next}
            in_func && /^\{/ {print; print "    int freq = 0; std::string path;"; next}
            in_func && /return freq;/ {
                print "    // å°è¯• scaling_cur_freq"
                print "    path = \"/sys/devices/system/cpu/cpu\" + std::to_string(core) + \"/cpufreq/scaling_cur_freq\";"
                print "    { std::ifstream f(path); if(f.is_open()){ f >> freq; if(freq>0) return freq/1000; } }"
                print ""
                print "    // å°è¯• cpuinfo_cur_freq"
                print "    path = \"/sys/devices/system/cpu/cpu\" + std::to_string(core) + \"/cpufreq/cpuinfo_cur_freq\";"
                print "    { std::ifstream f(path); if(f.is_open()){ f >> freq; if(freq>0) return freq/1000; } }"
                print ""
                print "    // ä»Ž /proc/cpuinfo è¯»å– (éž root fallback)"
                print "    {"
                print "        std::ifstream cpuinfo(\"/proc/cpuinfo\");"
                print "        if(cpuinfo.is_open()){"
                print "            std::string line; int index=-1;"
                print "            while(std::getline(cpuinfo,line)){"
                print "                if(line.find(\"processor\")!=std::string::npos) index++;"
                print "                if(index==core && line.find(\"cpu MHz\")!=std::string::npos){"
                print "                    size_t pos=line.find(\":\");"
                print "                    if(pos!=std::string::npos){"
                print "                        std::istringstream iss(line.substr(pos+1));"
                print "                        iss >> freq; if(freq>0) return (int)freq;"
                print "                    }"
                print "                }"
                print "            }"
                print "        }"
                print "    }"
                print ""
                print "    // fallback é»˜è®¤å€¼"
                print "    return 2000;"
                in_func=0; next
            }
            {print}
            ' "${SRC_FILE}.bak" > "$SRC_FILE"
            echo "âœ… CPU é¢‘çŽ‡æ£€æµ‹è¡¥ä¸åº”ç”¨æˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° $SRC_FILE"
          fi

      # ðŸ—ï¸ æž„å»º MangoHud
      - name: æž„å»º MangoHud (Termux glibc)
        run: |
          cd MangoHud
          sudo mkdir -p /usr
          sudo chmod -R 777 /usr
          meson setup build \
            --prefix=/usr \
            --libdir=lib \
            -Dbuildtype=release \
            -Dwith_x11=enabled \
            -Dwith_wayland=enabled \
            -Dwith_xnvctrl=disabled \
            -Dwith_dbus=enabled \
            -Dmangoplot=enabled \
            -Dmangoapp=false \
            -Dmangohudctl=false \
            -Dtests=disabled
          ninja -C build -j$(nproc)
          ninja -C build install

      # ðŸ”§ ä¿®æ­£ $LIB å˜é‡
      - name: ä¿®æ­£ MangoHud å¯åŠ¨è„šæœ¬
        run: |
          ROOT=/usr
          if [ -f "$ROOT/bin/mangohud" ]; then
            sed -i 's|/\\$LIB|/lib|g' "$ROOT/bin/mangohud"
          fi

      # ðŸ§± ä¿®è¡¥ ELF è§£é‡Šå™¨
      - name: ä¿®è¡¥ ELF å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          ROOT=/usr
          INTERP=$ROOT/lib/ld-linux-aarch64.so.1
          for dir in "$ROOT/bin" "$ROOT/lib"; do
            [ -d "$dir" ] || continue
            for f in "$dir"/*; do
              if file "$f" | grep -q 'ELF'; then
                patchelf --set-interpreter "$INTERP" "$f" || true
              fi
            done
          done

      # ðŸ“¦ æ‰“åŒ…ç»“æžœ
      - name: æ‰“åŒ…æž„å»ºäº§ç‰©
        run: |
          cd /usr
          TAR_NAME="termux-glibc-mangohud-${{ env.VERSION }}-aarch64.tar.gz"
          tar -czvf /home/runner/$TAR_NAME glibc
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV
          echo "ðŸ“¦ æ‰“åŒ…å®Œæˆ: $TAR_NAME"

      # â˜ï¸ ä¸Šä¼ äº§ç‰©
      - name: ä¸Šä¼ æž„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: /home/runner/${{ env.TAR_NAME }}

      # ðŸš€ å‘å¸ƒ Release
      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: MangoHud ${{ env.VERSION }} (aarch64)
          body: |
            ## MangoHud ${{ env.VERSION }} for Termux (aarch64 glibc)

            ### ðŸ“‹ æž„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬å·**: `${{ env.VERSION }}`
            - **æž¶æž„**: aarch64
            - **ä½œè€…**: `${{ env.AUTHOR }}`
            - **æäº¤**: `${{ env.COMMIT }}`
            - **æž„å»ºæ—¶é—´**: `${{ env.BUILD_TIME }}`

            ### ðŸ“¦ æ–‡ä»¶ä¿¡æ¯
            - **æ–‡ä»¶å**: `${{ env.TAR_NAME }}`
            - **åŒ…å«**: å®Œæ•´çš„ MangoHud å®‰è£…æ–‡ä»¶

            ### ðŸ› ï¸ æž„å»ºç‰¹æ€§
            - âœ… æ”¯æŒ X11
            - âœ… æ”¯æŒ Wayland
            - âœ… æ”¯æŒ DBus
            - âœ… å¯ç”¨ MangoPlot
            - âœ… Termux æ—  root CPU é¢‘çŽ‡æ£€æµ‹è¡¥ä¸
            - âŒ ç¦ç”¨ XNVCtrl (NVIDIA GPU ç»Ÿè®¡)
            - âŒ ç¦ç”¨ MangoApp
            - âŒ ç¦ç”¨ MangoHudctl

            
          files: /home/runner/${{ env.TAR_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ðŸ’¾ ä¿å­˜æœ€æ–°æž„å»ºçš„æäº¤å“ˆå¸Œ
      - name: Save last commit hash
        run: echo "$LATEST_COMMIT" > $LAST_COMMIT_FILE

      # ðŸ“¤ ä¸Šä¼ è®°å½•æ–‡ä»¶ï¼ˆä¾›ä¸‹æ¬¡æ¯”è¾ƒï¼‰
      - name: Upload commit record
        uses: actions/upload-artifact@v4
        with:
          name: last-mangohud-commit
          path: ${{ env.LAST_COMMIT_FILE }}

name: Build MangoHud (aarch64)

on:
  workflow_dispatch:
    inputs:
      version_ref:
        description: 'ç‰ˆæœ¬å·/æ ‡ç­¾/æäº¤å“ˆå¸Œ (ä¾‹å¦‚: v0.7.0, master, æˆ– commit hash)'
        required: true
        default: 'master'
        type: string

permissions:
  contents: write

env:
  REPO_URL: https://github.com/flightlessmango/MangoHud.git

jobs:
  build: 
    runs-on: ubuntu-24.04-arm

    steps:
      # ğŸ§© æ£€å‡ºå½“å‰ä»“åº“
      - name: Checkout workflow repository
        uses: actions/checkout@v4

      # ğŸ§­ å…‹éš†æŒ‡å®šç‰ˆæœ¬çš„ MangoHud æºç 
      - name: Clone MangoHud source
        run: |
          git clone --depth=1 --branch ${{ inputs.version_ref }} $REPO_URL MangoHud || \
          git clone --depth=1 $REPO_URL MangoHud
          cd MangoHud
          git checkout ${{ inputs.version_ref }} || echo "ä½¿ç”¨é»˜è®¤åˆ†æ”¯"

      # ğŸ”– è·å–æºç ç‰ˆæœ¬ä¿¡æ¯
      - name: è·å–æºç ç‰ˆæœ¬ä¿¡æ¯
        id: get_version
        run: |
          cd MangoHud
          # å°è¯•è·å–æ ‡ç­¾
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            VERSION=$(git describe --tags --abbrev=0)
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          
          AUTHOR=$(git log -1 --pretty=format:'%an')
          COMMIT=$(git rev-parse HEAD)
          COMMIT_SHORT=$(git rev-parse --short HEAD)
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          DATE=$(date '+%Y-%m-%d %H:%M:%S UTC')
          
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "AUTHOR=$AUTHOR" >> $GITHUB_ENV
          echo "COMMIT=$COMMIT" >> $GITHUB_ENV
          echo "COMMIT_SHORT=$COMMIT_SHORT" >> $GITHUB_ENV
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          echo "BUILD_TIME=$DATE" >> $GITHUB_ENV
          echo "INPUT_VERSION=${{ inputs.version_ref }}" >> $GITHUB_ENV
          
          echo "âœ… æ„å»ºä¿¡æ¯:"
          echo "ğŸ“¦ ç‰ˆæœ¬: $VERSION"
          echo "ğŸŒ¿ åˆ†æ”¯/æ ‡ç­¾: $BRANCH"
          echo "ğŸ”– æäº¤: $COMMIT_SHORT"
          echo "ğŸ‘¤ ä½œè€…: $AUTHOR"
          echo "ğŸ¯ è¾“å…¥ç‰ˆæœ¬: ${{ inputs.version_ref }}"
          echo "ğŸ•“ æ„å»ºæ—¶é—´: $DATE"

      - name: ä¿®å¤ä¾èµ–
        run: |
          sudo apt clean
          sudo apt autoclean
          sudo rm -rf /var/lib/apt/lists/*
          sudo apt update
          sudo rm /var/lib/apt/lists/lock
          sudo rm /var/cache/apt/archives/lock

      # ğŸ“¦ å®‰è£…ä¾èµ–
      - name: å®‰è£…åŸºç¡€ä¾èµ–
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential glslang-tools python3-pip git \
            pkg-config meson libdbus-1-dev libx11-dev \
            libxext-dev libxrandr-dev libxinerama-dev \
            libxdamage-dev libxfixes-dev libdrm-dev \
            libgl1-mesa-dev libwayland-dev libxkbcommon-dev patchelf

      # ğŸ› ï¸ å‡çº§ Meson/Ninja
      - name: å‡çº§ Meson å’Œ Ninja
        run: |
          pip install --upgrade pip
          pip install --upgrade meson ninja mako
          meson --version
          ninja --version

      # âš™ï¸ åº”ç”¨ Termux æ—  root CPU é¢‘ç‡è¡¥ä¸
      - name: åº”ç”¨ Termux æ—  root CPU é¢‘ç‡è¡¥ä¸
        run: |
          cd MangoHud
          SRC_FILE="src/sysinfo/linux.cpp"
          if [ -f "$SRC_FILE" ]; then
            echo "ğŸ”§ åº”ç”¨ CPU é¢‘ç‡æ£€æµ‹ä¿®è¡¥..."
            cp "$SRC_FILE" "${SRC_FILE}.bak"
            awk '
            BEGIN {in_func=0}
            /^int get_cpu_freq\(int core\)/ {print; in_func=1; next}
            in_func && /^\{/ {print; print "    int freq = 0; std::string path;"; next}
            in_func && /return freq;/ {
                print "    // å°è¯• scaling_cur_freq"
                print "    path = \"/sys/devices/system/cpu/cpu\" + std::to_string(core) + \"/cpufreq/scaling_cur_freq\";"
                print "    { std::ifstream f(path); if(f.is_open()){ f >> freq; if(freq>0) return freq/1000; } }"
                print ""
                print "    // å°è¯• cpuinfo_cur_freq"
                print "    path = \"/sys/devices/system/cpu/cpu\" + std::to_string(core) + \"/cpufreq/cpuinfo_cur_freq\";"
                print "    { std::ifstream f(path); if(f.is_open()){ f >> freq; if(freq>0) return freq/1000; } }"
                print ""
                print "    // ä» /proc/cpuinfo è¯»å– (é root fallback)"
                print "    {"
                print "        std::ifstream cpuinfo(\"/proc/cpuinfo\");"
                print "        if(cpuinfo.is_open()){"
                print "            std::string line; int index=-1;"
                print "            while(std::getline(cpuinfo,line)){"
                print "                if(line.find(\"processor\")!=std::string::npos) index++;"
                print "                if(index==core && line.find(\"cpu MHz\")!=std::string::npos){"
                print "                    size_t pos=line.find(\":\");"
                print "                    if(pos!=std::string::npos){"
                print "                        std::istringstream iss(line.substr(pos+1));"
                print "                        iss >> freq; if(freq>0) return (int)freq;"
                print "                    }"
                print "                }"
                print "            }"
                print "        }"
                print "    }"
                print ""
                print "    // fallback é»˜è®¤å€¼"
                print "    return 2000;"
                in_func=0; next
            }
            {print}
            ' "${SRC_FILE}.bak" > "$SRC_FILE"
            echo "âœ… CPU é¢‘ç‡æ£€æµ‹è¡¥ä¸åº”ç”¨æˆåŠŸ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° $SRC_FILE"
          fi

      # ğŸ”§ ä¿®å¤ Android å…¼å®¹æ€§é—®é¢˜
      - name: ä¿®å¤ Android å…¼å®¹æ€§é—®é¢˜
        run: |
          cd MangoHud
          
          echo "ğŸ”§ ä¿®å¤ file_utils.cpp..."
          
          # ä¿®å¤ file_utils.cppï¼šæ·»åŠ æƒé™æ£€æŸ¥
          FILE_UTILS="src/file_utils.cpp"
          if [ -f "$FILE_UTILS" ]; then
            # å¤‡ä»½åŸæ–‡ä»¶
            cp "$FILE_UTILS" "${FILE_UTILS}.bak"
            
            # åœ¨lså‡½æ•°ä¸­æ·»åŠ æƒé™æ£€æŸ¥
            awk '
            BEGIN {in_func=0; added=0}
            /^std::vector<std::string> ls(const char\* root, const char\* prefix, LS_FLAGS flags)/ {
                in_func=1
                print
                next
            }
            in_func && /^\s*DIR\* dirp = opendir(root);/ && !added {
                print
                print "    // --- [Fix Start] ---"
                print "    // åœ¨ Android Proot ç¯å¢ƒä¸‹ï¼Œç›´æ¥ opendir å—é™ç›®å½•å¯èƒ½ä¼šå´©ï¼Œå…ˆæ£€æŸ¥æƒé™"
                print "    if (access(root, R_OK | X_OK) != 0) {"
                print "        SPDLOG_WARN(\"No permission to access directory: {}\", root);"
                print "        return list; // å¦‚æœæ²¡æƒé™ï¼Œç›´æ¥è¿”å›ç©ºåˆ—è¡¨ï¼Œä¸è¦æŠ¥é”™ä¹Ÿä¸è¦ç»§ç»­"
                print "    }"
                print "    // --- [Fix End] ---"
                added=1
                next
            }
            in_func && /^\}/ {
                in_func=0
                added=0
                print
                next
            }
            {print}
            ' "${FILE_UTILS}.bak" > "$FILE_UTILS"
            
            echo "âœ… file_utils.cpp ä¿®å¤å®Œæˆ"
          fi
          
          echo "ğŸ”§ ä¿®å¤ gpu.cpp..."
          
          # ä¿®å¤ gpu.cppï¼šä½¿ç”¨æ›´å®‰å…¨çš„ä¿®æ”¹æ–¹æ³•
          GPU_FILE="src/gpu.cpp"
          if [ -f "$GPU_FILE" ]; then
            echo "ğŸ”§ ä¿®æ”¹ GPUS æ„é€ å‡½æ•°..."
            
            # å¤‡ä»½åŸæ–‡ä»¶
            cp "$GPU_FILE" "${GPU_FILE}.bak"
            
            # ä½¿ç”¨awkä¿®æ”¹æ„é€ å‡½æ•°
            awk '
            BEGIN {in_constructor=0; brace_count=0; skip_original_loop=0; in_original_loop=0; loop_brace_count=0}
            
            # æ‰¾åˆ°æ„é€ å‡½æ•°å¼€å§‹
            /GPUS::GPUS\(const overlay_params\* early_params\)/ {
                print
                print "#include \"overlay_params.h\""
                print "#include <fstream>"
                print "#include <algorithm>"
                print "#include <iostream>"
                print "#include <thread>"
                print "#include <chrono>"
                in_constructor=1
                next
            }
            
            in_constructor && /\{/ {
                if (brace_count == 0) {
                    print
                    print "    std::set<std::string> gpu_entries;"
                    print "    auto params = early_params ? early_params : get_params().get();"
                    print ""
                    print "    if (fs::exists(\"/sys/class/drm\")) {"
                    print "        try {"
                    print "            for (const auto& entry : fs::directory_iterator(\"/sys/class/drm\")) {"
                    print "                if (!entry.is_directory())"
                    print "                    continue;"
                    print ""
                    print "                std::string node_name = entry.path().filename().string();"
                    print ""
                    print "                // Check if the directory is a render node (e.g., renderD128, renderD129, etc.)"
                    print "                if (node_name.find(\"renderD\") == 0 && node_name.length() > 7) {"
                    print "                    // Ensure the rest of the string after \"renderD\" is numeric"
                    print "                    std::string render_number = node_name.substr(7);"
                    print "                    if (std::all_of(render_number.begin(), render_number.end(), ::isdigit)) {"
                    print "                        gpu_entries.insert(node_name);  // Store the render entry"
                    print "                    }"
                    print "                }"
                    print "            }"
                    print "        } catch (...) {"
                    print "            SPDLOG_WARN(\"Skipping /sys/class/drm scan due to permission error.\");"
                    print "        }"
                    print "    }"
                    print ""
                    print "    // Now process the sorted GPU entries"
                    print "    uint8_t idx = 0, total_active = 0;"
                    print ""
                    skip_original_loop=1
                } else {
                    print
                }
                brace_count++
                next
            }
            
            # è·³è¿‡åŸæ„é€ å‡½æ•°ä¸­çš„éå†å¾ªç¯éƒ¨åˆ†
            skip_original_loop && /for \(const auto& entry : fs::directory_iterator\("\/sys\/class\/drm"\)\)/ {
                in_original_loop=1
                next
            }
            
            in_original_loop && /\{/ {
                loop_brace_count++
                next
            }
            
            in_original_loop && /\}/ {
                loop_brace_count--
                if (loop_brace_count == 0) {
                    in_original_loop=0
                    skip_original_loop=0
                }
                next
            }
            
            skip_original_loop && in_original_loop {
                next
            }
            
            # å¤„ç†Adreno GPUç›‘æ§ä»£ç 
            in_constructor && /if \(total_active < 2\)/ {
                print "    // Adreno GPU monitoring for Android"
                print "    if (fs::exists(\"/sys/class/kgsl/kgsl-3d0/gpubusy\")) {"
                print "        bool already_added = false;"
                print "        for (auto& g : available_gpus) {"
                print "            if (g->driver == \"adreno\" || g->driver == \"freedreno\") already_added = true;"
                print "        }"
                print ""
                print "        if (!already_added) {"
                print "            auto adreno = std::make_shared<GPU>(\"Adreno\", 0x5143, 0, \"0000:00:00.0\", \"adreno\");"
                print "            "
                print "            if (total_active == 0) {"
                print "                adreno->is_active = true;"
                print "                total_active++;"
                print "            }"
                print "            available_gpus.emplace_back(adreno);"
                print ""
                print "            std::thread([adreno](){"
                print "                while(true) {"
                print "                    std::ifstream stream(\"/sys/class/kgsl/kgsl-3d0/gpubusy\");"
                print "                    if (stream.is_open()) {"
                print "                        std::string line;"
                print "                        if (std::getline(stream, line)) {"
                print "                            long long used = 0, total = 0;"
                print "                            if (sscanf(line.c_str(), \"%lld %lld\", &used, &total) == 2 && total > 0) {"
                print "                                 int val = (int)((float)used / total * 100);"
                print "                                 if (val > 100) val = 100;"
                print "                                 if (val < 0) val = 0;"
                print "                                 adreno->metrics.load = val;"
                print "                            }"
                print "                        }"
                print "                    }"
                print "                    std::this_thread::sleep_for(std::chrono::milliseconds(200));"
                print "                }"
                print "            }).detach();"
                print ""
                print "            SPDLOG_INFO(\"Adreno GPU injected with background monitoring thread\");"
                print "        }"
                print "    }"
                print ""
                print
                next
            }
            
            in_constructor && /\}/ {
                brace_count--
                if (brace_count == 0) {
                    print
                    in_constructor=0
                } else {
                    print
                }
                next
            }
            
            {print}
            ' "${GPU_FILE}.bak" > "${GPU_FILE}.tmp"
            
            # æ£€æŸ¥æ˜¯å¦æˆåŠŸä¿®æ”¹
            if grep -q "Skipping /sys/class/drm scan due to permission error" "${GPU_FILE}.tmp" && \
               grep -q "Adreno GPU injected" "${GPU_FILE}.tmp"; then
              mv "${GPU_FILE}.tmp" "$GPU_FILE"
              echo "âœ… gpu.cpp ä¿®å¤å®Œæˆ"
            else
              echo "âš ï¸ gpu.cpp ä¿®æ”¹å¤±è´¥ï¼Œä½¿ç”¨åŸæ–‡ä»¶"
              mv "${GPU_FILE}.bak" "$GPU_FILE"
            fi
            
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -f "${GPU_FILE}.tmp" "${GPU_FILE}.bak"
          fi
          
          echo "ğŸ” éªŒè¯ä¿®æ”¹..."
          echo "=== file_utils.cpp ä¿®æ”¹éªŒè¯ ==="
          grep -n "No permission to access directory" "$FILE_UTILS" || echo "æœªæ‰¾åˆ°æƒé™æ£€æŸ¥ä»£ç "
          
          echo ""
          echo "=== gpu.cpp ä¿®æ”¹éªŒè¯ ==="
          if [ -f "$GPU_FILE" ]; then
            echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < "$GPU_FILE")"
            echo "åŒ…å« Skipping /sys/class/drm scan: $(grep -c "Skipping /sys/class/drm scan" "$GPU_FILE")"
            echo "åŒ…å« Adreno GPU injected: $(grep -c "Adreno GPU injected" "$GPU_FILE")"
            echo "æœ€å10è¡Œ:"
            tail -10 "$GPU_FILE"
          fi

      # ğŸ—ï¸ æ„å»º MangoHud
      - name: æ„å»º MangoHud (Termux)
        run: |
          cd MangoHud
          sudo mkdir -p /opt/mesa
          sudo chmod -R 777 /opt
          meson setup build \
            --prefix=/opt/mesa \
            --libdir=lib \
            -Dbuildtype=release \
            -Dwith_x11=enabled \
            -Dwith_wayland=enabled \
            -Dwith_xnvctrl=disabled \
            -Dwith_dbus=enabled \
            -Dmangoplot=enabled \
            -Dmangoapp=false \
            -Dmangohudctl=false \
            -Dtests=disabled
          ninja -C build -j$(nproc)
          ninja -C build install

      # ğŸ”§ ä¿®æ­£ $LIB å˜é‡
      - name: ä¿®æ­£ MangoHud å¯åŠ¨è„šæœ¬
        run: |
          ROOT=/opt/mesa
          if [ -f "$ROOT/bin/mangohud" ]; then
            sed -i 's|/\\$LIB|/lib|g' "$ROOT/bin/mangohud"
          fi

      # ğŸ§± ä¿®è¡¥ ELF è§£é‡Šå™¨
      - name: ä¿®è¡¥ ELF å¯æ‰§è¡Œæ–‡ä»¶
        run: |
          ROOT=/opt/mesa
          INTERP=$ROOT/lib/ld-linux-aarch64.so.1
          for dir in "$ROOT/bin" "$ROOT/lib"; do
            [ -d "$dir" ] || continue
            for f in "$dir"/*; do
              if file "$f" | grep -q 'ELF'; then
                patchelf --set-interpreter "$INTERP" "$f" || true
              fi
            done
          done

      # ğŸ“¦ æ‰“åŒ…ç»“æœ
      - name: æ‰“åŒ…æ„å»ºäº§ç‰©
        run: |
          cd /opt
          TAR_NAME="termux-mangohud-${{ env.VERSION }}-aarch64.tar.gz"
          tar -czvf /home/runner/$TAR_NAME mesa
          echo "TAR_NAME=$TAR_NAME" >> $GITHUB_ENV
          echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ: $TAR_NAME"

      # â˜ï¸ ä¸Šä¼ äº§ç‰©
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.TAR_NAME }}
          path: /home/runner/${{ env.TAR_NAME }}

      # ğŸš€ å‘å¸ƒ Release
      - name: å‘å¸ƒåˆ° GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ env.VERSION }}-${{ env.COMMIT_SHORT }}
          name: MangoHud ${{ env.VERSION }} (aarch64)
          body: |
            ## MangoHud ${{ env.VERSION }} for Termux (aarch64)

            ### ğŸ“‹ æ„å»ºä¿¡æ¯
            - **ç‰ˆæœ¬å·**: `${{ env.VERSION }}`
            - **æ„å»ºæ¥æº**: `${{ env.INPUT_VERSION }}`
            - **åˆ†æ”¯/æ ‡ç­¾**: `${{ env.BRANCH }}`
            - **æ¶æ„**: aarch64
            - **ç¯å¢ƒ**: Termux
            - **ä½œè€…**: `${{ env.AUTHOR }}`
            - **æäº¤**: `${{ env.COMMIT_SHORT }}`
            - **å®Œæ•´æäº¤**: `${{ env.COMMIT }}`
            - **æ„å»ºæ—¶é—´**: `${{ env.BUILD_TIME }}`

            ### ğŸ“¦ æ–‡ä»¶ä¿¡æ¯
            - **æ–‡ä»¶å**: `${{ env.TAR_NAME }}`
            - **åŒ…å«**: å®Œæ•´çš„ MangoHud å®‰è£…æ–‡ä»¶

            ### ğŸ› ï¸ æ„å»ºç‰¹æ€§
            - âœ… æ”¯æŒ X11
            - âœ… æ”¯æŒ Wayland
            - âœ… æ”¯æŒ DBus
            - âœ… å¯ç”¨ MangoPlot
            - âœ… Termux æ—  root CPU é¢‘ç‡æ£€æµ‹è¡¥ä¸
            - âŒ ç¦ç”¨ XNVCtrl (NVIDIA GPU ç»Ÿè®¡)
            - âŒ ç¦ç”¨ MangoApp
            - âŒ ç¦ç”¨ MangoHudctl

            ### ğŸ“¥ ä½¿ç”¨æ–¹æ³•
            1. ä¸‹è½½å¹¶è§£å‹åˆ° Termux çš„ `/opt/mesa` ç›®å½•
            2. è¿è¡Œ `mangohud` å‘½ä»¤ä½¿ç”¨

            ### ğŸ”§ æ‰‹åŠ¨æ„å»ºå‚æ•°
            - **è¯·æ±‚ç‰ˆæœ¬**: `${{ inputs.version_ref }}`
            - **è§¦å‘æ—¶é—´**: `${{ github.event.workflow_dispatch.inputs.triggered_at }}`
          files: /home/runner/${{ env.TAR_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
name: Wine ARM64 无bootBuilder

on:
  schedule:
    # Proton 构建 - 每月1号和15号
    - cron: '0 0 1,15 * *'
    # Wine 构建 - 每月5号和20号
    - cron: '0 2 5,20 * *'
  workflow_dispatch:
    inputs:
      build_type:
        description: '选择构建类型'
        required: true
        default: 'proton'
        type: choice
        options:
        - proton
        - wine-wow64
      proton_branch:
        description: 'Proton 分支 (仅 Proton 构建)'
        required: false
        default: 'proton_10.0'
        type: choice
        options:
        - proton_10.0
        - experimental_10.0
        - bleeding-edge
      wine_branch:
        description: 'Wine 分支 (仅 Wine 构建)'
        required: false
        default: 'staging'
        type: choice
        options:
        - vanilla
        - staging
        - staging-tkg
        - staging-tkg-fsync
      wine_version:
        description: 'Wine 版本 (仅 Wine 构建)'
        required: false
        default: 'latest'
        type: string

env:
  USE_CCACHE: true
  BUILD_DIR: /tmp/build_wine

permissions:
  contents: write  # 允许 GITHUB_TOKEN 创建 Release

jobs:
  build-proton:
    runs-on: ubuntu-24.04-arm
    if: github.event.inputs.build_type == 'proton' || (github.event_name == 'schedule' && github.event.schedule == '0 0 1,15 * *')
    timeout-minutes: 360  # 增加到6小时
    
    steps:
      - uses: actions/checkout@v4

      - name: 修复包管理系统
        run: |
          sudo apt clean
          sudo apt autoclean
          sudo apt autoremove -y
          sudo dpkg --configure -a
          sudo apt update --fix-missing

      - name: 安装 FEX-Emu 构建依赖
        run: |
          sudo apt update
          sudo apt install -y \
            clang \
            lld \
            llvm \
            ninja-build \
            cmake \
            git \
            python3 \
            python3-setuptools \
            nasm \
            libfmt-dev \
            libepoxy-dev \
            libsdl2-dev \
            libxxhash-dev \
            libasound2-dev \
            libdrm-dev \
            libglvnd-dev \
            libx11-dev \
            libxrandr-dev \
            libssl-dev \
            libwayland-dev \
            zlib1g-dev \
            catch2

      - name: 安装构建依赖（修复版本）
        run: |
          sudo apt update
          
          # 修复包依赖问题
          sudo apt --fix-broken install -y
          sudo apt install -f -y
          
          # 添加 32 位架构支持
          sudo dpkg --add-architecture armhf
          sudo apt update
          
          # 基础构建依赖 - ARM64 专用
          BASE_DEPS="\
            debootstrap \
            perl \
            git \
            wget \
            curl \
            xz-utils \
            bubblewrap \
            autoconf \
            automake \
            autotools-dev \
            flex \
            bison \
            gcc \
            g++ \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libtool \
            libx11-dev \
            libx11-dev:armhf \
            libxext-dev \
            libxext-dev:armhf \
            libxi-dev \
            libxi-dev:armhf \
            libxrandr-dev \
            libxrandr-dev:armhf \
            libxcursor-dev \
            libxcursor-dev:armhf \
            libxcomposite-dev \
            libxcomposite-dev:armhf \
            libxdamage-dev \
            libxdamage-dev:armhf \
            libxfixes-dev \
            libxfixes-dev:armhf \
            libxxf86vm-dev \
            libxxf86vm-dev:armhf \
            libxrender-dev \
            libxrender-dev:armhf \
            libxinerama-dev \
            libxinerama-dev:armhf \
            libgl-dev \
            libgl-dev:armhf \
            libglu-dev \
            libglu-dev:armhf \
            libosmesa6-dev \
            libosmesa6-dev:armhf \
            libfreetype6-dev \
            libfreetype6-dev:armhf \
            libfontconfig1-dev \
            libfontconfig1-dev:armhf \
            libpcap-dev \
            libdbus-1-dev \
            libdbus-1-dev:armhf \
            libssl-dev \
            libssl-dev:armhf \
            libasound2-dev \
            libasound2-dev:armhf \
            libpulse-dev \
            libpulse-dev:armhf \
            libudev-dev \
            libudev-dev:armhf \
            libcups2-dev \
            libcups2-dev:armhf \
            libjpeg-dev \
            libjpeg-dev:armhf \
            libpng-dev \
            libpng-dev:armhf \
            libtiff-dev \
            libtiff-dev:armhf \
            libxml2-dev \
            libxml2-dev:armhf \
            libvulkan-dev \
            libvulkan-dev:armhf \
            vulkan-tools \
            libvulkan1 \
            libvulkan1:armhf \
            mesa-vulkan-drivers \
            gettext \
            libgettextpo-dev \
            libgettextpo-dev:armhf \
            locales \
            language-pack-zh-hans"
          
          # 逐个安装包以避免依赖冲突
          for pkg in $BASE_DEPS; do
            echo "安装包: $pkg"
            sudo apt install -y --allow-downgrades --allow-remove-essential --allow-change-held-packages "$pkg" || echo "跳过有问题的包: $pkg"
          done

          # 安装交叉编译工具链
          CROSS_DEPS="\
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            binutils-arm-linux-gnueabihf \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu"
          
          sudo apt install -y $CROSS_DEPS

      - name: 安装多媒体和音频依赖
        run: |
            sudo apt update
            # 安装完整的 GStreamer (64位和32位)
            MULTIMEDIA_DEPS="\
              libunwind-dev \
              libunwind-dev:armhf \
              libgstreamer1.0-dev \
              libgstreamer1.0-dev:armhf \
              libgstreamer-plugins-base1.0-dev \
              libgstreamer-plugins-base1.0-dev:armhf \
              libgstreamer-plugins-good1.0-dev \
              libgstreamer-plugins-good1.0-dev:armhf \
              libgstreamer-plugins-bad1.0-dev \
              libgstreamer-plugins-bad1.0-dev:armhf \
              gstreamer1.0-plugins-base \
              gstreamer1.0-plugins-base:armhf \
              gstreamer1.0-plugins-good \
              gstreamer1.0-plugins-good:armhf \
              gstreamer1.0-plugins-bad \
              gstreamer1.0-plugins-bad:armhf \
              gstreamer1.0-plugins-ugly \
              gstreamer1.0-plugins-ugly:armhf \
              gstreamer1.0-libav \
              gstreamer1.0-libav:armhf \
              gstreamer1.0-tools \
              libmpg123-dev \
              libmpg123-dev:armhf \
              libopenal-dev \
              libopenal-dev:armhf \
              libfaad-dev \
              libfaad-dev:armhf \
              libflac-dev \
              libflac-dev:armhf \
              libvorbis-dev \
              libvorbis-dev:armhf \
              libx264-dev \
              libx264-dev:armhf \
              libx265-dev \
              libx265-dev:armhf \
              libvpx-dev \
              libvpx-dev:armhf \
              libtheora-dev \
              libtheora-dev:armhf \
              libavcodec-dev \
              libavcodec-dev:armhf \
              libavformat-dev \
              libavformat-dev:armhf \
              libavutil-dev \
              libavutil-dev:armhf \
              libswscale-dev \
              libswscale-dev:armhf"
            
            for pkg in $MULTIMEDIA_DEPS; do
              echo "安装多媒体包: $pkg"
              sudo apt install -y --allow-downgrades --allow-remove-essential --allow-change-held-packages "$pkg" || echo "跳过有问题的包: $pkg"
            done

      - name: 构建 FEX-Emu
        run: |
            set -e
            echo "开始构建 FEX-Emu for ARM64..."
            
            FEX_BUILD_DIR="/tmp/build_fex"
            rm -rf "$FEX_BUILD_DIR"
            mkdir -p "$FEX_BUILD_DIR"
            cd "$FEX_BUILD_DIR"
            
            # 下载 llvm-mingw 工具链
            wget -O llvm-mingw.tar.xz https://github.com/bylaws/llvm-mingw/releases/download/20250920/llvm-mingw-20250920-ucrt-ubuntu-22.04-aarch64.tar.xz
            tar -xJf llvm-mingw.tar.xz -C /tmp
            
            export PATH="/tmp/llvm-mingw-20250920-ucrt-ubuntu-22.04-aarch64/bin:$PATH"
            export CFLAGS="-O3 -g -pipe -Wall -Wextra"
            export CXXFLAGS="$CFLAGS"
            export LDFLAGS="-Wl,--gc-sections"
            
            # 根据 spec 文件构建 FEX-Emu
            echo "=== 构建 FEX-Emu ==="
            
            # 克隆 FEX-Emu 源码
            git clone https://github.com/FEX-Emu/FEX.git
            cd FEX
            git checkout 4afbdd9afb4738b2abbf303493c5b67f58b8ae4c
            
            # 应用补丁
            wget https://github.com/FEX-Emu/FEX/commit/a37def2c22e528477f64296747228400ddc40222.patch -O patch1.patch
            wget https://github.com/FEX-Emu/FEX/commit/8eaf45414c05c9e7ef6f74a323d95fe7e0d883c1.patch -O patch2.patch
            wget https://github.com/FEX-Emu/FEX/commit/c326e2d669fd5e9356f6107e188413a449cc1fd7.patch -O patch3.patch
            
            git apply patch1.patch || echo "补丁1可能已应用"
            git apply patch2.patch || echo "补丁2可能已应用"
            git apply patch3.patch || echo "补丁3可能已应用"
            
            # 手动下载外部依赖（根据 spec 文件）
            mkdir -p External
            
            # Catch2
            wget https://github.com/catchorg/Catch2/archive/b3fb4b9.tar.gz -O Catch2-b3fb4b9.tar.gz
            tar -xzf Catch2-b3fb4b9.tar.gz -C External
            # 检查实际解压的目录名
            CATCH_DIR=$(find External -maxdepth 1 -type d -name "Catch2*" | head -1)
            if [ -n "$CATCH_DIR" ]; then
              mv "$CATCH_DIR" External/Catch2
            else
              echo "错误: 无法找到 Catch2 解压目录"
              ls -la External/
              exit 1
            fi
            
            # cpp-optparse
            wget https://github.com/Sonicadvance1/cpp-optparse/archive/9f94388.tar.gz -O cpp-optparse-9f94388.tar.gz
            tar -xzf cpp-optparse-9f94388.tar.gz -C External
            CPP_OPTPARSE_DIR=$(find External -maxdepth 1 -type d -name "cpp-optparse*" | head -1)
            if [ -n "$CPP_OPTPARSE_DIR" ]; then
              mv "$CPP_OPTPARSE_DIR" External/cpp-optparse
            else
              echo "错误: 无法找到 cpp-optparse 解压目录"
              exit 1
            fi
            
            # Vulkan-Headers
            wget https://github.com/KhronosGroup/Vulkan-Headers/archive/cacef30.tar.gz -O Vulkan-Headers-cacef30.tar.gz
            tar -xzf Vulkan-Headers-cacef30.tar.gz -C External
            VULKAN_DIR=$(find External -maxdepth 1 -type d -name "Vulkan-Headers*" | head -1)
            if [ -n "$VULKAN_DIR" ]; then
              mv "$VULKAN_DIR" External/Vulkan-Headers
            else
              echo "错误: 无法找到 Vulkan-Headers 解压目录"
              exit 1
            fi
            
            # drm-headers
            wget https://github.com/FEX-Emu/kernel/archive/3e49836.tar.gz -O kernel-3e49836.tar.gz
            tar -xzf kernel-3e49836.tar.gz -C External
            KERNEL_DIR=$(find External -maxdepth 1 -type d -name "kernel*" | head -1)
            if [ -n "$KERNEL_DIR" ]; then
              mv "$KERNEL_DIR" External/drm-headers
            else
              echo "错误: 无法找到 kernel 解压目录"
              exit 1
            fi
            
            # fmt
            wget https://github.com/fmtlib/fmt/archive/407c905.tar.gz -O fmt-407c905.tar.gz
            tar -xzf fmt-407c905.tar.gz -C External
            FMT_DIR=$(find External -maxdepth 1 -type d -name "fmt*" | head -1)
            if [ -n "$FMT_DIR" ]; then
              mv "$FMT_DIR" External/fmt
            else
              echo "错误: 无法找到 fmt 解压目录"
              exit 1
            fi
            
            # jemalloc
            wget https://github.com/FEX-Emu/jemalloc/archive/ce24593.tar.gz -O jemalloc-ce24593.tar.gz
            tar -xzf jemalloc-ce24593.tar.gz -C External
            JEMALLOC_DIR=$(find External -maxdepth 1 -type d -name "jemalloc*" | head -1)
            if [ -n "$JEMALLOC_DIR" ]; then
              mv "$JEMALLOC_DIR" External/jemalloc
            else
              echo "错误: 无法找到 jemalloc 解压目录"
              exit 1
            fi
            
            # jemalloc_glibc
            wget https://github.com/FEX-Emu/jemalloc/archive/8436195.tar.gz -O jemalloc-8436195.tar.gz
            tar -xzf jemalloc-8436195.tar.gz -C External
            JEMALLOC_GLIBC_DIR=$(find External -maxdepth 1 -type d -name "jemalloc*" | tail -1)
            if [ -n "$JEMALLOC_GLIBC_DIR" ] && [ "$JEMALLOC_GLIBC_DIR" != "External/jemalloc" ]; then
              mv "$JEMALLOC_GLIBC_DIR" External/jemalloc_glibc
            else
              echo "错误: 无法找到 jemalloc_glibc 解压目录"
              exit 1
            fi
            
            # rpmalloc
            wget https://github.com/FEX-Emu/rpmalloc/archive/f1b76e1.tar.gz -O rpmalloc-f1b76e1.tar.gz
            tar -xzf rpmalloc-f1b76e1.tar.gz -C External
            RPMALLOC_DIR=$(find External -maxdepth 1 -type d -name "rpmalloc*" | head -1)
            if [ -n "$RPMALLOC_DIR" ]; then
              mv "$RPMALLOC_DIR" External/rpmalloc
            else
              echo "错误: 无法找到 rpmalloc 解压目录"
              exit 1
            fi
            
            # range-v3
            wget https://github.com/ericniebler/range-v3/archive/ca1388f.tar.gz -O range-v3-ca1388f.tar.gz
            tar -xzf range-v3-ca1388f.tar.gz -C External
            RANGE_DIR=$(find External -maxdepth 1 -type d -name "range-v3*" | head -1)
            if [ -n "$RANGE_DIR" ]; then
              mv "$RANGE_DIR" External/range-v3
            else
              echo "错误: 无法找到 range-v3 解压目录"
              exit 1
            fi
            
            # robin-map
            wget https://github.com/FEX-Emu/robin-map/archive/d5683d9.tar.gz -O robin-map-d5683d9.tar.gz
            tar -xzf robin-map-d5683d9.tar.gz -C External
            ROBIN_MAP_DIR=$(find External -maxdepth 1 -type d -name "robin-map*" | head -1)
            if [ -n "$ROBIN_MAP_DIR" ]; then
              mv "$ROBIN_MAP_DIR" External/robin-map
            else
              echo "错误: 无法找到 robin-map 解压目录"
              exit 1
            fi
            
            # tracy
            wget https://github.com/wolfpld/tracy/archive/650c98e.tar.gz -O tracy-650c98e.tar.gz
            tar -xzf tracy-650c98e.tar.gz -C External
            TRACY_DIR=$(find External -maxdepth 1 -type d -name "tracy*" | head -1)
            if [ -n "$TRACY_DIR" ]; then
              mv "$TRACY_DIR" External/tracy
            else
              echo "错误: 无法找到 tracy 解压目录"
              exit 1
            fi
            
            # vixl
            wget https://github.com/FEX-Emu/vixl/archive/ed690c9.tar.gz -O vixl-ed690c9.tar.gz
            tar -xzf vixl-ed690c9.tar.gz -C External
            VIXL_DIR=$(find External -maxdepth 1 -type d -name "vixl*" | head -1)
            if [ -n "$VIXL_DIR" ]; then
              mv "$VIXL_DIR" External/vixl
            else
              echo "错误: 无法找到 vixl 解压目录"
              exit 1
            fi
            
            # xxhash
            wget https://github.com/Cyan4973/xxhash/archive/e626a72.tar.gz -O xxhash-e626a72.tar.gz
            tar -xzf xxhash-e626a72.tar.gz -C External
            XXHASH_DIR=$(find External -maxdepth 1 -type d -name "xxhash*" | head -1)
            if [ -n "$XXHASH_DIR" ]; then
              mv "$XXHASH_DIR" External/xxhash
            else
              echo "错误: 无法找到 xxhash 解压目录"
              exit 1
            fi
            
            # 检查所有依赖是否都已正确设置
            echo "检查外部依赖设置:"
            ls -la External/
            
            # 构建 ARM64EC 版本
            echo "=== 构建 ARM64EC 版本 ==="
            mkdir build-arm64ec && cd build-arm64ec
            
            cmake -DCMAKE_C_FLAGS="$CFLAGS" -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
              -GNinja \
              -DCMAKE_INSTALL_PREFIX=/tmp/fex-install \
              -DCMAKE_INSTALL_LIBDIR=/tmp/fex-install/lib/wine/aarch64-windows \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
              -DENABLE_LTO=False \
              -DTUNE_CPU=none \
              -DMINGW_TRIPLE=arm64ec-w64-mingw32 \
              -DBUILD_TESTING=False \
              -DENABLE_JEMALLOC_GLIBC_ALLOC=False \
              ..
            
            # 修复 dlltool 命令（根据 spec 文件）
            sed -i 's/arm64ec-w64-mingw32-dlltool/llvm-dlltool -m arm64ec/g' build.ninja
            ninja
            
            # 安装 ARM64EC
            DESTDIR=/tmp/fex-install ninja install
            cd ..
            
            # 构建 WOW64 版本
            echo "=== 构建 WOW64 版本 ==="
            mkdir build-wow64 && cd build-wow64
            
            cmake -DCMAKE_C_FLAGS="$CFLAGS" -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
              -GNinja \
              -DCMAKE_INSTALL_PREFIX=/tmp/fex-install \
              -DCMAKE_INSTALL_LIBDIR=/tmp/fex-install/lib/wine/aarch64-windows \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
              -DENABLE_LTO=False \
              -DTUNE_CPU=none \
              -DMINGW_TRIPLE=aarch64-w64-mingw32 \
              -DBUILD_TESTING=False \
              -DENABLE_JEMALLOC_GLIBC_ALLOC=OFF \
              ..
            
            # 修复 dlltool 命令（根据 spec 文件）
            sed -i 's/aarch64-w64-mingw32-dlltool/llvm-dlltool -m arm64/g' build.ninja
            ninja
            
            # 安装 WOW64
            DESTDIR=/tmp/fex-install ninja install
            cd ..
            
            echo "FEX-Emu 构建完成"
            echo "检查安装目录:"
            find /tmp/fex-install -name "*.dll" -type f

      - name: 设置交叉编译环境
        run: |
          # 创建交叉编译工具链符号链接
          sudo ln -sf /usr/bin/aarch64-linux-gnu-gcc /usr/local/bin/aarch64-linux-gnu-gcc
          sudo ln -sf /usr/bin/aarch64-linux-gnu-g++ /usr/local/bin/aarch64-linux-gnu-g++
          sudo ln -sf /usr/bin/arm-linux-gnueabihf-gcc /usr/local/bin/arm-linux-gnueabihf-gcc
          sudo ln -sf /usr/bin/arm-linux-gnueabihf-g++ /usr/local/bin/arm-linux-gnueabihf-g++
          
          # 验证工具链
          echo "验证交叉编译工具链:"
          aarch64-linux-gnu-gcc --version
          arm-linux-gnueabihf-gcc --version

      - name: 设置中文语言环境
        run: |
          sudo locale-gen zh_CN.UTF-8
          sudo update-locale LANG=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8

      - name: 设置编译环境
        run: |
          # 设置更宽松的 ulimit
          ulimit -s unlimited
          ulimit -n 65536
          
          # 显示系统资源
          echo "系统资源:"
          free -h
          df -h
          nproc
          cat /proc/meminfo | grep MemTotal

      - name: 构建 Proton ARM64 WOW64 版本
        run: |
            set -e
            
            echo "开始构建 Proton ARM64 WOW64 版本..."
            echo "分支: ${{ github.event.inputs.proton_branch || 'proton_10.0' }}"
            
            # 设置构建名称
            BUILD_NAME="proton-${{ github.event.inputs.proton_branch || 'proton_10.0' }}-arm64-wow64-xuser"
            echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV
            
            # 设置中文构建环境
            export LANG=zh_CN.UTF-8
            export LC_ALL=zh_CN.UTF-8
            export LANGUAGE=zh_CN:zh:en_US:en
            
            # 清理并创建构建目录
            rm -rf $BUILD_DIR/proton
            mkdir -p $BUILD_DIR/proton
            cd $BUILD_DIR/proton
            
            # 克隆 Proton 源码
            git clone https://github.com/afeimod/wine
            cd wine
            
            # 生成 configure 脚本
            echo "生成 configure 脚本..."
            ./autogen.sh
            
            # 第一步：构建 64 位 Wine
            echo "=== 构建 64 位 Wine ==="
            mkdir -p build64
            cd build64
            
            # 64 位编译标志 - 根据 FEX spec 优化
            export CFLAGS="-march=armv8-a+crc+crypto -O3 -g -pipe -Wall -Wextra -fPIC"
            export CXXFLAGS="-march=armv8-a+crc+crypto -O3 -g -pipe -Wall -Wextra -fPIC"
            export MAKEFLAGS="-j2"
            
            # 配置 64 位 Wine
            ../configure \
              --build=aarch64-linux-gnu \
              --host=aarch64-linux-gnu \
              --prefix=/tmp/wine-install-proton \
              --enable-win64 \
              --with-x \
              --with-alsa \
              --with-pulse \
              --with-freetype \
              --with-fontconfig \
              --with-gstreamer \
              --with-gettext \
              --with-sdl \
              --enable-nls \
              --disable-winemenubuilder \
              --disable-win16 \
              --disable-tests \
              --without-ldap \
              --without-capi \
              --without-oss \
              --without-cups \
              --without-dbus \
              --without-coreaudio \
              --without-gphoto \
              --without-osmesa \
              --without-sane \
              --without-pcap \
              --without-pcsclite \
              --without-udev \
              --without-unwind \
              --without-usb \
              --without-v4l2 \
              --without-wayland
            
            echo "编译 64 位 Wine..."
            make -j2 install || make -j1 install
            
            cd ..
            
            # 第二步：构建 32 位 Wine
            echo "=== 构建 32 位 Wine ==="
            mkdir -p build32
            cd build32
            
            # 安装 32 位依赖
            sudo apt update
            sudo apt install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
            
            # 32 位编译标志
            export CFLAGS="-march=armv8-a -O3 -g -pipe -Wall -Wextra -fPIC"
            export CXXFLAGS="-march=armv8-a -O3 -g -pipe -Wall -Wextra -fPIC"
            export MAKEFLAGS="-j2"
            
            # 配置 32 位 Wine，指向已安装的 64 位版本
            ../configure \
              --build=arm-linux-gnueabihf \
              --host=arm-linux-gnueabihf \
              --with-wine64=../build64 \
              --with-x \
              --with-alsa \
              --with-pulse \
              --with-freetype \
              --with-fontconfig \
              --disable-winemenubuilder \
              --disable-win16 \
              --disable-tests \
              --without-ldap \
              --without-capi \
              --without-oss \
              --without-cups \
              --without-dbus \
              --without-coreaudio \
              --without-gphoto \
              --without-osmesa \
              --without-sane \
              --without-pcap \
              --without-pcsclite \
              --without-udev \
              --without-unwind \
              --without-usb \
              --without-v4l2 \
              --without-wayland
            
            echo "编译 32 位 Wine..."
            make -j2 install || make -j1 install
            
            echo "ARM64 WOW64 Wine 构建完成"

      - name: 集成 FEX-Emu DLL
        run: |
          echo "集成 FEX-Emu DLL 到 Wine 安装目录..."
          if [ -d "/tmp/wine-install-proton" ] && [ -d "/tmp/fex-install" ]; then
            # 创建目标目录
            mkdir -p /tmp/wine-install-proton/lib/wine/aarch64-windows
            
            # 检查 FEX DLL 文件
            echo "查找 FEX DLL 文件:"
            find /tmp/fex-install -name "*.dll" -type f
            
            # 复制 DLL 文件
            if [ -f "/tmp/fex-install/lib/wine/aarch64-windows/libarm64ecfex.dll" ]; then
              cp /tmp/fex-install/lib/wine/aarch64-windows/libarm64ecfex.dll /tmp/wine-install-proton/lib/wine/aarch64-windows/
              echo "已复制 libarm64ecfex.dll"
            else
              echo "警告: libarm64ecfex.dll 不存在"
            fi
            
            if [ -f "/tmp/fex-install/lib/wine/aarch64-windows/libwow64fex.dll" ]; then
              cp /tmp/fex-install/lib/wine/aarch64-windows/libwow64fex.dll /tmp/wine-install-proton/lib/wine/aarch64-windows/
              echo "已复制 libwow64fex.dll"
            else
              echo "错误: libwow64fex.dll 不存在"
              # 检查其他可能的位置
              ALT_PATH=$(find /tmp/fex-install -name "libwow64fex.dll" -type f | head -1)
              if [ -n "$ALT_PATH" ]; then
                echo "在备用位置找到: $ALT_PATH"
                cp "$ALT_PATH" /tmp/wine-install-proton/lib/wine/aarch64-windows/
                echo "已从备用位置复制 libwow64fex.dll"
              else
                echo "错误: 无法在任何位置找到 libwow64fex.dll"
                exit 1
              fi
            fi
            
            echo "FEX-Emu DLL 集成完成"
            ls -la /tmp/wine-install-proton/lib/wine/aarch64-windows/
          else
            echo "警告: 无法找到 Wine 或 FEX-Emu 安装目录"
            echo "Wine 目录: /tmp/wine-install-proton"
            echo "FEX 目录: /tmp/fex-install"
            ls -la /tmp/ | grep -E "(wine|fex)"
          fi

      - name: 检查安装目录
        run: |
          echo "检查安装目录内容:"
          if [ -d "/tmp/wine-install-proton" ]; then
            find /tmp/wine-install-proton -type f | head -20 || echo "未找到文件"
            du -sh /tmp/wine-install-proton || echo "无法计算目录大小"
          else
            echo "安装目录 /tmp/wine-install-proton 不存在"
          fi

      - name: 准备打包
        run: |
          # 创建打包目录
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          mkdir -p wine-package/$PACKAGE_NAME
          
          # 检查源目录是否存在
          if [ -d "/tmp/wine-install-proton" ]; then
            echo "复制 Wine 文件到 $PACKAGE_NAME..."
            cp -r /tmp/wine-install-proton/* wine-package/$PACKAGE_NAME/ || echo "复制文件时出现问题"
          else
            echo "错误: 源目录 /tmp/wine-install-proton 不存在"
            exit 1
          fi

      - name: 创建打包文件
        run: |
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          
          echo "检查打包目录内容:"
          if [ -d "wine-package/$PACKAGE_NAME" ]; then
            echo "最终文件结构:"
            find "wine-package/$PACKAGE_NAME" -type f | head -20
            echo "目录大小:"
            du -sh "wine-package/$PACKAGE_NAME"
            
            # 使用 tar.xz 格式打包
            tar -cJf "$PACKAGE_NAME.tar.xz" -C wine-package "$PACKAGE_NAME"
            
            echo "打包完成:"
            ls -lh *.tar.xz
          else
            echo "错误: 打包目录 wine-package/$PACKAGE_NAME 不存在"
            exit 1
          fi

      - name: Generate checksums
        run: |
          cd $GITHUB_WORKSPACE
          sha256sum *.tar.xz > checksums.txt
          cat checksums.txt

      - name: Upload Proton artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Proton-${{ github.event.inputs.proton_branch || 'proton_10.0' }}-ARM64-WoW64-xuser
          path: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
          retention-days: 30

      - name: 发布 Proton 到 GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'proton'
        with:
          tag_name: proton-${{ github.event.inputs.proton_branch || 'proton_10.0' }}-arm64-wow64-xuser
          name: Proton ${{ github.event.inputs.proton_branch || 'proton_10.0' }} (ARM64 WOW64 with Vulkan & GStreamer for Termux - xuser)
          body: |
            # Proton ${{ github.event.inputs.proton_branch || 'proton_10.0' }} - ARM64 WOW64 with Vulkan & GStreamer for Termux (xuser)
            
            ## 版本信息
            - **Proton 分支**: ${{ github.event.inputs.proton_branch || 'proton_10.0' }}
            - **架构**: ARM64 WOW64 (在 ARM64 设备上运行 32 位和 64 位 Windows 应用程序)
            - **平台**: Termux (Android ARM64)
            - **图形 API**: Vulkan 支持已启用
            - **多媒体**: 完整 GStreamer 支持
            - **用户名**: xuser (已移除 Steam 优化)
            
            ## 特性
            ✓ ARM64 原生架构
            ✓ WOW64 支持 (在 ARM64 上运行 32 位和 64 位 Windows 应用程序)
            ✓ Vulkan 图形 API 支持
            ✓ 完整的 GStreamer 支持
            ✓ 中文环境支持
            ✓ 基于 Valve Proton，但移除了 Steam 特定优化
            ✓ 默认用户名改为 xuser
            ✓ 针对 ARM64 架构优化编译
            
            ## FEX-Emu 集成
            - libarm64ecfex.dll: ARM64EC 仿真支持
            - libwow64fex.dll: WOW64 仿真支持
            - 基于 FEX-Emu commit 4afbdd9
            - 使用 LLVM-MinGW 工具链构建
            
            ## 重要变更
            - 所有对 `steamuser` 的引用已改为 `xuser`
            - 移除了 Steam 特定的优化和组件
            - 更适合通用 Windows 应用程序运行
            - 针对 ARM64 架构优化
            
            ## 安装说明
            解压后，将 `${{ env.BUILD_NAME }}` 文件夹放置在 Termux 的合适位置，并设置环境变量。

            ## 构建信息
            - 构建时间: ${{ github.event.head_commit.timestamp }}
            - 提交: ${{ github.sha }}
            - 工作流: ${{ github.workflow }}
          files: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-wine-wow64:
    runs-on: ubuntu-24.04-arm
    if: github.event.inputs.build_type == 'wine-wow64' || (github.event_name == 'schedule' && github.event.schedule == '0 2 5,20 * *')
    timeout-minutes: 360  # 增加到6小时
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 修复包管理系统
        run: |
          sudo apt clean
          sudo apt autoclean
          sudo apt autoremove -y
          sudo dpkg --configure -a
          sudo apt update --fix-missing

      - name: 安装 FEX-Emu 构建依赖
        run: |
          sudo apt update
          sudo apt install -y \
            llvm \
            clang \
            lld \
            ninja-build \
            cmake \
            git \
            python3 \
            python3-setuptools \
            nasm \
            libfmt-dev \
            libepoxy-dev \
            libsdl2-dev \
            libxxhash-dev \
            libasound2-dev \
            libdrm-dev \
            libglvnd-dev \
            libx11-dev \
            libxrandr-dev \
            libssl-dev \
            libwayland-dev \
            zlib1g-dev

      - name: 构建 FEX-Emu
        run: |
          set -e
          echo "开始构建 FEX-Emu for ARM64..."
          
          FEX_BUILD_DIR="/tmp/build_fex"
          rm -rf "$FEX_BUILD_DIR"
          mkdir -p "$FEX_BUILD_DIR"
          cd "$FEX_BUILD_DIR"
          
          # 克隆 FEX-Emu 源码（使用递归克隆以包含子模块）
          git clone --recursive https://github.com/FEX-Emu/FEX.git
          cd FEX
          git checkout 4afbdd9afb4738b2abbf303493c5b67f58b8ae4c
          
          # 确保所有子模块都已正确初始化
          git submodule update --init --recursive
          
          # 手动下载并设置缺失的子模块
          echo "手动设置缺失的子模块..."
          
          # jemalloc
          if [ ! -d "External/jemalloc" ]; then
            git clone https://github.com/jemalloc/jemalloc.git External/jemalloc
            cd External/jemalloc
            git checkout 5.3.0
            cd ../..
          fi
          
          # xxhash
          if [ ! -d "External/xxhash" ]; then
            git clone https://github.com/Cyan4973/xxHash.git External/xxhash
            cd External/xxhash
            git checkout v0.8.2
            cd ../..
          fi
          
          # fmt
          if [ ! -d "External/fmt" ]; then
            git clone https://github.com/fmtlib/fmt.git External/fmt
            cd External/fmt
            git checkout 9.1.0
            cd ../..
          fi
          
          # range-v3
          if [ ! -d "External/range-v3" ]; then
            git clone https://github.com/ericniebler/range-v3.git External/range-v3
            cd External/range-v3
            git checkout 0.12.0
            cd ../..
          fi
          
          # cpp-optparse
          if [ ! -d "Source/Common/cpp-optparse" ]; then
            git clone https://github.com/Sonicadvance1/cpp-optparse.git Source/Common/cpp-optparse
          fi

          # 下载 llvm-mingw 工具链
          wget -O llvm-mingw.tar.xz https://github.com/bylaws/llvm-mingw/releases/download/20250920/llvm-mingw-20250920-ucrt-ubuntu-22.04-aarch64.tar.xz
          tar -xJf llvm-mingw.tar.xz -C /tmp
          
          export PATH="/tmp/llvm-mingw-20250920-ucrt-ubuntu-22.04-aarch64/bin:$PATH"
          export CFLAGS="-O3 -g -pipe -Wall -Wextra"
          export CXXFLAGS="$CFLAGS"
          export LDFLAGS="-Wl,--gc-sections"
          
          # 首先只构建 WOW64 版本，因为 ARM64EC 可能有问题
          echo "=== 构建 WOW64 版本 ==="
          mkdir build-wow64 && cd build-wow64
          cmake -DCMAKE_C_FLAGS="$CFLAGS" -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
            -GNinja \
            -DCMAKE_INSTALL_PREFIX=/tmp/fex-install \
            -DCMAKE_INSTALL_LIBDIR=/tmp/fex-install/lib/wine/aarch64-windows \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
            -DENABLE_LTO=False \
            -DTUNE_CPU=none \
            -DMINGW_TRIPLE=aarch64-w64-mingw32 \
            -DBUILD_TESTING=False \
            -DENABLE_JEMALLOC_GLIBC_ALLOC=OFF \
            ..
          
          sed -i 's/aarch64-w64-mingw32-dlltool/llvm-dlltool -m arm64/g' build.ninja
          ninja
          cd ..
          
          # 尝试构建 ARM64EC 版本，但如果失败则继续
          echo "=== 尝试构建 ARM64EC 版本 ==="
          mkdir build-arm64ec && cd build-arm64ec
          set +e  # 允许 ARM64EC 构建失败
          cmake -DCMAKE_C_FLAGS="$CFLAGS" -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
            -GNinja \
            -DCMAKE_INSTALL_PREFIX=/tmp/fex-install \
            -DCMAKE_INSTALL_LIBDIR=/tmp/fex-install/lib/wine/aarch64-windows \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
            -DENABLE_LTO=False \
            -DTUNE_CPU=none \
            -DMINGW_TRIPLE=arm64ec-w64-mingw32 \
            -DBUILD_TESTING=False \
            -DENABLE_JEMALLOC_GLIBC_ALLOC=False \
            ..
          
          if [ $? -eq 0 ]; then
            # 修复 dlltool 命令
            sed -i 's/arm64ec-w64-mingw32-dlltool/llvm-dlltool -m arm64ec/g' build.ninja
            ninja
          else
            echo "ARM64EC 配置失败，跳过 ARM64EC 构建"
          fi
          set -e  # 恢复错误检查
          cd ..
          
          # 安装 FEX-Emu
          mkdir -p /tmp/fex-install/lib/wine/aarch64-windows
          
          # 复制 WOW64 DLL（必须存在）
          if [ -f "build-wow64/libwow64fex.dll" ]; then
            cp build-wow64/libwow64fex.dll /tmp/fex-install/lib/wine/aarch64-windows/
            echo "已复制 libwow64fex.dll"
          else
            echo "错误: libwow64fex.dll 不存在"
            exit 1
          fi
          
          # 尝试复制 ARM64EC DLL（如果存在）
          if [ -f "build-arm64ec/libarm64ecfex.dll" ]; then
            cp build-arm64ec/libarm64ecfex.dll /tmp/fex-install/lib/wine/aarch64-windows/
            echo "已复制 libarm64ecfex.dll"
          else
            echo "警告: libarm64ecfex.dll 不存在，跳过 ARM64EC 支持"
          fi
          
          echo "FEX-Emu 构建完成"

      - name: 安装构建依赖（修复版本）
        run: |
          sudo apt update
          # 修复包依赖问题
          sudo apt --fix-broken install -y
          sudo apt install -f -y
          
          # 基础构建依赖 - ARM64 专用（使用更新的包名）
          BASE_DEPS="\
            debootstrap \
            perl \
            git \
            wget \
            xz-utils \
            bubblewrap \
            autoconf \
            flex \
            bison \
            gcc \
            g++ \
            libx11-dev \
            libxext-dev \
            libxi-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxfixes-dev \
            libxxf86vm-dev \
            libxrender-dev \
            libxinerama-dev \
            libgl-dev \
            libsdl2-dev \
            libglu-dev \
            libosmesa6-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libpcap-dev \
            libdbus-1-dev \
            libssl-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            libcups2-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libxml2-dev \
            libvulkan-dev \
            vulkan-tools \
            libvulkan1 \
            mesa-vulkan-drivers \
            gettext \
            libgettextpo-dev \
            locales \
            language-pack-zh-hans"
          
          # 逐个安装包以避免依赖冲突
          for pkg in $BASE_DEPS; do
            echo "安装包: $pkg"
            sudo apt install -y --allow-downgrades --allow-remove-essential --allow-change-held-packages "$pkg" || echo "跳过有问题的包: $pkg"
          done

      - name: 安装多媒体和音频依赖
        run: |
            sudo apt update
            # 安装完整的 GStreamer - 使用更安全的安装方式
            MULTIMEDIA_DEPS="\
              libunwind-dev \
              libgstreamer1.0-dev \
              libgstreamer-plugins-base1.0-dev \
              libgstreamer-plugins-good1.0-dev \
              libgstreamer-plugins-bad1.0-dev \
              gstreamer1.0-* \
              libmpg123-dev \
              libopenal-dev \
              libfaad-dev \
              libflac-dev \
              libvorbis-dev \
              libx264-dev \
              libx265-dev \
              libvpx-dev \
              libtheora-dev"

            for pkg in $MULTIMEDIA_DEPS; do
              echo "安装多媒体包: $pkg"
              sudo apt install -y --allow-downgrades --allow-remove-essential --allow-change-held-packages "$pkg" || echo "跳过有问题的包: $pkg"
            done

      - name: 设置中文语言环境
        run: |
          sudo locale-gen zh_CN.UTF-8
          sudo update-locale LANG=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8

      - name: 设置编译环境
        run: |
          # 设置更宽松的 ulimit
          ulimit -s unlimited
          ulimit -n 65536
          
          # 显示系统资源
          echo "系统资源:"
          free -h
          df -h
          nproc
          cat /proc/meminfo | grep MemTotal

      - name: 构建 Wine ARM64 WOW64 版本
        run: |
          set -e
          
          # 设置环境变量
          export WINE_BRANCH="${{ github.event.inputs.wine_branch || 'staging' }}"
          export WINE_VERSION="${{ github.event.inputs.wine_version || 'latest' }}"
          export BUILD_DIR="/tmp/build_wine_${WINE_BRANCH}_${WINE_VERSION}"
          
          echo "开始构建 Wine ARM64 WOW64 版本..."
          echo "分支: $WINE_BRANCH"
          echo "版本: $WINE_VERSION"
          
          # 设置中文构建环境
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANGUAGE=zh_CN:zh:en_US:en
          
          # 清理并创建构建目录
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"
          
          # 根据分支获取 Wine 源码
          if [ "$WINE_BRANCH" = "staging-tkg" ] || [ "$WINE_BRANCH" = "staging-tkg-fsync" ]; then
            # TKG 系列处理
            echo "处理 TKG 系列分支: $WINE_BRANCH"
            
            if [ "$WINE_BRANCH" = "staging-tkg" ]; then
              git clone --depth=1 https://github.com/Kron4ek/wine-tkg.git wine-tkg
              SOURCE_DIR="wine-tkg"
            else
              git clone --depth=1 --branch fsync https://github.com/Kron4ek/wine-tkg.git wine-tkg
              SOURCE_DIR="wine-tkg"
            fi
            
            cd "$SOURCE_DIR"
            
            if [ "$WINE_VERSION" != "latest" ]; then
              if git checkout "$WINE_VERSION" 2>/dev/null || git checkout "wine-$WINE_VERSION" 2>/dev/null; then
                echo "成功切换到版本 $WINE_VERSION"
              else
                echo "使用默认分支"
              fi
            fi
            
            if [ -f "VERSION" ]; then
              WINE_VERSION_ACTUAL="$(cat VERSION | tail -c +14)"
              echo "从 VERSION 文件获取版本: $WINE_VERSION_ACTUAL"
            else
              WINE_VERSION_ACTUAL=$(git describe --tags --abbrev=0 2>/dev/null || echo "$WINE_VERSION")
              echo "从 git 标签获取版本: $WINE_VERSION_ACTUAL"
            fi
            
            COMMIT_HASH=$(git rev-parse --short HEAD)
            BUILD_NAME="wine-${WINE_VERSION_ACTUAL}-${WINE_BRANCH}-arm64-wow64"
            
          elif [ "$WINE_BRANCH" = "staging" ]; then
            # staging 分支处理
            echo "处理 Staging 分支"
            git clone --depth=1 https://github.com/wine-mirror/wine.git wine
            SOURCE_DIR="wine"
            cd "$SOURCE_DIR"
            
            git config advice.detachedHead false
            
            if [ "$WINE_VERSION" != "latest" ]; then
              git checkout "wine-$WINE_VERSION"
            fi
            WINE_VERSION_ACTUAL=$(git describe --tags --abbrev=0 2>/dev/null || echo "$WINE_VERSION")
            COMMIT_HASH=$(git rev-parse --short HEAD)
            BUILD_NAME="wine-${WINE_VERSION_ACTUAL}-${COMMIT_HASH}-staging-arm64-wow64"
            
            # 应用 staging 补丁
            PURE_VERSION=$(echo "$WINE_VERSION_ACTUAL" | sed 's/^wine-//')
            STAGING_VERSION="v${PURE_VERSION}"
            echo "尝试下载 staging 补丁版本: $STAGING_VERSION"
            
            wget -O "wine-staging-${PURE_VERSION}.tar.gz" "https://github.com/wine-staging/wine-staging/archive/refs/tags/${STAGING_VERSION}.tar.gz" || \
            wget -O "wine-staging-${PURE_VERSION}.tar.gz" "https://github.com/wine-staging/wine-staging/archive/refs/tags/v${PURE_VERSION}.tar.gz"
            
            if [ -f "wine-staging-${PURE_VERSION}.tar.gz" ]; then
              tar -xzf "wine-staging-${PURE_VERSION}.tar.gz"
              
              STAGING_DIR=$(find . -maxdepth 1 -type d -name "*staging*" | head -1)
              if [ -n "$STAGING_DIR" ] && [ -d "$STAGING_DIR/staging" ]; then
                echo "找到 staging 目录: $STAGING_DIR"
                cd "$STAGING_DIR/staging"
                chmod +x patchinstall.py
                ./patchinstall.py --all --destdir=../../
                cd "../.."
              else
                echo "❌ 错误：无法找到 staging 补丁目录，跳过补丁应用"
              fi
            else
              echo "警告: 无法下载 staging 补丁，继续构建无补丁版本"
            fi
            
          elif [ "$WINE_BRANCH" = "vanilla" ]; then
            # vanilla 分支处理
            echo "处理 Vanilla 分支"
            git clone --depth=1 https://github.com/wine-mirror/wine.git wine
            SOURCE_DIR="wine"
            cd "$SOURCE_DIR"
            
            git config advice.detachedHead false
            
            if [ "$WINE_VERSION" != "latest" ]; then
              git checkout "wine-$WINE_VERSION"
            fi
            WINE_VERSION_ACTUAL=$(git describe --tags --abbrev=0 2>/dev/null || echo "$WINE_VERSION")
            COMMIT_HASH=$(git rev-parse --short HEAD)
            BUILD_NAME="wine-${WINE_VERSION_ACTUAL}-${COMMIT_HASH}-vanilla-arm64-wow64"
            
          else
            echo "未知的 Wine 分支: $WINE_BRANCH"
            exit 1
          fi
          
          echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV
          echo "当前源码目录: $(pwd)"
          echo "构建名称: $BUILD_NAME"
          
          # 应用版本特定的修复
          PURE_VERSION=$(echo "$WINE_VERSION_ACTUAL" | sed 's/^wine-//')
          VERSION_MAJOR=$(echo "$PURE_VERSION" | cut -d. -f1)
          VERSION_MINOR=$(echo "$PURE_VERSION" | cut -d. -f2)
          
          echo "Wine 版本: $WINE_VERSION_ACTUAL"
          echo "纯版本号: $PURE_VERSION"
          echo "主版本: $VERSION_MAJOR, 次版本: $VERSION_MINOR"
          
          # 判断版本是否 >= 9.10
          if [ "$VERSION_MAJOR" -gt 9 ] || [ "$VERSION_MAJOR" -eq 9 -a "$VERSION_MINOR" -ge 10 ]; then
            echo "使用 9.10+ 版本的修复方式 (wine_do_not_create_dxgi_manager2.patch)"
            wget https://github.com/afeimod/linbox/raw/main/path/wine_do_not_create_dxgi_manager2.patch
            if [ -f "dlls/mfplat/main.c" ]; then
              echo "找到目标文件 dlls/mfplat/main.c，准备应用补丁..."
              if patch -p1 < wine_do_not_create_dxgi_manager2.patch; then
                echo "✅ 补丁应用成功"
              else
                echo "❌ 补丁应用失败"
                exit 1
              fi
            else
              echo "❌ 错误：目标文件 dlls/mfplat/main.c 不存在"
              exit 1
            fi
          else
            echo "使用 9.10 以下版本的修复方式 (fix_wine9.2_mfplat.sh)"
            wget -O fix_wine9.2_mfplat.sh https://github.com/afeimod/linbox/raw/main/path/fix_wine9.2_mfplat.sh
            chmod +x fix_wine9.2_mfplat.sh
            ./fix_wine9.2_mfplat.sh
            echo "✅ 9.10 以下版本修复完成"
          fi
          
          # 配置和构建 ARM64 WOW64 Wine
          mkdir -p build-arm64
          cd build-arm64
          
          # 使用 FEX spec 中的优化编译标志
          export CFLAGS="-march=armv8-a -O3 -g -pipe -Wall -Wextra -fPIC"
          export CXXFLAGS="-march=armv8-a -O3 -g -pipe -Wall -Wextra -fPIC"
          export MAKEFLAGS="-j2"

          ../configure \
            --build=aarch64-linux-gnu \
            --host=aarch64-linux-gnu \
            --prefix=/tmp/wine-install-arm64 \
            --enable-win64 \
            --with-x \
            --with-alsa \
            --with-pulse \
            --with-freetype \
            --with-fontconfig \
            --with-gstreamer \
            --with-gettext \
            --with-sdl \
            --enable-nls \
            --disable-winemenubuilder \
            --disable-win16 \
            --disable-tests \
            --without-ldap \
            --without-capi \
            --without-oss \
            --without-cups \
            --without-dbus \
            --without-coreaudio \
            --without-gphoto \
            --without-osmesa \
            --without-sane \
            --without-pcap \
            --without-pcsclite \
            --without-udev \
            --without-unwind \
            --without-usb \
            --without-v4l2 \
            --without-wayland
          
          echo "开始编译 ARM64 WOW64 Wine..."
          for target in all install; do
            make $target -j2 || make $target -j1
          done

      - name: 集成 FEX-Emu DLL
        run: |
          echo "集成 FEX-Emu DLL 到 Wine 安装目录..."
          if [ -d "/tmp/wine-install-arm64" ] && [ -d "/tmp/fex-install" ]; then
            mkdir -p /tmp/wine-install-arm64/lib/wine/aarch64-windows
            
            # 检查 FEX DLL 是否存在
            if [ -f "/tmp/fex-install/lib/wine/aarch64-windows/libwow64fex.dll" ]; then
              cp /tmp/fex-install/lib/wine/aarch64-windows/*.dll /tmp/wine-install-arm64/lib/wine/aarch64-windows/
              echo "FEX-Emu DLL 集成完成"
              ls -la /tmp/wine-install-arm64/lib/wine/aarch64-windows/
            else
              echo "警告: FEX-Emu DLL 不存在，跳过集成"
            fi
          else
            echo "警告: 无法找到 Wine 或 FEX-Emu 安装目录"
          fi

      - name: 检查安装目录
        run: |
          echo "检查安装目录内容:"
          if [ -d "/tmp/wine-install-arm64" ]; then
            find /tmp/wine-install-arm64 -type f | head -20 || echo "未找到文件"
            du -sh /tmp/wine-install-arm64 || echo "无法计算目录大小"
          else
            echo "安装目录 /tmp/wine-install-arm64 不存在"
          fi

      - name: 准备打包
        run: |
          # 创建打包目录
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          mkdir -p wine-package/$PACKAGE_NAME
          
          # 检查源目录是否存在
          if [ -d "/tmp/wine-install-arm64" ]; then
            echo "复制 Wine 文件到 $PACKAGE_NAME..."
            cp -r /tmp/wine-install-arm64/* wine-package/$PACKAGE_NAME/ || echo "复制文件时出现问题"
          else
            echo "错误: 源目录 /tmp/wine-install-arm64 不存在"
            exit 1
          fi

      - name: 创建打包文件
        run: |
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          
          echo "检查打包目录内容:"
          if [ -d "wine-package/$PACKAGE_NAME" ]; then
            echo "最终文件结构:"
            find "wine-package/$PACKAGE_NAME" -type f | head -20
            echo "目录大小:"
            du -sh "wine-package/$PACKAGE_NAME"
            
            # 使用 tar.xz 格式打包
            tar -cJf "$PACKAGE_NAME.tar.xz" -C wine-package "$PACKAGE_NAME"
            
            echo "打包完成:"
            ls -lh *.tar.xz
          else
            echo "错误: 打包目录 wine-package/$PACKAGE_NAME 不存在"
            exit 1
          fi

      - name: Generate checksums
        run: |
          cd $GITHUB_WORKSPACE
          sha256sum *.tar.xz > checksums.txt
          cat checksums.txt

      - name: Upload Wine ARM64 WoW64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Wine-${{ github.event.inputs.wine_branch || 'staging' }}-${{ github.event.inputs.wine_version || 'latest' }}-ARM64-WoW64
          path: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
          retention-days: 30

      - name: 发布 Wine 到 GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'wine-wow64'
        with:
          tag_name: wine-${{ github.event.inputs.wine_branch || 'staging' }}-${{ github.event.inputs.wine_version || 'latest' }}-arm64-wow64
          name: Wine ${{ github.event.inputs.wine_branch || 'staging' }} ${{ github.event.inputs.wine_version || 'latest' }} (ARM64 WOW64 with Vulkan & GStreamer for Termux)
          body: |
            # Wine ${{ github.event.inputs.wine_branch || 'staging' }} ${{ github.event.inputs.wine_version || 'latest' }} - ARM64 WOW64 with Vulkan & GStreamer for Termux
            
            ## 版本信息
            - **Wine 分支**: ${{ github.event.inputs.wine_branch || 'staging' }}
            - **Wine 版本**: ${{ github.event.inputs.wine_version || 'latest' }}
            - **架构**: ARM64 WOW64 (在 ARM64 设备上运行 32 位和 64 位 Windows 应用程序)
            - **平台**: Termux (Android ARM64)
            - **图形 API**: Vulkan 支持已启用
            - **多媒体**: 完整 GStreamer 支持
            
            ## 特性
            ✓ ARM64 原生架构
            ✓ WOW64 支持 (在 ARM64 上运行 32 位和 64 位 Windows 应用程序)
            ✓ Vulkan 图形 API 支持
            ✓ 完整的 GStreamer 支持
            ✓ 中文环境支持
            ✓ 应用了关键补丁提升兼容性
            ✓ 针对 ARM64 架构优化编译
            
            ## FEX-Emu 状态
            - WOW64 仿真支持已集成
            - ARM64EC 支持: 当前版本中 ARM64EC 构建失败，已跳过
            
            ## 安装说明
            解压后，将 `${{ env.BUILD_NAME }}` 文件夹放置在 Termux 的合适位置，并设置环境变量。

            ## 构建信息
            - 构建时间: ${{ github.event.head_commit.timestamp }}
            - 提交: ${{ github.sha }}
            - 工作流: ${{ github.workflow }}
          files: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
name: Wine and Proton Builder

on:
  schedule:
    # Proton 构建 - 每月1号和15号
    - cron: '0 0 1,15 * *'
    # Wine 构建 - 每月5号和20号
    - cron: '0 2 5,20 * *'
  workflow_dispatch:
    inputs:
      build_type:
        description: '选择构建类型'
        required: true
        default: 'proton'
        type: choice
        options:
        - proton
        - wine-wow64
      proton_branch:
        description: 'Proton 分支 (仅 Proton 构建)'
        required: false
        default: 'proton_10.0'
        type: choice
        options:
        - proton_10.0
        - experimental_10.0
        - bleeding-edge
      wine_branch:
        description: 'Wine 分支 (仅 Wine 构建)'
        required: false
        default: 'staging'
        type: choice
        options:
        - vanilla
        - staging
        - staging-tkg
        - staging-tkg-fsync
      wine_version:
        description: 'Wine 版本 (仅 Wine 构建)'
        required: false
        default: 'latest'
        type: string

env:
  USE_CCACHE: true
  BUILD_DIR: /tmp/build_wine
  BOOTSTRAP_DIR: /opt/chroots

jobs:
  build-proton:
    runs-on: ubuntu-24.04
    if: github.event.inputs.build_type == 'proton' || (github.event_name == 'schedule' && github.event.schedule == '0 0 1,15 * *')
    timeout-minutes: 180
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 安装基础依赖
        run: |
          sudo apt update
          sudo apt install -y \
            wget curl unzip xz-utils \
            proot qemu-user-static binfmt-support \
            git make automake autoconf \
            gcc g++ gcc-multilib g++-multilib

      - name: 下载并设置 Bootstrap 环境
        run: |
          set -e
          
          # 创建目录
          sudo mkdir -p ${{ env.BOOTSTRAP_DIR }}
          sudo chmod 755 ${{ env.BOOTSTRAP_DIR }}
          
          echo "下载 bootstrap..."
          wget -O /tmp/bootstraps.tar.xz "https://github.com/afeimod/Debian-proot/releases/download/v1.0.0/bootstraps.tar.xz"
          
          # 找到并解压 bootstraps.tar.xz
          echo "查找 bootstraps.tar.xz..."
          BOOTSTRAP_TAR=$(find /tmp -name "bootstraps.tar.xz" -o -name "*.tar.xz" | head -1)
          if [ -z "$BOOTSTRAP_TAR" ]; then
            echo "错误: 未找到 bootstraps.tar.xz 文件"
            ls -la /tmp/
            exit 1
          fi
          
          echo "找到 bootstrap 文件: $BOOTSTRAP_TAR"
          echo "解压到 ${{ env.BOOTSTRAP_DIR }}..."
          sudo tar -xf "$BOOTSTRAP_TAR" -C ${{ env.BOOTSTRAP_DIR }}/
          
          # 查找解压后的目录
          BOOTSTRAP_ROOT=$(find ${{ env.BOOTSTRAP_DIR }} -maxdepth 1 -type d -name "*bootstrap*" | head -1)
          if [ -z "$BOOTSTRAP_ROOT" ]; then
            BOOTSTRAP_ROOT=$(find ${{ env.BOOTSTRAP_DIR }} -maxdepth 1 -type d | grep -v "^${{ env.BOOTSTRAP_DIR }}$" | head -1)
          fi
          
          if [ -n "$BOOTSTRAP_ROOT" ]; then
            echo "Bootstrap 根目录: $BOOTSTRAP_ROOT"
            echo "BOOTSTRAP_ROOT=$BOOTSTRAP_ROOT" >> $GITHUB_ENV
          else
            echo "错误: 无法找到 bootstrap 根目录"
            ls -la ${{ env.BOOTSTRAP_DIR }}
            exit 1
          fi
          
          # 设置权限
          sudo chmod -R 755 $BOOTSTRAP_ROOT

      - name: 在 Bootstrap 环境中安装构建依赖
        run: |
          set -e
          
          echo "在 bootstrap 环境中安装构建依赖..."
          
          # 准备安装脚本
          cat > /tmp/install_deps.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "更新包管理器..."
          apt update || true
          
          echo "安装构建依赖..."
          apt install -y \
            debootstrap \
            perl \
            git \
            wget \
            xz-utils \
            bubblewrap \
            autoconf \
            flex \
            bison \
            gcc-multilib \
            g++-multilib \
            libx11-dev \
            libxext-dev \
            libxi-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxfixes-dev \
            libxxf86vm-dev \
            libxrender-dev \
            libxinerama-dev \
            libgl-dev \
            libsdl2-dev \
            libglu-dev \
            libosmesa6-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libpcap-dev \
            libdbus-1-dev \
            libssl-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            libcups2-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libxml2-dev \
            libvulkan-dev \
            vulkan-tools \
            libvulkan1 \
            mesa-vulkan-drivers \
            mingw-w64 \
            gettext \
            libgettextpo-dev \
            locales \
            language-pack-zh-hans \
            libunwind-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-good1.0-dev \
            libgstreamer-plugins-bad1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-libav \
            libmpg123-dev \
            libopenal-dev
          
          echo "设置中文语言环境..."
          locale-gen zh_CN.UTF-8
          update-locale LANG=zh_CN.UTF-8
          
          echo "依赖安装完成"
          EOF
          
          chmod +x /tmp/install_deps.sh
          
          # 在 bootstrap 环境中运行安装脚本
          proot -r ${{ env.BOOTSTRAP_ROOT }} -b /tmp:/tmp -b /dev:/dev -b /proc:/proc -b /sys:/sys \
            /bin/bash /tmp/install_deps.sh

      - name: 在 Bootstrap 环境中构建 Proton WOW64
        run: |
          set -e
          
          PROTON_BRANCH="${{ github.event.inputs.proton_branch || 'proton_10.0' }}"
          echo "开始在 bootstrap 环境中构建 Proton WOW64..."
          echo "分支: $PROTON_BRANCH"
          
          # 准备构建脚本
          cat > /tmp/build_proton.sh << 'EOF'
          #!/bin/bash
          set -e
          
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANGUAGE=zh_CN:zh:en_US:en
          
          BUILD_DIR="/tmp/build_proton"
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"
          
          # 克隆 Proton 源码
          git clone https://github.com/ValveSoftware/wine
          cd wine
          git checkout $PROTON_BRANCH
          
          # 修复 Termux 路径问题
          echo "修复 Termux 路径问题..."
          find . -type f \( -name "*.c" -o -name "*.h" -o -name "*.in" -o -name "*.spec" \) -exec grep -l "/tmp" {} \; | xargs sed -i 's|/tmp/|/data/data/com.termux/files/usr/tmp/|g'
          find server -type f \( -name "*.c" -o -name "*.h" \) -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          find . -name "file.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          find . -name "loader.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          find . -name "server.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          
          echo "路径修复完成"
          
          # 生成 configure 脚本
          ./autogen.sh
          
          # 配置和构建 WOW64
          mkdir -p build-wow64
          cd build-wow64
          
          export CROSSCC="x86_64-w64-mingw32-gcc"
          export CROSSCXX="x86_64-w64-mingw32-g++"
          export CFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          export CXXFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          export CROSSCFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          export CROSSCXXFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"

          ../configure \
            --enable-win64 \
            --enable-archs=i386,x86_64 \
            --prefix=/tmp/wine-install-proton \
            --with-x \
            --with-vulkan \
            --with-alsa \
            --with-pulse \
            --with-freetype \
            --with-fontconfig \
            --with-gstreamer \
            --with-gettext \
            --with-sdl \
            --enable-nls \
            --disable-winemenubuilder \
            --disable-win16 \
            --disable-tests \
            --without-ldap \
            --without-capi \
            --without-oss \
            --without-cups \
            --without-dbus \
            --without-coreaudio \
            --without-gphoto \
            --without-osmesa \
            --without-sane \
            --without-pcap \
            --without-pcsclite \
            --without-udev \
            --without-unwind \
            --without-usb \
            --without-v4l2 \
            --without-wayland

          make -j$(nproc)
          make install
          
          # 获取版本信息
          VERSION_PROTON=$(git describe --tags --abbrev=0 2>/dev/null || echo "$PROTON_BRANCH")
          COMMIT_HASH=$(git rev-parse --short HEAD)
          PROTON_VERSION="${VERSION_PROTON}-${COMMIT_HASH}"
          echo "PROTON_VERSION=$PROTON_VERSION" > /tmp/proton_version
          echo "BUILD_NAME=proton-${PROTON_VERSION}-wow64" >> /tmp/proton_version
          
          echo "Proton 构建完成: $PROTON_VERSION"
          EOF
          
          chmod +x /tmp/build_proton.sh
          
          # 设置环境变量传递给脚本
          echo "PROTON_BRANCH=$PROTON_BRANCH" > /tmp/proton_env
          
          # 在 bootstrap 环境中运行构建脚本
          proot -r ${{ env.BOOTSTRAP_ROOT }} -b /tmp:/tmp -b /dev:/dev -b /proc:/proc -b /sys:/sys \
            -w /tmp \
            /bin/bash /tmp/build_proton.sh
          
          # 读取版本信息
          source /tmp/proton_version
          echo "PROTON_VERSION=$PROTON_VERSION" >> $GITHUB_ENV
          echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV

      - name: 准备打包 Proton
        run: |
          set -e
          
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          mkdir -p wine-package/$PACKAGE_NAME
          
          # 从 bootstrap 环境中复制构建结果
          echo "复制构建结果..."
          proot -r ${{ env.BOOTSTRAP_ROOT }} -b $(pwd)/wine-package/$PACKAGE_NAME:/mnt/package \
            cp -r /tmp/wine-install-proton/* /mnt/package/

      - name: 创建 Proton 打包文件
        run: |
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          
          echo "打包 Proton WOW64..."
          tar -cJf $PACKAGE_NAME.tar.xz -C wine-package $PACKAGE_NAME
          
          echo "打包完成:"
          ls -lh *.tar.xz

      - name: Generate checksums
        run: |
          cd $GITHUB_WORKSPACE
          sha256sum *.tar.xz > checksums.txt
          cat checksums.txt

      - name: Upload Proton artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Proton-${{ github.event.inputs.proton_branch || 'proton_10.0' }}-WoW64
          path: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
          retention-days: 30

  build-wine-wow64:
    runs-on: ubuntu-24.04
    if: github.event.inputs.build_type == 'wine-wow64' || (github.event_name == 'schedule' && github.event.schedule == '0 2 5,20 * *')
    timeout-minutes: 180
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 安装基础依赖
        run: |
          sudo apt update
          sudo apt install -y \
            wget curl unzip xz-utils \
            proot qemu-user-static binfmt-support \
            git make automake autoconf \
            gcc g++ gcc-multilib g++-multilib

      - name: 下载并设置 Bootstrap 环境
        run: |
          set -e
          
          # 创建目录
          sudo mkdir -p ${{ env.BOOTSTRAP_DIR }}
          sudo chmod 755 ${{ env.BOOTSTRAP_DIR }}
          
          echo "下载 bootstrap..."
          wget -O /tmp/bootstraps.tar.xz "https://github.com/afeimod/Debian-proot/releases/download/v1.0.0/bootstraps.tar.xz"
          # 找到并解压 bootstraps.tar.xz
          echo "查找 bootstraps.tar.xz..."
          BOOTSTRAP_TAR=$(find /tmp -name "bootstraps.tar.xz" -o -name "*.tar.xz" | head -1)
          if [ -z "$BOOTSTRAP_TAR" ]; then
            echo "错误: 未找到 bootstraps.tar.xz 文件"
            ls -la /tmp/
            exit 1
          fi
          
          echo "找到 bootstrap 文件: $BOOTSTRAP_TAR"
          echo "解压到 ${{ env.BOOTSTRAP_DIR }}..."
          sudo tar -xf "$BOOTSTRAP_TAR" -C ${{ env.BOOTSTRAP_DIR }}/
          
          # 查找解压后的目录
          BOOTSTRAP_ROOT=$(find ${{ env.BOOTSTRAP_DIR }} -maxdepth 1 -type d -name "*bootstrap*" | head -1)
          if [ -z "$BOOTSTRAP_ROOT" ]; then
            BOOTSTRAP_ROOT=$(find ${{ env.BOOTSTRAP_DIR }} -maxdepth 1 -type d | grep -v "^${{ env.BOOTSTRAP_DIR }}$" | head -1)
          fi
          
          if [ -n "$BOOTSTRAP_ROOT" ]; then
            echo "Bootstrap 根目录: $BOOTSTRAP_ROOT"
            echo "BOOTSTRAP_ROOT=$BOOTSTRAP_ROOT" >> $GITHUB_ENV
          else
            echo "错误: 无法找到 bootstrap 根目录"
            ls -la ${{ env.BOOTSTRAP_DIR }}
            exit 1
          fi
          
          # 设置权限
          sudo chmod -R 755 $BOOTSTRAP_ROOT

      - name: 在 Bootstrap 环境中安装构建依赖
        run: |
          set -e
          
          echo "在 bootstrap 环境中安装构建依赖..."
          
          # 准备安装脚本
          cat > /tmp/install_deps.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "更新包管理器..."
          apt update || true
          
          echo "安装构建依赖..."
          apt install -y \
            debootstrap \
            perl \
            git \
            wget \
            xz-utils \
            bubblewrap \
            autoconf \
            flex \
            bison \
            gcc-multilib \
            g++-multilib \
            libx11-dev \
            libxext-dev \
            libxi-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxfixes-dev \
            libxxf86vm-dev \
            libxrender-dev \
            libxinerama-dev \
            libgl-dev \
            libsdl2-dev \
            libglu-dev \
            libosmesa6-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libpcap-dev \
            libdbus-1-dev \
            libssl-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            libcups2-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libxml2-dev \
            libvulkan-dev \
            vulkan-tools \
            libvulkan1 \
            mesa-vulkan-drivers \
            mingw-w64 \
            gettext \
            libgettextpo-dev \
            locales \
            language-pack-zh-hans \
            libunwind-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-good1.0-dev \
            libgstreamer-plugins-bad1.0-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-libav \
            libmpg123-dev \
            libopenal-dev
          
          echo "设置中文语言环境..."
          locale-gen zh_CN.UTF-8
          update-locale LANG=zh_CN.UTF-8
          
          echo "依赖安装完成"
          EOF
          
          chmod +x /tmp/install_deps.sh
          
          # 在 bootstrap 环境中运行安装脚本
          proot -r ${{ env.BOOTSTRAP_ROOT }} -b /tmp:/tmp -b /dev:/dev -b /proc:/proc -b /sys:/sys \
            /bin/bash /tmp/install_deps.sh

      - name: 在 Bootstrap 环境中构建 Wine WOW64
        run: |
          set -e
          
          export WINE_BRANCH="${{ github.event.inputs.wine_branch || 'staging' }}"
          export WINE_VERSION="${{ github.event.inputs.wine_version || 'latest' }}"
          
          echo "开始在 bootstrap 环境中构建 Wine WOW64..."
          echo "分支: $WINE_BRANCH"
          echo "版本: $WINE_VERSION"
          
          # 准备构建脚本
          cat > /tmp/build_wine.sh << 'EOF'
          #!/bin/bash
          set -e
          
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANGUAGE=zh_CN:zh:en_US:en
          
          BUILD_DIR="/tmp/build_wine"
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"
          
          # 根据分支获取 Wine 源码
          if [ "$WINE_BRANCH" = "staging-tkg" ] || [ "$WINE_BRANCH" = "staging-tkg-fsync" ]; then
            if [ "$WINE_BRANCH" = "staging-tkg" ]; then
              git clone --depth=1 https://github.com/Kron4ek/wine-tkg wine
            else
              git clone --depth=1 https://github.com/Kron4ek/wine-tkg wine -b fsync
            fi
            WINE_VERSION_ACTUAL="$(cat wine/VERSION | tail -c +14)"
            BUILD_NAME="wine-${WINE_VERSION_ACTUAL}-${WINE_BRANCH}-wow64"
          elif [ "$WINE_BRANCH" = "staging" ]; then
            git clone https://github.com/wine-mirror/wine.git wine
            if [ "$WINE_VERSION" != "latest" ]; then
              cd wine
              git checkout wine-$WINE_VERSION
              cd ..
            fi
            WINE_VERSION_ACTUAL=$(cd wine && git describe --tags --abbrev=0 2>/dev/null || echo "$WINE_VERSION")
            BUILD_NAME="wine-${WINE_VERSION_ACTUAL}-staging-wow64"
            
            # 下载并应用 staging 补丁
            cd wine
            STAGING_VERSION="$WINE_VERSION_ACTUAL"
            wget -O wine-staging-$STAGING_VERSION.tar.gz https://github.com/wine-staging/wine-staging/archive/refs/tags/v$STAGING_VERSION.tar.gz
            tar -xzf wine-staging-$STAGING_VERSION.tar.gz
            
            # 应用 staging 补丁
            cd wine-staging-$STAGING_VERSION/staging
            chmod +x patchinstall.py
            ./patchinstall.py --all --destdir=../../
            cd ../..
            
          elif [ "$WINE_BRANCH" = "vanilla" ]; then
            git clone https://github.com/wine-mirror/wine.git wine
            if [ "$WINE_VERSION" != "latest" ]; then
              cd wine
              git checkout wine-$WINE_VERSION
              cd ..
            fi
            WINE_VERSION_ACTUAL=$(cd wine && git describe --tags --abbrev=0 2>/dev/null || echo "$WINE_VERSION")
            BUILD_NAME="wine-${WINE_VERSION_ACTUAL}-vanilla-wow64"
          else
            echo "未知的 Wine 分支: $WINE_BRANCH"
            exit 1
          fi
          
          cd wine
          
          # 修复 Termux 路径问题
          echo "修复 Termux 路径问题..."
          find . -type f \( -name "*.c" -o -name "*.h" -o -name "*.in" -o -name "*.spec" \) -exec grep -l "/tmp" {} \; | xargs sed -i 's|/tmp/|/data/data/com.termux/files/usr/tmp/|g'
          find server -type f \( -name "*.c" -o -name "*.h" \) -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          find . -name "file.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          find . -name "loader.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          find . -name "server.c" -exec sed -i 's|"/tmp"|"/data/data/com.termux/files/usr/tmp"|g' {} +
          
          echo "路径修复完成"
          
          # 根据版本选择修复方式
          VERSION_MAJOR=$(echo $WINE_VERSION_ACTUAL | cut -d. -f1)
          VERSION_MINOR=$(echo $WINE_VERSION_ACTUAL | cut -d. -f2)
          
          echo "Wine 版本: $WINE_VERSION_ACTUAL"
          echo "主版本: $VERSION_MAJOR, 次版本: $VERSION_MINOR"
          
          # 判断版本是否 >= 9.10
          if [ $VERSION_MAJOR -gt 9 ] || [ $VERSION_MAJOR -eq 9 -a $VERSION_MINOR -ge 10 ]; then
              echo "使用 9.10+ 版本的修复方式 (wine_do_not_create_dxgi_manager2.patch)"
              wget https://github.com/afeimod/linbox/raw/main/path/wine_do_not_create_dxgi_manager2.patch
              if [ -f "dlls/mfplat/main.c" ]; then
                  echo "找到目标文件 dlls/mfplat/main.c，准备应用补丁..."
                  if patch -p1 < wine_do_not_create_dxgi_manager2.patch; then
                      echo "✅ 补丁应用成功"
                  else
                      echo "❌ 补丁应用失败"
                      exit 1
                  fi
              else
                  echo "❌ 错误：目标文件 dlls/mfplat/main.c 不存在"
                  exit 1
              fi
          else
              echo "使用 9.10 以下版本的修复方式 (fix_wine9.2_mfplat.sh)"
              wget -O fix_wine9.2_mfplat.sh https://github.com/afeimod/linbox/raw/main/path/fix_wine9.2_mfplat.sh
              chmod +x fix_wine9.2_mfplat.sh
              ./fix_wine9.2_mfplat.sh
              echo "✅ 9.10 以下版本修复完成"
          fi
          
          # 生成 configure 脚本
          ./autogen.sh
          
          # 配置和构建 WOW64
          mkdir -p build-wow64
          cd build-wow64
          
          export CROSSCC="x86_64-w64-mingw32-gcc"
          export CROSSCXX="x86_64-w64-mingw32-g++"
          export CFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          export CXXFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          export CROSSCFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"
          export CROSSCXXFLAGS="-march=x86-64 -msse3 -mfpmath=sse -O3 -ftree-vectorize -pipe"

          ../configure \
            --enable-win64 \
            --enable-archs=i386,x86_64 \
            --prefix=/tmp/wine-install-wow64 \
            --with-x \
            --with-vulkan \
            --with-alsa \
            --with-pulse \
            --with-freetype \
            --with-fontconfig \
            --with-gstreamer \
            --with-gettext \
            --with-sdl \
            --enable-nls \
            --disable-winemenubuilder \
            --disable-win16 \
            --disable-tests \
            --without-ldap \
            --without-capi \
            --without-oss \
            --without-cups \
            --without-dbus \
            --without-coreaudio \
            --without-gphoto \
            --without-osmesa \
            --without-sane \
            --without-pcap \
            --without-pcsclite \
            --without-udev \
            --without-unwind \
            --without-usb \
            --without-v4l2 \
            --without-wayland

          make -j$(nproc)
          make install
          
          echo "BUILD_NAME=$BUILD_NAME" > /tmp/wine_build_info
          echo "WINE_VERSION_ACTUAL=$WINE_VERSION_ACTUAL" >> /tmp/wine_build_info
          
          echo "Wine 构建完成: $BUILD_NAME"
          EOF
          
          chmod +x /tmp/build_wine.sh
          
          # 设置环境变量传递给脚本
          echo "WINE_BRANCH=$WINE_BRANCH" > /tmp/wine_env
          echo "WINE_VERSION=$WINE_VERSION" >> /tmp/wine_env
          
          # 在 bootstrap 环境中运行构建脚本
          proot -r ${{ env.BOOTSTRAP_ROOT }} -b /tmp:/tmp -b /dev:/dev -b /proc:/proc -b /sys:/sys \
            -w /tmp \
            /bin/bash /tmp/build_wine.sh
          
          # 读取构建信息
          source /tmp/wine_build_info
          echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV
          echo "WINE_VERSION_ACTUAL=$WINE_VERSION_ACTUAL" >> $GITHUB_ENV

      - name: 准备打包 Wine
        run: |
          set -e
          
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          mkdir -p wine-package/$PACKAGE_NAME
          
          # 从 bootstrap 环境中复制构建结果
          echo "复制构建结果..."
          proot -r ${{ env.BOOTSTRAP_ROOT }} -b $(pwd)/wine-package/$PACKAGE_NAME:/mnt/package \
            cp -r /tmp/wine-install-wow64/* /mnt/package/

      - name: 创建 Wine 打包文件
        run: |
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          
          echo "打包 Wine WOW64..."
          tar -cJf $PACKAGE_NAME.tar.xz -C wine-package $PACKAGE_NAME
          
          echo "打包完成:"
          ls -lh *.tar.xz

      - name: Generate checksums
        run: |
          cd $GITHUB_WORKSPACE
          sha256sum *.tar.xz > checksums.txt
          cat checksums.txt

      - name: Upload Wine WoW64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Wine-${{ github.event.inputs.wine_branch || 'staging' }}-${{ github.event.inputs.wine_version || 'latest' }}-WoW64
          path: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
          retention-days: 30
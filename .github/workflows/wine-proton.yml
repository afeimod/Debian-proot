name: Proton Builds

on:
  schedule:
    - cron: '0 0 1,15 * *'
  workflow_dispatch:
    inputs:
      proton_branch:
        description: 'Proton branch to build'
        required: true
        default: 'proton_10.0'
        type: choice
        options:
        - proton_10.0
        - experimental_10.0
        - bleeding-edge

env:
  WINE_BRANCH: proton
  USE_CCACHE: true
  BUILD_DIR: /tmp/build_proton

jobs:
  check-bootstraps:
    runs-on: ubuntu-22.04
    outputs:
      bootstraps-exist: ${{ steps.check.outputs.exists }}
    steps:
      - name: Check if bootstraps artifact exists
        id: check
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: bootstraps.yml
          workflow_conclusion: success
          path: /tmp/check
          skip_unpack: true
        continue-on-error: true

  create-bootstraps-if-needed:
    runs-on: ubuntu-22.04
    needs: check-bootstraps
    if: needs.check-bootstraps.outputs.bootstraps-exist != 'true'
    steps:
      - name: Create bootstraps
        uses: ./.github/workflows/bootstraps.yml
        with:
          wait-for-completion: true

  build-proton:
    runs-on: ubuntu-22.04
    needs: [check-bootstraps, create-bootstraps-if-needed]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download bootstraps
        id: download-artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: bootstraps.yml
          workflow_conclusion: success
          path: /opt
      
      - name: Install dependencies
        run: |
            sudo apt update
            sudo apt install -y debootstrap perl git wget xz-utils bubblewrap autoconf \
              ccache gcc-11 g++-11 i686-w64-mingw32-gcc x86_64-w64-mingw32-gcc \
              make flex bison gettext libfreetype6-dev libfontconfig1-dev \
              automake libtool pkg-config nasm yasm cmake ninja-build \
              libx11-dev libasound2-dev libpulse-dev libdbus-1-dev libudev-dev \
              libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev libsdl2-dev
      
      - name: Extract bootstraps
        run: |
          sudo tar -C /opt -xpf /opt/Bootstraps/bootstraps.tar.xz
          sudo chmod +x /opt/chroots/*
      
      - name: Build Proton
        run: |
          set -e
          
          # 设置环境变量
          export PROTON_BRANCH="${{ github.event.inputs.proton_branch || 'proton_10.0' }}"
          export BOOTSTRAP_X64=/opt/chroots/bionic64_chroot
          export BOOTSTRAP_X32=/opt/chroots/bionic32_chroot
          export BUILD_DIR="/tmp/build_proton_${PROTON_BRANCH}"
          
          # 设置编译器和标志
          export CC="gcc-11"
          export CXX="g++-11"
          export CROSSCC_X32="i686-w64-mingw32-gcc"
          export CROSSCXX_X32="i686-w64-mingw32-g++"
          export CROSSCC_X64="x86_64-w64-mingw32-gcc"
          export CROSSCXX_X64="x86_64-w64-mingw32-g++"
          
          export CFLAGS_X32="-march=i686 -msse2 -mfpmath=sse -O2 -ftree-vectorize"
          export CFLAGS_X64="-march=x86-64 -msse3 -mfpmath=sse -O2 -ftree-vectorize"
          export LDFLAGS="-Wl,-O1,--sort-common,--as-needed"
          
          export CROSSCFLAGS_X32="${CFLAGS_X32}"
          export CROSSCFLAGS_X64="${CFLAGS_X64}"
          export CROSSLDFLAGS="${LDFLAGS}"
          
          # 启用 ccache
          if [ "$USE_CCACHE" = "true" ]; then
            export CC="ccache ${CC}"
            export CXX="ccache ${CXX}"
            export CROSSCC_X32="ccache ${CROSSCC_X32}"
            export CROSSCXX_X32="ccache ${CROSSCXX_X32}"
            export CROSSCC_X64="ccache ${CROSSCC_X64}"
            export CROSSCXX_X64="ccache ${CROSSCXX_X64}"
          fi
          
          # 创建构建目录
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"
          
          # Bubblewrap 函数
          build_with_bwrap() {
            if [ "${1}" = "32" ]; then
              BOOTSTRAP_PATH="$BOOTSTRAP_X32"
            else
              BOOTSTRAP_PATH="$BOOTSTRAP_X64"
            fi
          
            if [ "${1}" = "32" ] || [ "${1}" = "64" ]; then
              shift
            fi
          
            bwrap --ro-bind "${BOOTSTRAP_PATH}" / --dev /dev --ro-bind /sys /sys \
              --proc /proc --tmpfs /tmp --tmpfs /home --tmpfs /run --tmpfs /var \
              --tmpfs /mnt --tmpfs /media --bind "${BUILD_DIR}" "${BUILD_DIR}" \
              --bind-try "${HOME}"/.ccache "${HOME}"/.ccache \
              --setenv PATH "/opt/mingw/x86_64/bin:/opt/mingw/i686/bin:/usr/local/bin:/bin:/sbin:/usr/bin:/usr/sbin" \
              "$@"
          }
          
          echo "下载 Proton 源代码..."
          
          # 克隆 Proton 源代码
          if [ -z "${PROTON_BRANCH}" ]; then
            git clone https://github.com/ValveSoftware/wine
          else
            git clone https://github.com/ValveSoftware/wine -b "${PROTON_BRANCH}"
          fi
          
          WINE_VERSION="$(cat wine/VERSION | tail -c +14)-$(git -C wine rev-parse --short HEAD)"
          if [[ "${PROTON_BRANCH}" == "experimental_"* ]] || [ "${PROTON_BRANCH}" = "bleeding-edge" ]; then
            BUILD_NAME=proton-exp-"${WINE_VERSION}"
          else
            BUILD_NAME=proton-"${WINE_VERSION}"
          fi
          
          echo "准备 Wine 源代码..."
          cd wine
          dlls/winevulkan/make_vulkan
          tools/make_requests
          tools/make_specfiles
          autoreconf -f
          cd ..
          
          # 构建 64 位
          echo "构建 64 位 Wine..."
          export CROSSCC="${CROSSCC_X64}"
          export CROSSCXX="${CROSSCXX_X64}"
          export CFLAGS="${CFLAGS_X64}"
          export CXXFLAGS="${CFLAGS_X64}"
          export CROSSCFLAGS="${CROSSCFLAGS_X64}"
          export CROSSCXXFLAGS="${CROSSCFLAGS_X64}"
          
          mkdir build64
          cd build64
          build_with_bwrap 64 ../wine/configure --enable-win64 --without-oss --disable-winemenubuilder --disable-tests --prefix "${BUILD_DIR}/wine-${BUILD_NAME}-amd64"
          build_with_bwrap 64 make -j$(nproc) install
          cd ..
          
          # 构建 32 位工具
          echo "构建 32 位工具..."
          export CROSSCC="${CROSSCC_X32}"
          export CROSSCXX="${CROSSCXX_X32}"
          export CFLAGS="${CFLAGS_X32}"
          export CXXFLAGS="${CFLAGS_X32}"
          export CROSSCFLAGS="${CROSSCFLAGS_X32}"
          export CROSSCXXFLAGS="${CROSSCFLAGS_X32}"
          
          mkdir build32-tools
          cd build32-tools
          PKG_CONFIG_LIBDIR=/usr/lib/i386-linux-gnu/pkgconfig:/usr/local/lib/pkgconfig:/usr/local/lib/i386-linux-gnu/pkgconfig build_with_bwrap 32 ../wine/configure --without-oss --disable-winemenubuilder --disable-tests --prefix "${BUILD_DIR}/wine-${BUILD_NAME}-x86"
          build_with_brap 32 make -j$(nproc) install
          cd ..
          
          # 构建 32 位 Wine
          echo "构建 32 位 Wine..."
          export CFLAGS="${CFLAGS_X64}"
          export CXXFLAGS="${CFLAGS_X64}"
          export CROSSCFLAGS="${CROSSCFLAGS_X64}"
          export CROSSCXXFLAGS="${CROSSCFLAGS_X64}"
          
          mkdir build32
          cd build32
          PKG_CONFIG_LIBDIR=/usr/lib/i386-linux-gnu/pkgconfig:/usr/local/lib/pkgconfig:/usr/local/lib/i386-linux-gnu/pkgconfig build_with_bwrap 32 ../wine/configure --with-wine64="${BUILD_DIR}/build64" --with-wine-tools="${BUILD_DIR}/build32-tools" --without-oss --disable-winemenubuilder --disable-tests --prefix "${BUILD_DIR}/wine-${BUILD_NAME}-amd64"
          build_with_bwrap 32 make -j$(nproc) install
          cd ..
          
          echo "创建归档文件..."
          export XZ_OPT="-9 -T 0"
          
          # 创建 x86 和 amd64 归档
          for build in "wine-${BUILD_NAME}-x86" "wine-${BUILD_NAME}-amd64"; do
            if [ -d "${build}" ]; then
              tar -Jcf "${build}.tar.xz" "${build}"
              mv "${build}.tar.xz" "$GITHUB_WORKSPACE"
            fi
          done
          
          echo "构建完成!"
      
      - name: Generate checksums
        run: |
          cd $GITHUB_WORKSPACE
          sha256sum *.tar.xz > checksums.txt
          cat checksums.txt
      
      - name: Upload Proton artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Proton-${{ github.event.inputs.proton_branch || 'proton_10.0' }}
          path: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
          retention-days: 30
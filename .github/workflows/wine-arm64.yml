name: Wine and Proton ARM64 Builder with FEX

on:
  schedule:
    # Proton 构建 - 每月1号和15号
    - cron: '0 0 1,15 * *'
    # Wine 构建 - 每月5号和20号
    - cron: '0 2 5,20 * *'
    # FEX 构建 - 每月10号和25号
    - cron: '0 4 10,25 * *'
  workflow_dispatch:
    inputs:
      build_type:
        description: '选择构建类型'
        required: true
        default: 'proton'
        type: choice
        options:
        - proton
        - wine-wow64
        - fex-emu
      proton_branch:
        description: 'Proton 分支 (仅 Proton 构建)'
        required: false
        default: 'proton_10.0'
        type: choice
        options:
        - proton_10.0
        - experimental_10.0
        - bleeding-edge
      wine_branch:
        description: 'Wine 分支 (仅 Wine 构建)'
        required: false
        default: 'staging'
        type: choice
        options:
        - vanilla
        - staging
        - staging-tkg
        - staging-tkg-fsync
      wine_version:
        description: 'Wine 版本 (仅 Wine 构建)'
        required: false
        default: 'latest'
        type: string

env:
  USE_CCACHE: true
  BUILD_DIR: /tmp/build_wine
  FEX_COMMIT: 4afbdd9afb4738b2abbf303493c5b67f58b8ae4c

permissions:
  contents: write  # 允许 GITHUB_TOKEN 创建 Release

jobs:
  setup-debian-trixie:
    runs-on: ubuntu-latest
    container:
      image: debian:trixie-slim
    steps:
      - name: 更新系统并安装基础工具
        run: |
          apt-get update
          apt-get install -y \
            curl \
            wget \
            gnupg \
            ca-certificates

  build-fex:
    runs-on: ubuntu-latest
    if: github.event.inputs.build_type == 'fex-emu' || (github.event_name == 'schedule' && github.event.schedule == '0 4 10,25 * *')
    container:
      image: debian:trixie-slim
    
    steps:
    - name: 更新 Debian Trixie 系统
      run: |
        apt-get update
        apt-get upgrade -y

    - name: Checkout FEX repository
      uses: actions/checkout@v4
      with:
        repository: FEX-Emu/FEX
        ref: ${{ env.FEX_COMMIT }}
        submodules: recursive
        path: fex-source

    - name: Install build dependencies
      run: |
        apt-get update
        apt-get install -y \
          cmake \
          clang \
          git \
          lld \
          llvm \
          llvm-dev \
          ninja-build \
          python3 \
          nasm \
          python3-clang \
          catch2 \
          libfmt-dev \
          libepoxy-dev \
          libsdl2-dev \
          libxxhash-dev \
          libasound2-dev \
          libdrm-dev \
          libgl1-mesa-dev \
          libx11-dev \
          libxrandr-dev \
          libssl-dev \
          libwayland-dev \
          zlib1g-dev

    - name: Download and extract llvm-mingw
      run: |
        wget -O llvm-mingw.tar.xz https://github.com/bylaws/llvm-mingw/releases/download/20250920/llvm-mingw-20250920-ucrt-ubuntu-22.04-aarch64.tar.xz
        tar -xf llvm-mingw.tar.xz -C /tmp

    - name: Build FEX-Emu for ARM64
      run: |
        set -e
        echo "开始构建 FEX-Emu for ARM64..."
        
        export PATH="/tmp/llvm-mingw-20250920-ucrt-ubuntu-22.04-aarch64/bin:$PATH"
        export CFLAGS="-O3 -g -pipe -Wall -Wextra"
        export CXXFLAGS="$CFLAGS"
        export LDFLAGS="-Wl,--gc-sections"
        
        cd fex-source
        
        # 直接构建 WOW64 版本（ARM64）
        echo "=== 构建 WOW64 版本 ==="
        mkdir build-wow64 && cd build-wow64
        
        cmake -DCMAKE_C_FLAGS="$CFLAGS" -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
          -GNinja \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_INSTALL_LIBDIR=lib/wine/aarch64-windows \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
          -DENABLE_LTO=False \
          -DTUNE_CPU=none \
          -DMINGW_TRIPLE=aarch64-w64-mingw32 \
          -DBUILD_TESTING=False \
          -DENABLE_JEMALLOC_GLIBC_ALLOC=OFF \
          ..
        
        # 修复 dlltool 命令
        if [ -f "build.ninja" ]; then
          sed -i 's/aarch64-w64-mingw32-dlltool/llvm-dlltool -m arm64/g' build.ninja
          ninja
        else
          echo "错误: build.ninja 文件未生成"
          exit 1
        fi
        
        cd ..
        
        echo "FEX-Emu WOW64 构建完成"

    - name: Install FEX artifacts
      run: |
        mkdir -p artifacts
        # 复制构建的 DLL 文件
        if [ -f "fex-source/build-wow64/libwow64fex.dll" ]; then
          cp fex-source/build-wow64/libwow64fex.dll artifacts/
          echo "已复制 libwow64fex.dll"
        else
          echo "错误: libwow64fex.dll 不存在"
          exit 1
        fi
        
        # 复制许可证和文档
        cp fex-source/LICENSE artifacts/
        cp fex-source/Readme.md artifacts/

    - name: Upload FEX artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fex-emu-wow64-dll
        path: artifacts/
        retention-days: 30

    - name: 发布 FEX 到 GitHub Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'fex-emu'
      with:
        tag_name: fex-emu-wow64-${{ env.FEX_COMMIT }}
        name: FEX-Emu WOW64 DLL (${{ env.FEX_COMMIT }})
        body: |
          # FEX-Emu WOW64 DLL for ARM64
          
          ## 版本信息
          - **提交**: ${{ env.FEX_COMMIT }}
          - **架构**: WOW64 (ARM64)
          - **平台**: Wine on ARM64
          - **构建环境**: Debian Trixie ARM64
          
          ## 包含文件
          - `libwow64fex.dll` - WOW64 版本
          
          ## 用途
          这个 DLL 文件用于在 ARM64 设备上通过 Wine 运行 x86/x64 Windows 应用程序。
          
          ## 安装说明
          将 DLL 文件放置在 Wine 的相应系统目录中。
          
          ## 构建信息
          - 构建时间: ${{ github.event.head_commit.timestamp }}
          - 提交: ${{ env.FEX_COMMIT }}
          - 工作流: ${{ github.workflow }}
          - 构建环境: Debian Trixie ARM64
          
          ## 注意
          - 这是纯 ARM64 构建，不包含 ARM64EC
          - 移除了复杂的补丁步骤，构建更稳定
        files: |
          ${{ github.workspace }}/artifacts/*
        draft: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-proton:
    runs-on: ubuntu-latest
    if: github.event.inputs.build_type == 'proton' || (github.event_name == 'schedule' && github.event.schedule == '0 0 1,15 * *')
    timeout-minutes: 360
    container:
      image: debian:trixie-slim
    
    steps:
      - uses: actions/checkout@v4

      - name: 修复基础系统
        run: |
          # 更新系统并安装基础工具链
          apt-get update
          apt-get install -y \
            build-essential \
            gcc \
            g++ \
            make \
            cmake \
            pkg-config \
            libc6-dev

      - name: 验证编译器
        run: |
          echo "验证 C 编译器..."
          gcc --version
          echo "验证 C++ 编译器..."
          g++ --version
          
          # 测试简单的 C 程序
          echo 'int main() { return 0; }' > test.c
          gcc test.c -o test
          if [ -f "./test" ]; then
            echo "✓ C 编译器测试通过"
            ./test
            echo "✓ 可执行文件运行测试通过"
            rm test.c test
          else
            echo "✗ C 编译器测试失败"
            exit 1
          fi

      - name: 更新 Debian Trixie 系统
        run: |
          apt-get update
          apt-get upgrade -y

      - name: 修复包管理系统
        run: |
          apt clean
          apt autoclean
          apt autoremove -y
          dpkg --configure -a
          apt update --fix-missing

      - name: 安装构建依赖
        run: |
          apt update
          
          # 修复包依赖问题
          apt --fix-broken install -y
          apt install -f -y
          
          # 基础构建依赖 - 按组安装
          echo "安装基础开发工具..."
          apt install -y \
            build-essential \
            debootstrap \
            perl \
            git \
            wget \
            curl \
            xz-utils \
            bubblewrap

          echo "安装自动构建工具..."
          apt install -y \
            autoconf \
            automake \
            autotools-dev \
            flex \
            bison \
            libtool

          echo "安装编译器和构建系统..."
          apt install -y \
            gcc \
            g++ \
            cmake \
            ninja-build \
            pkg-config

          echo "安装 X11 开发库..."
          apt install -y \
            libx11-dev \
            libxext-dev \
            libxi-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxfixes-dev \
            libxxf86vm-dev \
            libxrender-dev \
            libxinerama-dev

          echo "安装图形开发库..."
          apt install -y \
            libgl-dev \
            libglu-dev \
            libosmesa6-dev \
            libfreetype6-dev \
            libfontconfig1-dev

          echo "安装多媒体开发库..."
          apt install -y \
            libpcap-dev \
            libdbus-1-dev \
            libssl-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            libcups2-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libxml2-dev

          echo "安装 Vulkan 开发库..."
          apt install -y \
            libvulkan-dev \
            vulkan-tools \
            libvulkan1 \
            mesa-vulkan-drivers

          echo "安装国际化支持..."
          apt install -y \
            gettext \
            libgettextpo-dev \
            locales \
            locales-all

      - name: 安装交叉编译工具链
        run: |
          apt update
          echo "安装交叉编译工具链..."
          
          # 安装必要的交叉编译工具
          apt install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            binutils-arm-linux-gnueabihf
          
          echo "交叉编译器安装完成:"
          aarch64-linux-gnu-gcc --version
          arm-linux-gnueabihf-gcc --version

      - name: 安装 GStreamer 开发依赖
        run: |
          apt update
          
          # 安装完整的 GStreamer 开发文件
          echo "安装 GStreamer 开发依赖..."
          
          # 先安装基础包
          apt install -y \
            gstreamer1.0-tools \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav
          
          # 安装开发文件
          apt install -y \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-bad1.0-dev
          
          # 安装多媒体编解码器开发文件
          apt install -y \
            libmpg123-dev \
            libopenal-dev \
            libfaad-dev \
            libflac-dev \
            libvorbis-dev \
            libx264-dev \
            libx265-dev \
            libvpx-dev \
            libtheora-dev \
            libavcodec-dev \
            libavformat-dev \
            libavutil-dev \
            libswscale-dev
          
          echo "GStreamer 依赖安装完成"

      - name: 安装 SDL2 开发依赖
        run: |
          apt update
          echo "安装 SDL2 开发文件..."
          
          # 安装 SDL2 开发包
          apt install -y \
            libsdl2-dev \
            libsdl2-2.0-0 \
            libsdl2-image-dev \
            libsdl2-ttf-dev \
            libsdl2-mixer-dev
          
          echo "验证 SDL2 安装..."
          pkg-config --cflags sdl2
          pkg-config --libs sdl2

      - name: 修复 GStreamer pkgconfig 问题
        run: |
          echo "修复 GStreamer pkgconfig 问题..."
          
          # 查找所有可能的 pkgconfig 目录
          echo "查找所有 GStreamer pkgconfig 文件..."
          find /usr -name "*.pc" 2>/dev/null | grep gstreamer | head -10
          
          # 检查 64 位 gstreamer-plugins-base-1.0.pc 是否存在
          if [ ! -f "/usr/lib/aarch64-linux-gnu/pkgconfig/gstreamer-plugins-base-1.0.pc" ]; then
            echo "64 位 gstreamer-plugins-base-1.0.pc 不存在，尝试修复..."
            
            # 查找可能的位置
            ALT_LOCATION=$(find /usr -name "gstreamer-plugins-base-1.0.pc" 2>/dev/null | head -1)
            if [ -n "$ALT_LOCATION" ]; then
              echo "在其他位置找到: $ALT_LOCATION"
              # 创建符号链接
              mkdir -p /usr/lib/aarch64-linux-gnu/pkgconfig
              ln -sf "$ALT_LOCATION" "/usr/lib/aarch64-linux-gnu/pkgconfig/gstreamer-plugins-base-1.0.pc"
              echo "已创建符号链接"
            else
              echo "错误: 无法找到 gstreamer-plugins-base-1.0.pc 文件"
              # 尝试重新安装包
              apt install --reinstall -y libgstreamer-plugins-base1.0-dev
            fi
          fi
          
          # 验证修复结果
          echo "验证修复后的 GStreamer pkgconfig:"
          PKG_CONFIG_PATH="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/pkgconfig" pkg-config --exists gstreamer-plugins-base-1.0 && echo "gstreamer-plugins-base-1.0 找到" || echo "gstreamer-plugins-base-1.0 未找到"

      - name: 验证 GStreamer 安装
        run: |
          echo "验证 GStreamer 开发文件..."
          
          # 设置完整的 PKG_CONFIG_PATH
          export PKG_CONFIG_PATH_64="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/pkgconfig"
          
          echo "检查 64 位 GStreamer 开发文件:"
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH_64" pkg-config --cflags gstreamer-1.0
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH_64" pkg-config --cflags gstreamer-plugins-base-1.0

      - name: 设置中文语言环境
        run: |
          sed -i '/zh_CN.UTF-8/s/^# //' /etc/locale.gen
          locale-gen zh_CN.UTF-8
          update-locale LANG=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8

      - name: 设置编译环境
        run: |
          # 设置更宽松的 ulimit
          ulimit -s unlimited
          ulimit -n 65536
          
          # 显示系统资源
          echo "系统资源:"
          free -h
          df -h
          nproc
          cat /proc/meminfo | grep MemTotal

      - name: 构建 Proton ARM64 WOW64 版本
        run: |
            set -e
            
            echo "开始构建 Proton ARM64 WOW64 版本..."
            echo "分支: ${{ github.event.inputs.proton_branch || 'proton_10.0' }}"
            
            # 设置构建名称
            BUILD_NAME="proton-${{ github.event.inputs.proton_branch || 'proton_10.0' }}-arm64-wow64-xuser-debian-trixie"
            echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV
            
            # 设置中文构建环境
            export LANG=zh_CN.UTF-8
            export LC_ALL=zh_CN.UTF-8
            export LANGUAGE=zh_CN:zh:en_US:en
            
            # 清理并创建构建目录
            rm -rf $BUILD_DIR/proton
            mkdir -p $BUILD_DIR/proton
            cd $BUILD_DIR/proton
            
            # 克隆 Proton 源码
            git clone --depth=1 https://github.com/ValveSoftware/wine
            cd wine
            
            # 生成 configure 脚本
            echo "生成 configure 脚本..."
            ./autogen.sh > autogen.log 2>&1 || (cat autogen.log && exit 1)
            echo "autogen 完成"
            
            # 第一步：构建 64 位 Wine (aarch64-windows)
            echo "=== 构建 64 位 Wine (aarch64-windows) ==="
            mkdir -p build64
            cd build64
            
            # 使用原生编译器 - 简化编译选项
            export CC=gcc
            export CXX=g++
            export CFLAGS="-O3 -g -pipe -Wall -Wextra -fPIC"
            export CXXFLAGS="-O3 -g -pipe -Wall -Wextra -fPIC"
            export MAKEFLAGS="-j2"
            
            # 设置完整的 PKG_CONFIG_PATH
            export PKG_CONFIG_PATH="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/pkgconfig"
            
            # 测试编译器配置
            echo "测试编译器配置..."
            echo 'int main() { return 0; }' > test_configure.c
            $CC $CFLAGS test_configure.c -o test_configure
            if [ -f "./test_configure" ]; then
                echo "✓ 编译器配置测试通过"
                ./test_configure
                rm test_configure.c test_configure
            else
                echo "✗ 编译器配置测试失败"
                exit 1
            fi
            
            echo "配置 64 位 Wine (aarch64-windows)..."
            ../configure \
              --prefix=/tmp/wine-install-proton \
              --enable-win64 \
              --with-x \
              --with-alsa \
              --with-pulse \
              --with-freetype \
              --with-fontconfig \
              --with-gstreamer \
              --with-gettext \
              --with-sdl \
              --enable-nls \
              --disable-winemenubuilder \
              --disable-win16 \
              --disable-tests \
              --without-ldap \
              --without-capi \
              --without-oss \
              --without-cups \
              --without-dbus \
              --without-coreaudio \
              --without-gphoto \
              --without-osmesa \
              --without-sane \
              --without-pcap \
              --without-pcsclite \
              --without-udev \
              --without-unwind \
              --without-usb \
              --without-v4l2 \
              --without-wayland
            
            if [ $? -ne 0 ]; then
              echo "64位配置失败，查看日志:"
              cat configure64.log
              # 显示 config.log 获取更多信息
              if [ -f "config.log" ]; then
                echo "=== config.log 尾部 ==="
                tail -100 config.log
              fi
              exit 1
            fi
            echo "64位配置完成"
            
            echo "编译 64 位 Wine (aarch64-windows)..."
            # 使用 tee 来限制输出，同时保存完整日志
            make -j2 install > make64.log 2>&1 || (echo "64位编译失败，查看日志..." && tail -100 make64.log && make -j1 install > make64_single.log 2>&1 || (tail -100 make64_single.log && exit 1))
            echo "64位编译完成"
            
            cd ..
            
            # 第二步：构建 32 位 Wine (i386-windows) - 使用交叉编译
            echo "=== 构建 32 位 Wine (i386-windows) ==="
            mkdir -p build32
            cd build32
            
            # 设置交叉编译环境 - 构建i386架构
            echo "设置交叉编译环境 (i386)..."
            
            # 这里我们使用 mingw-w64 工具链来构建 Windows 目标
            # 安装 mingw-w64 交叉编译器
            apt install -y mingw-w64
            
            export CC="i686-w64-mingw32-gcc"
            export CXX="i686-w64-mingw32-g++"
            export HOST="i686-w64-mingw32"
            export CFLAGS="-O2 -g -pipe -Wall -Wextra"
            export CXXFLAGS="-O2 -g -pipe -Wall -Wextra"
            export LDFLAGS=""
            
            export AR="${CC%-gcc}-ar"
            export LD="${CC%-gcc}-ld"
            export RANLIB="${CC%-gcc}-ranlib"
            export STRIP="${CC%-gcc}-strip"
            export MAKEFLAGS="-j2"

            echo "使用的编译器: $CC"
            echo "目标平台: $HOST"
            echo "CFLAGS: $CFLAGS"
            echo "目标架构: i386-windows"

            # 验证编译器
            echo 'int main() { return 0; }' > test_i386.c
            if $CC $CFLAGS $LDFLAGS test_i386.c -o test_i386.exe; then
                echo "i386交叉编译器验证通过"
                file test_i386.exe
                rm test_i386.c test_i386.exe
            else
                echo "错误: i386交叉编译器验证失败"
                exit 1
            fi

            echo "配置 32 位 Wine (i386-windows)..."
            ../configure \
                --host=$HOST \
                --with-wine64=../build64 \
                --with-wine-tools=../build64 \
                --prefix=/tmp/wine-install-proton \
                --disable-winemenubuilder \
                --disable-win16 \
                --disable-tests \
                --with-x \
                --with-alsa \
                --with-pulse \
                --with-freetype \
                --with-fontconfig \
                --with-gstreamer \
                --without-ldap \
                --without-capi \
                --without-oss \
                --without-cups \
                --without-dbus \
                --without-coreaudio \
                --without-gphoto \
                --without-osmesa \
                --without-sane \
                --without-pcap \
                --without-pcsclite \
                --without-udev \
                --without-unwind \
                --without-usb \
                --without-v4l2 \
                --without-wayland > configure32.log 2>&1

            if [ $? -ne 0 ]; then
                echo "32位配置失败，查看日志:"
                cat configure32.log
                # 显示 config.log 获取更多信息
                if [ -f "config.log" ]; then
                    echo "=== config.log 尾部 ==="
                    tail -100 config.log
                fi
                exit 1
            fi
            echo "32位配置完成"
            
            echo "编译 32 位 Wine (i386-windows)..."
            # 使用 tee 来限制输出，同时保存完整日志
            make -j2 install > make32.log 2>&1 || (echo "32位编译失败，查看日志..." && tail -100 make32.log && make -j1 install > make32_single.log 2>&1 || (tail -100 make32_single.log && exit 1))
            echo "32位编译完成"
            
            echo "ARM64 WOW64 Wine 构建完成 (aarch64-windows + i386-windows)"

      - name: 上传构建日志（如需要）
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-logs
          path: |
            $BUILD_DIR/proton/wine/autogen.log
            $BUILD_DIR/proton/wine/build64/configure64.log
            $BUILD_DIR/proton/wine/build64/make64.log
            $BUILD_DIR/proton/wine/build64/make64_single.log
            $BUILD_DIR/proton/wine/build32/configure32.log
            $BUILD_DIR/proton/wine/build32/make32.log
            $BUILD_DIR/proton/wine/build32/make32_single.log
          retention-days: 7

      - name: 准备打包
        run: |
          # 创建打包目录
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          mkdir -p wine-package/$PACKAGE_NAME
          
          # 检查源目录是否存在
          if [ -d "/tmp/wine-install-proton" ]; then
            echo "复制 Wine 文件到 $PACKAGE_NAME..."
            cp -r /tmp/wine-install-proton/* wine-package/$PACKAGE_NAME/ || echo "复制文件时出现问题"
          else
            echo "错误: 源目录 /tmp/wine-install-proton 不存在"
            exit 1
          fi

      - name: 创建打包文件
        run: |
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          
          echo "检查打包目录内容:"
          if [ -d "wine-package/$PACKAGE_NAME" ]; then
            echo "最终文件结构:"
            find "wine-package/$PACKAGE_NAME" -type f | head -20
            echo "目录大小:"
            du -sh "wine-package/$PACKAGE_NAME"
            
            # 使用 tar.xz 格式打包
            tar -cJf "$PACKAGE_NAME.tar.xz" -C wine-package "$PACKAGE_NAME"
            
            echo "打包完成:"
            ls -lh *.tar.xz
          else
            echo "错误: 打包目录 wine-package/$PACKAGE_NAME 不存在"
            exit 1
          fi

      - name: Generate checksums
        run: |
          cd $GITHUB_WORKSPACE
          sha256sum *.tar.xz > checksums.txt
          cat checksums.txt

      - name: Upload Proton artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Proton-${{ github.event.inputs.proton_branch || 'proton_10.0' }}-ARM64-WoW64-xuser-debian-trixie
          path: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
          retention-days: 30

      - name: 发布 Proton 到 GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'proton'
        with:
          tag_name: proton-${{ github.event.inputs.proton_branch || 'proton_10.0' }}-arm64-wow64-xuser-debian-trixie
          name: Proton ${{ github.event.inputs.proton_branch || 'proton_10.0' }} (ARM64 WOW64 with Vulkan & GStreamer for Termux - xuser - Debian Trixie)
          body: |
            # Proton ${{ github.event.inputs.proton_branch || 'proton_10.0' }} - ARM64 WOW64 with Vulkan & GStreamer for Termux (xuser)
            
            ## 版本信息
            - **Proton 分支**: ${{ github.event.inputs.proton_branch || 'proton_10.0' }}
            - **架构**: ARM64 WOW64 (在 ARM64 设备上运行 32 位和 64 位 Windows 应用程序)
            - **平台**: Termux (Android ARM64)
            - **图形 API**: Vulkan 支持已启用
            - **多媒体**: 完整 GStreamer 支持
            - **用户名**: xuser (已移除 Steam 优化)
            - **构建环境**: Debian Trixie ARM64
            
            ## 特性
            ✓ ARM64 原生架构
            ✓ WOW64 支持 (在 ARM64 上运行 32 位和 64 位 Windows 应用程序)
            ✓ Vulkan 图形 API 支持
            ✓ 完整的 GStreamer 支持
            ✓ 中文环境支持
            ✓ 基于 Valve Proton，但移除了 Steam 特定优化
            ✓ 默认用户名改为 xuser
            ✓ 针对 ARM64 架构优化编译
            ✓ 在 Debian Trixie ARM64 环境中构建
            
            ## 重要变更
            - 所有对 `steamuser` 的引用已改为 `xuser`
            - 移除了 Steam 特定的优化和组件
            - 更适合通用 Windows 应用程序运行
            - 针对 ARM64 架构优化
            - 使用 Debian Trixie 构建环境，提供更新的工具链
            
            ## 安装说明
            解压后，将 `${{ env.BUILD_NAME }}` 文件夹放置在 Termux 的合适位置，并设置环境变量。

            ## 构建信息
            - 构建时间: ${{ github.event.head_commit.timestamp }}
            - 提交: ${{ github.sha }}
            - 工作流: ${{ github.workflow }}
            - 构建环境: Debian Trixie ARM64
          files: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-wine-wow64:
    runs-on: ubuntu-latest
    if: github.event.inputs.build_type == 'wine-wow64' || (github.event_name == 'schedule' && github.event.schedule == '0 2 5,20 * *')
    timeout-minutes: 360
    container:
      image: debian:trixie-slim
    
    steps:
      - uses: actions/checkout@v4
      
      - name: 修复基础系统
        run: |
          # 更新系统并安装基础工具链
          apt-get update
          apt-get install -y \
            build-essential \
            gcc \
            g++ \
            make \
            cmake \
            pkg-config \
            libc6-dev

      - name: 验证编译器
        run: |
          echo "验证 C 编译器..."
          gcc --version
          echo "验证 C++ 编译器..."
          g++ --version
          
          # 测试简单的 C 程序
          echo 'int main() { return 0; }' > test.c
          gcc test.c -o test
          if [ -f "./test" ]; then
            echo "✓ C 编译器测试通过"
            ./test
            echo "✓ 可执行文件运行测试通过"
            rm test.c test
          else
            echo "✗ C 编译器测试失败"
            exit 1
          fi
      
      - name: 更新 Debian Trixie 系统
        run: |
          apt-get update
          apt-get upgrade -y

      - name: 修复包管理系统
        run: |
          apt clean
          apt autoclean
          apt autoremove -y
          dpkg --configure -a
          apt update --fix-missing

      - name: 安装构建依赖
        run: |
          apt update
          
          # 修复包依赖问题
          apt --fix-broken install -y
          apt install -f -y
          
          # 基础构建依赖 - 按组安装
          echo "安装基础开发工具..."
          apt install -y \
            build-essential \
            debootstrap \
            perl \
            git \
            wget \
            curl \
            xz-utils \
            bubblewrap

          echo "安装自动构建工具..."
          apt install -y \
            autoconf \
            automake \
            autotools-dev \
            flex \
            bison \
            libtool

          echo "安装编译器和构建系统..."
          apt install -y \
            gcc \
            g++ \
            cmake \
            ninja-build \
            pkg-config

          echo "安装 X11 开发库..."
          apt install -y \
            libx11-dev \
            libxext-dev \
            libxi-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxfixes-dev \
            libxxf86vm-dev \
            libxrender-dev \
            libxinerama-dev

          echo "安装图形开发库..."
          apt install -y \
            libgl-dev \
            libglu-dev \
            libosmesa6-dev \
            libfreetype6-dev \
            libfontconfig1-dev

          echo "安装多媒体开发库..."
          apt install -y \
            libpcap-dev \
            libdbus-1-dev \
            libssl-dev \
            libasound2-dev \
            libpulse-dev \
            libudev-dev \
            libcups2-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            libxml2-dev

          echo "安装 Vulkan 开发库..."
          apt install -y \
            libvulkan-dev \
            vulkan-tools \
            libvulkan1 \
            mesa-vulkan-drivers

          echo "安装国际化支持..."
          apt install -y \
            gettext \
            libgettextpo-dev \
            locales \
            locales-all

      - name: 安装交叉编译工具链
        run: |
          apt update
          echo "安装交叉编译工具链..."
          
          # 安装 mingw-w64 用于交叉编译 Windows 目标
          apt install -y mingw-w64
          
          echo "交叉编译器安装完成:"
          i686-w64-mingw32-gcc --version
          x86_64-w64-mingw32-gcc --version

      - name: 安装 GStreamer 开发依赖
        run: |
          apt update
          
          # 安装完整的 GStreamer 开发文件
          echo "安装 GStreamer 开发依赖..."
          
          # 先安装基础包
          apt install -y \
            gstreamer1.0-tools \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-plugins-bad \
            gstreamer1.0-plugins-ugly \
            gstreamer1.0-libav
          
          # 安装开发文件
          apt install -y \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-good1.0-dev \
            libgstreamer-plugins-bad1.0-dev
          
          # 安装多媒体编解码器开发文件
          apt install -y \
            libmpg123-dev \
            libopenal-dev \
            libfaad-dev \
            libflac-dev \
            libvorbis-dev \
            libx264-dev \
            libx265-dev \
            libvpx-dev \
            libtheora-dev \
            libavcodec-dev \
            libavformat-dev \
            libavutil-dev \
            libswscale-dev
          
          echo "GStreamer 依赖安装完成"

      - name: 安装 SDL2 开发依赖
        run: |
          apt update
          echo "安装 SDL2 开发文件..."
          
          # 安装 SDL2 开发包
          apt install -y \
            libsdl2-dev \
            libsdl2-2.0-0 \
            libsdl2-image-dev \
            libsdl2-ttf-dev \
            libsdl2-mixer-dev
          
          echo "验证 SDL2 安装..."
          pkg-config --cflags sdl2
          pkg-config --libs sdl2

      - name: 修复 GStreamer pkgconfig 问题
        run: |
          echo "修复 GStreamer pkgconfig 问题..."
          
          # 查找所有可能的 pkgconfig 目录
          echo "查找所有 GStreamer pkgconfig 文件..."
          find /usr -name "*.pc" 2>/dev/null | grep gstreamer | head -10
          
          # 检查 64 位 gstreamer-plugins-base-1.0.pc 是否存在
          if [ ! -f "/usr/lib/aarch64-linux-gnu/pkgconfig/gstreamer-plugins-base-1.0.pc" ]; then
            echo "64 位 gstreamer-plugins-base-1.0.pc 不存在，尝试修复..."
            
            # 查找可能的位置
            ALT_LOCATION=$(find /usr -name "gstreamer-plugins-base-1.0.pc" 2>/dev/null | head -1)
            if [ -n "$ALT_LOCATION" ]; then
              echo "在其他位置找到: $ALT_LOCATION"
              # 创建符号链接
              mkdir -p /usr/lib/aarch64-linux-gnu/pkgconfig
              ln -sf "$ALT_LOCATION" "/usr/lib/aarch64-linux-gnu/pkgconfig/gstreamer-plugins-base-1.0.pc"
              echo "已创建符号链接"
            else
              echo "错误: 无法找到 gstreamer-plugins-base-1.0.pc 文件"
              # 尝试重新安装包
              apt install --reinstall -y libgstreamer-plugins-base1.0-dev
            fi
          fi
          
          # 验证修复结果
          echo "验证修复后的 GStreamer pkgconfig:"
          PKG_CONFIG_PATH="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/pkgconfig" pkg-config --exists gstreamer-plugins-base-1.0 && echo "gstreamer-plugins-base-1.0 找到" || echo "gstreamer-plugins-base-1.0 未找到"

      - name: 验证 GStreamer 安装
        run: |
          echo "验证 GStreamer 开发文件..."
          
          # 设置完整的 PKG_CONFIG_PATH
          export PKG_CONFIG_PATH_64="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/pkgconfig"
          
          echo "检查 64 位 GStreamer 开发文件:"
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH_64" pkg-config --cflags gstreamer-1.0
          PKG_CONFIG_PATH="$PKG_CONFIG_PATH_64" pkg-config --cflags gstreamer-plugins-base-1.0

      - name: 设置中文语言环境
        run: |
          sed -i '/zh_CN.UTF-8/s/^# //' /etc/locale.gen
          locale-gen zh_CN.UTF-8
          update-locale LANG=zh_CN.UTF-8
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8

      - name: 设置编译环境
        run: |
          # 设置更宽松的 ulimit
          ulimit -s unlimited
          ulimit -n 65536
          
          # 显示系统资源
          echo "系统资源:"
          free -h
          df -h
          nproc
          cat /proc/meminfo | grep MemTotal

      - name: 构建 Wine ARM64 WOW64 版本
        run: |
          set -e
          
          # 设置环境变量
          export WINE_BRANCH="${{ github.event.inputs.wine_branch || 'staging' }}"
          export WINE_VERSION="${{ github.event.inputs.wine_version || 'latest' }}"
          export BUILD_DIR="/tmp/build_wine_${WINE_BRANCH}_${WINE_VERSION}"
          
          echo "开始构建 Wine ARM64 WOW64 版本..."
          echo "分支: $WINE_BRANCH"
          echo "版本: $WINE_VERSION"
          
          # 设置中文构建环境
          export LANG=zh_CN.UTF-8
          export LC_ALL=zh_CN.UTF-8
          export LANGUAGE=zh_CN:zh:en_US:en
          
          # 清理并创建构建目录
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"
          cd "$BUILD_DIR"
          
          # 根据分支获取 Wine 源码
          if [ "$WINE_BRANCH" = "staging-tkg" ] || [ "$WINE_BRANCH" = "staging-tkg-fsync" ]; then
            # TKG 系列处理
            echo "处理 TKG 系列分支: $WINE_BRANCH"
            
            if [ "$WINE_BRANCH" = "staging-tkg" ]; then
              git clone --depth=1 https://github.com/Kron4ek/wine-tkg.git wine-tkg
              SOURCE_DIR="wine-tkg"
            else
              git clone --depth=1 --branch fsync https://github.com/Kron4ek/wine-tkg.git wine-tkg
              SOURCE_DIR="wine-tkg"
            fi
            
            cd "$SOURCE_DIR"
            
            if [ "$WINE_VERSION" != "latest" ]; then
              if git checkout "$WINE_VERSION" 2>/dev/null || git checkout "wine-$WINE_VERSION" 2>/dev/null; then
                echo "成功切换到版本 $WINE_VERSION"
              else
                echo "使用默认分支"
              fi
            fi
            
            if [ -f "VERSION" ]; then
              WINE_VERSION_ACTUAL="$(cat VERSION | tail -c +14)"
              echo "从 VERSION 文件获取版本: $WINE_VERSION_ACTUAL"
            else
              WINE_VERSION_ACTUAL=$(git describe --tags --abbrev=0 2>/dev/null || echo "$WINE_VERSION")
              echo "从 git 标签获取版本: $WINE_VERSION_ACTUAL"
            fi
            
            COMMIT_HASH=$(git rev-parse --short HEAD)
            BUILD_NAME="wine-${WINE_VERSION_ACTUAL}-${WINE_BRANCH}-arm64-wow64-debian-trixie"
            
          elif [ "$WINE_BRANCH" = "staging" ]; then
            # staging 分支处理
            echo "处理 Staging 分支"
            git clone --depth=1 https://github.com/wine-mirror/wine.git wine
            SOURCE_DIR="wine"
            cd "$SOURCE_DIR"
            
            git config advice.detachedHead false
            
            if [ "$WINE_VERSION" != "latest" ]; then
              git checkout "wine-$WINE_VERSION"
            fi
            WINE_VERSION_ACTUAL=$(git describe --tags --abbrev=0 2>/dev/null || echo "$WINE_VERSION")
            COMMIT_HASH=$(git rev-parse --short HEAD)
            BUILD_NAME="wine-${WINE_VERSION_ACTUAL}-${COMMIT_HASH}-staging-arm64-wow64-debian-trixie"
            
          elif [ "$WINE_BRANCH" = "vanilla" ]; then
            # vanilla 分支处理
            echo "处理 Vanilla 分支"
            git clone --depth=1 https://github.com/wine-mirror/wine.git wine
            SOURCE_DIR="wine"
            cd "$SOURCE_DIR"
            
            git config advice.detachedHead false
            
            if [ "$WINE_VERSION" != "latest" ]; then
              git checkout "wine-$WINE_VERSION"
            fi
            WINE_VERSION_ACTUAL=$(git describe --tags --abbrev=0 2>/dev/null || echo "$WINE_VERSION")
            COMMIT_HASH=$(git rev-parse --short HEAD)
            BUILD_NAME="wine-${WINE_VERSION_ACTUAL}-${COMMIT_HASH}-vanilla-arm64-wow64-debian-trixie"
            
          else
            echo "未知的 Wine 分支: $WINE_BRANCH"
            exit 1
          fi
          
          echo "BUILD_NAME=$BUILD_NAME" >> $GITHUB_ENV
          echo "当前源码目录: $(pwd)"
          echo "构建名称: $BUILD_NAME"
          
          # 生成 configure 脚本
          echo "生成 configure 脚本..."
          ./autogen.sh > autogen.log 2>&1 || (cat autogen.log && exit 1)
          echo "autogen 完成"
          
          # 第一步：构建 64 位 Wine (aarch64-windows)
          echo "=== 构建 64 位 Wine (aarch64-windows) ==="
          mkdir -p build64
          cd build64
          
          # 使用原生编译器 - 简化编译选项
          export CC=gcc
          export CXX=g++
          export CFLAGS="-O2 -g -pipe -Wall -Wextra -fPIC"
          export CXXFLAGS="-O2 -g -pipe -Wall -Wextra -fPIC"
          export MAKEFLAGS="-j2"
          
          # 设置完整的 PKG_CONFIG_PATH
          export PKG_CONFIG_PATH="/usr/lib/aarch64-linux-gnu/pkgconfig:/usr/share/pkgconfig:/usr/local/lib/pkgconfig"
          
          # 测试编译器配置
          echo "测试编译器配置..."
          echo 'int main() { return 0; }' > test_configure.c
          $CC $CFLAGS test_configure.c -o test_configure
          if [ -f "./test_configure" ]; then
              echo "✓ 编译器配置测试通过"
              ./test_configure
              rm test_configure.c test_configure
          else
              echo "✗ 编译器配置测试失败"
              exit 1
          fi
          
          echo "配置 64 位 Wine (aarch64-windows)..."
          ../configure \
            --prefix=/tmp/wine-install-wow64 \
            --enable-win64 \
            --with-x \
            --with-alsa \
            --with-pulse \
            --with-freetype \
            --with-fontconfig \
            --with-gstreamer \
            --with-gettext \
            --with-sdl \
            --enable-nls \
            --disable-winemenubuilder \
            --disable-win16 \
            --disable-tests \
            --without-ldap \
            --without-capi \
            --without-oss \
            --without-cups \
            --without-dbus \
            --without-coreaudio \
            --without-gphoto \
            --without-osmesa \
            --without-sane \
            --without-pcap \
            --without-pcsclite \
            --without-udev \
            --without-unwind \
            --without-usb \
            --without-v4l2 \
            --without-wayland > configure64.log 2>&1
          
          if [ $? -ne 0 ]; then
            echo "64位配置失败，查看日志:"
            cat configure64.log
            # 显示 config.log 获取更多信息
            if [ -f "config.log" ]; then
              echo "=== config.log 尾部 ==="
              tail -100 config.log
            fi
            exit 1
          fi
          echo "64位配置完成"
          
          echo "编译 64 位 Wine (aarch64-windows)..."
          # 使用 tee 来限制输出，同时保存完整日志
          make -j2 install > make64.log 2>&1 || (echo "64位编译失败，查看日志..." && tail -100 make64.log && make -j1 install > make64_single.log 2>&1 || (tail -100 make64_single.log && exit 1))
          echo "64位编译完成"
          
          cd ..
          
          # 第二步：构建 32 位 Wine (i386-windows) - 使用交叉编译
          echo "=== 构建 32 位 Wine (i386-windows) ==="
          mkdir -p build32
          cd build32
          
          # 设置交叉编译环境 - 构建i386架构
          echo "设置交叉编译环境 (i386)..."
          
          export CC="i686-w64-mingw32-gcc"
          export CXX="i686-w64-mingw32-g++"
          export HOST="i686-w64-mingw32"
          export CFLAGS="-O2 -g -pipe -Wall -Wextra"
          export CXXFLAGS="-O2 -g -pipe -Wall -Wextra"
          export LDFLAGS=""
          
          export AR="${CC%-gcc}-ar"
          export LD="${CC%-gcc}-ld"
          export RANLIB="${CC%-gcc}-ranlib"
          export STRIP="${CC%-gcc}-strip"
          export MAKEFLAGS="-j2"

          echo "使用的编译器: $CC"
          echo "目标平台: $HOST"
          echo "CFLAGS: $CFLAGS"
          echo "目标架构: i386-windows"

          # 验证编译器
          echo 'int main() { return 0; }' > test_i386.c
          if $CC $CFLAGS $LDFLAGS test_i386.c -o test_i386.exe; then
              echo "i386交叉编译器验证通过"
              file test_i386.exe
              rm test_i386.c test_i386.exe
          else
              echo "错误: i386交叉编译器验证失败"
              exit 1
          fi

          echo "配置 32 位 Wine (i386-windows)..."
          ../configure \
              --host=$HOST \
              --with-wine64=../build64 \
              --disable-winemenubuilder \
              --disable-win16 \
              --disable-tests \
              --without-x \
              --without-alsa \
              --without-pulse \
              --without-freetype \
              --without-fontconfig \
              --without-gstreamer \
              --without-ldap \
              --without-capi \
              --without-oss \
              --without-cups \
              --without-dbus \
              --without-coreaudio \
              --without-gphoto \
              --without-osmesa \
              --without-sane \
              --without-pcap \
              --without-pcsclite \
              --without-udev \
              --without-unwind \
              --without-usb \
              --without-v4l2 \
              --without-wayland > configure32.log 2>&1

          if [ $? -ne 0 ]; then
              echo "32位配置失败，查看日志:"
              cat configure32.log
              # 显示 config.log 获取更多信息
              if [ -f "config.log" ]; then
                  echo "=== config.log 尾部 ==="
                  tail -100 config.log
              fi
              exit 1
          fi
          echo "32位配置完成"
          
          echo "编译 32 位 Wine (i386-windows)..."
          # 使用 tee 来限制输出，同时保存完整日志
          make -j2 install > make32.log 2>&1 || (echo "32位编译失败，查看日志..." && tail -100 make32.log && make -j1 install > make32_single.log 2>&1 || (tail -100 make32_single.log && exit 1))
          echo "32位编译完成"
          
          echo "ARM64 WOW64 Wine 构建完成 (aarch64-windows + i386-windows)"

      - name: 上传构建日志（如需要）
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-logs
          path: |
            $BUILD_DIR/wine-tkg/autogen.log
            $BUILD_DIR/wine-tkg/build64/configure64.log
            $BUILD_DIR/wine-tkg/build64/make64.log
            $BUILD_DIR/wine-tkg/build64/make64_single.log
            $BUILD_DIR/wine-tkg/build32/configure32.log
            $BUILD_DIR/wine-tkg/build32/make32.log
            $BUILD_DIR/wine-tkg/build32/make32_single.log
          retention-days: 7

      - name: 准备打包
        run: |
          # 创建打包目录
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          mkdir -p wine-package/$PACKAGE_NAME
          
          # 检查源目录是否存在
          if [ -d "/tmp/wine-install-wow64" ]; then
            echo "复制 Wine 文件到 $PACKAGE_NAME..."
            cp -r /tmp/wine-install-wow64/* wine-package/$PACKAGE_NAME/ || echo "复制文件时出现问题"
          else
            echo "错误: 源目录 /tmp/wine-install-wow64 不存在"
            exit 1
          fi

      - name: 创建打包文件
        run: |
          PACKAGE_NAME="${{ env.BUILD_NAME }}"
          
          echo "检查打包目录内容:"
          if [ -d "wine-package/$PACKAGE_NAME" ]; then
            echo "最终文件结构:"
            find "wine-package/$PACKAGE_NAME" -type f | head -20
            echo "目录大小:"
            du -sh "wine-package/$PACKAGE_NAME"
            
            # 使用 tar.xz 格式打包
            tar -cJf "$PACKAGE_NAME.tar.xz" -C wine-package "$PACKAGE_NAME"
            
            echo "打包完成:"
            ls -lh *.tar.xz
          else
            echo "错误: 打包目录 wine-package/$PACKAGE_NAME 不存在"
            exit 1
          fi

      - name: Generate checksums
        run: |
          cd $GITHUB_WORKSPACE
          sha256sum *.tar.xz > checksums.txt
          cat checksums.txt

      - name: Upload Wine ARM64 WoW64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Wine-${{ github.event.inputs.wine_branch || 'staging' }}-${{ github.event.inputs.wine_version || 'latest' }}-ARM64-WoW64-debian-trixie
          path: |
            ${{ github.workspace }}/*.tar.xz
            ${{ github.workspace }}/checksums.txt
          retention-days: 30

      - name: 发布 Wine 到 GitHub Release
        uses: softprops/action-gh-release@v1
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.build_type == 'wine-wow64'
        with:
          tag_name: wine-${{ github.event.inputs.wine_branch || 'staging' }}-${{ github.event.inputs.wine_version || 'latest' }}-arm64-wow64-debian-trixie
          name: Wine ${{ github.event.inputs.wine_branch || 'staging' }} ${{ github.event.inputs.wine_version || 'latest' }} (ARM64 WOW64 with Vulkan & GStreamer for Termux - Debian Trixie)
          body: |
            # Wine ${{ github.event.inputs.wine_branch || 'staging' }} ${{ github.event.inputs.wine_version || 'latest' }} - ARM64 WOW64 with Vulkan & GStreamer for Termux
            
            ## 版本信息
            - **Wine 分支**: ${{ github.event.inputs.wine_branch || 'staging' }}
            - **Wine 版本**: ${{ github.event.inputs.wine_version || 'latest' }}
            - **架构**: ARM64 WOW64 (在 ARM64 设备上运行 32 位和 64 位 Windows 应用程序)
            - **平台**: Termux (Android ARM64)
            - **图形 API**: Vulkan 支持已启用
            - **多媒体**: 完整 GStreamer 支持
            - **构建环境**: Debian Trixie ARM64
            
            ## 特性
            ✓ ARM64 原生架构
            ✓ WOW64 支持 (在 ARM64 上运行 32 位和 64 位 Windows 应用程序)
            ✓ Vulkan 图形 API 支持
            ✓ 完整的 GStreamer 支持
            ✓ 中文环境支持
            ✓ 针对 ARM64 架构优化编译
            ✓ 在 Debian Trixie ARM64 环境中构建
            
            ## 安装说明
            解压后，将 `${{ env.BUILD_NAME }}` 文件夹放置在 Termux 的合适位置，并设置环境变量。

            ## 构建信息
            - 构建时间: ${{ github.event.head_commit.timestamp }}
            - 提交: ${{ github.sha }}
            - 工作流: ${{ github.workflow }}
            - 构建环境: Debian Trixie ARM64
          files: |
            ${{ github.workspace }}/${{ env.BUILD_NAME }}.tar.xz
            ${{ github.workspace }}/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
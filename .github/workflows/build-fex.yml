name: Build FEX-Emu Wine DLLs

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  SRCNAME: FEX
  COMMIT: 4afbdd9afb4738b2abbf303493c5b67f58b8ae4c
  SHORTCOMMIT: 4afbdd9
  FORGEURL: https://github.com/FEX-Emu/FEX
  FEX_CFLAGS: -O3 -g -pipe -Wall -Wextra
  FEX_LDFLAGS: -Wl,--gc-sections -static

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [arm64]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: ${{ env.COMMIT }}
        submodules: recursive

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          clang \
          git \
          lld \
          llvm \
          llvm-dev \
          ninja-build \
          python3 \
          sed \
          nasm \
          python3-clang \
          catch2 \
          libfmt-dev \
          libepoxy-dev \
          libsdl2-dev \
          libxxhash-dev \
          libasound2-dev \
          libdrm-dev \
          libgl1-mesa-dev \
          libx11-dev \
          libxrandr-dev \
          libssl-dev \
          libwayland-dev \
          zlib1g-dev
        if [ "${{ matrix.arch }}" = "x86_64" ]; then
          sudo apt-get install -y xbyak-dev
        fi

    - name: Download and extract llvm-mingw
      run: |
        wget https://github.com/bylaws/llvm-mingw/releases/download/20250920/llvm-mingw-20250920-ucrt-ubuntu-22.04-aarch64.tar.xz
        tar -xf llvm-mingw-20250920-ucrt-ubuntu-22.04-aarch64.tar.xz -C ${{ github.workspace }}

    - name: Setup external dependencies
      run: |
        mkdir -p External
        # Catch2
        wget https://github.com/catchorg/Catch2/archive/b3fb4b9/Catch2-b3fb4b9.tar.gz
        mkdir -p External/Catch2
        tar -xzf Catch2-b3fb4b9.tar.gz --strip-components=1 -C External/Catch2
        
        # cpp-optparse
        wget https://github.com/Sonicadvance1/cpp-optparse/archive/9f94388/cpp-optparse-9f94388.tar.gz
        mkdir -p External/Source/Common/cpp-optparse
        tar -xzf cpp-optparse-9f94388.tar.gz --strip-components=1 -C External/Source/Common/cpp-optparse
        
        # Vulkan-Headers
        wget https://github.com/KhronosGroup/Vulkan-Headers/archive/cacef30/Vulkan-Headers-cacef30.tar.gz
        mkdir -p External/Vulkan-Headers
        tar -xzf Vulkan-Headers-cacef30.tar.gz --strip-components=1 -C External/Vulkan-Headers
        
        # drm-headers
        wget https://github.com/FEX-Emu/kernel/archive/3e49836/kernel-3e49836.tar.gz
        mkdir -p External/kernel
        tar -xzf kernel-3e49836.tar.gz --strip-components=1 -C External/kernel
        
        # fmt
        wget https://github.com/fmtlib/fmt/archive/407c905/fmt-407c905.tar.gz
        mkdir -p External/fmt
        tar -xzf fmt-407c905.tar.gz --strip-components=1 -C External/fmt
        
        # jemalloc
        wget https://github.com/FEX-Emu/jemalloc/archive/ce24593/jemalloc-ce24593.tar.gz
        mkdir -p External/jemalloc
        tar -xzf jemalloc-ce24593.tar.gz --strip-components=1 -C External/jemalloc
        
        # jemalloc_glibc
        wget https://github.com/FEX-Emu/jemalloc/archive/8436195/jemalloc-8436195.tar.gz
        mkdir -p External/jemalloc_glibc
        tar -xzf jemalloc-8436195.tar.gz --strip-components=1 -C External/jemalloc_glibc
        
        # rpmalloc
        wget https://github.com/FEX-Emu/rpmalloc/archive/f1b76e1/rpmalloc-f1b76e1.tar.gz
        mkdir -p External/rpmalloc
        tar -xzf rpmalloc-f1b76e1.tar.gz --strip-components=1 -C External/rpmalloc
        
        # range-v3
        wget https://github.com/ericniebler/range-v3/archive/ca1388f/range-v3-ca1388f.tar.gz
        mkdir -p External/range-v3
        tar -xzf range-v3-ca1388f.tar.gz --strip-components=1 -C External/range-v3
        
        # robin-map
        wget https://github.com/FEX-Emu/robin-map/archive/d5683d9/robin-map-d5683d9.tar.gz
        mkdir -p External/robin-map
        tar -xzf robin-map-d5683d9.tar.gz --strip-components=1 -C External/robin-map
        
        # tracy
        wget https://github.com/wolfpld/tracy/archive/650c98e/tracy-650c98e.tar.gz
        mkdir -p External/tracy
        tar -xzf tracy-650c98e.tar.gz --strip-components=1 -C External/tracy
        
        # vixl
        wget https://github.com/FEX-Emu/vixl/archive/ed690c9/vixl-ed690c9.tar.gz
        mkdir -p External/vixl
        tar -xzf vixl-ed690c9.tar.gz --strip-components=1 -C External/vixl
        
        # xxhash
        wget https://github.com/Cyan4973/xxhash/archive/e626a72/xxhash-e626a72.tar.gz
        mkdir -p External/xxhash
        tar -xzf xxhash-e626a72.tar.gz --strip-components=1 -C External/xxhash

    - name: Apply patches
      run: |
        # Apply custom longjump patch
        curl -L ${{ env.FORGEURL }}/commit/a37def2c22e528477f64296747228400ddc40222.patch | git apply
        # Apply async run_one interface patch
        curl -L ${{ env.FORGEURL }}/commit/8eaf45414c05c9e7ef6f74a323d95fe7e0d883c1.patch | git apply
        # Apply FEXServer timeout patch
        curl -L ${{ env.FORGEURL }}/commit/c326e2d669fd5e9356f6107e188413a449cc1fd7.patch | git apply

    - name: Build ARM64EC
      run: |
        export PATH="${{ github.workspace }}/llvm-mingw-20250920-ucrt-ubuntu-22.04-aarch64/bin:$PATH"
        export CFLAGS="${{ env.FEX_CFLAGS }}"
        export CXXFLAGS="$CFLAGS"
        export LDFLAGS="${{ env.FEX_LDFLAGS }}"
        
        mkdir build-arm64ec
        cd build-arm64ec
        
        cmake -DCMAKE_C_FLAGS="$CFLAGS" -DCMAKE_CXX_FLAGS="$CFLAGS" \
          -GNinja \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_INSTALL_LIBDIR=lib/wine/aarch64-windows \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
          -DENABLE_LTO=False \
          -DTUNE_CPU=none \
          -DMINGW_TRIPLE=arm64ec-w64-mingw32 \
          -DBUILD_TESTING=False \
          -DENABLE_JEMALLOC_GLIBC_ALLOC=False \
          ..
        
        sed -i 's/arm64ec-w64-mingw32-dlltool/llvm-dlltool -m arm64ec/g' build.ninja
        ninja

    - name: Build WOW64
      run: |
        export PATH="${{ github.workspace }}/llvm-mingw-20250920-ucrt-ubuntu-22.04-aarch64/bin:$PATH"
        export CFLAGS="${{ env.FEX_CFLAGS }}"
        export CXXFLAGS="$CFLAGS"
        export LDFLAGS="${{ env.FEX_LDFLAGS }}"
        
        mkdir build-wow64
        cd build-wow64
        
        cmake -DCMAKE_C_FLAGS="$CFLAGS" -DCMAKE_CXX_FLAGS="$CFLAGS" \
          -GNinja \
          -DCMAKE_INSTALL_PREFIX=/usr \
          -DCMAKE_INSTALL_LIBDIR=lib/wine/aarch64-windows \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_TOOLCHAIN_FILE=../Data/CMake/toolchain_mingw.cmake \
          -DENABLE_LTO=False \
          -DTUNE_CPU=none \
          -DMINGW_TRIPLE=aarch64-w64-mingw32 \
          -DBUILD_TESTING=False \
          -DENABLE_JEMALLOC_GLIBC_ALLOC=OFF \
          ..
        
        sed -i 's/aarch64-w64-mingw32-dlltool/llvm-dlltool -m arm64/g' build.ninja
        ninja

    - name: Install artifacts
      run: |
        mkdir -p artifacts
        # Copy built DLLs to artifacts directory
        cp build-arm64ec/libarm64ecfex.dll artifacts/
        cp build-wow64/libwow64fex.dll artifacts/
        cp LICENSE artifacts/
        cp Readme.md artifacts/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: fex-emu-wine-dlls
        path: artifacts/
        retention-days: 30

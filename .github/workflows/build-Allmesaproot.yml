# build-mesaproot.yml
name: Build All-Mesa for proot (Multi-arch)

on:
  workflow_dispatch:
    inputs:
      mesa_branch:
        description: 'Mesa åˆ†æ”¯ (å¯é€‰ï¼Œé»˜è®¤ä¸º adreno-main)'
        required: false
        default: 'adreno-main'
        type: string
      use_upstream:
        description: 'æ˜¯å¦ä½¿ç”¨ä¸Šæ¸¸å®˜æ–¹ Mesa (è€Œä¸æ˜¯ lfdevs çš„åˆ†æ”¯)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      target_arch:
        description: 'ç›®æ ‡æ¶æ„'
        required: false
        default: 'aarch64'
        type: choice
        options:
          - 'aarch64'
          - 'arm-linux-gnueabihf'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    
    strategy:
      matrix:
        arch: [${{ github.event.inputs.target_arch || 'aarch64' }}]

    steps:
    - name: è®¾ç½®æ„å»ºå‚æ•°
      id: setup
      run: |
        # è®¾ç½®é»˜è®¤å‚æ•°
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "MESA_BRANCH=${{ github.event.inputs.mesa_branch }}" >> $GITHUB_ENV
          echo "USE_UPSTREAM=${{ github.event.inputs.use_upstream }}" >> $GITHUB_ENV
          echo "TARGET_ARCH=${{ github.event.inputs.target_arch || 'aarch64' }}" >> $GITHUB_ENV
        else
          echo "MESA_BRANCH=adreno-main" >> $GITHUB_ENV
          echo "USE_UPSTREAM=false" >> $GITHUB_ENV
          echo "TARGET_ARCH=${{ matrix.arch }}" >> $GITHUB_ENV
        fi
        
        BUILD_DATE=$(date +%Y%m%d)
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        
        # æ ¹æ®æ¶æ„è®¾ç½®å®‰è£…ç›®å½•å‰ç¼€
        if [ "$TARGET_ARCH" = "aarch64" ]; then
          echo "INSTALL_PREFIX=/opt/mesa-aarch64" >> $GITHUB_ENV
          echo "MESON_CPU=aarch64" >> $GITHUB_ENV
          echo "CROSS_PREFIX=" >> $GITHUB_ENV
        elif [ "$TARGET_ARCH" = "arm-linux-gnueabihf" ]; then
          echo "INSTALL_PREFIX=/opt/mesa-armhf" >> $GITHUB_ENV
          echo "MESON_CPU=arm" >> $GITHUB_ENV
          echo "CROSS_PREFIX=arm-linux-gnueabihf-" >> $GITHUB_ENV
        fi
        
        echo "ä½¿ç”¨çš„ Mesa åˆ†æ”¯: $MESA_BRANCH"
        echo "æ˜¯å¦ä½¿ç”¨ä¸Šæ¸¸: $USE_UPSTREAM"
        echo "ç›®æ ‡æ¶æ„: $TARGET_ARCH"
        echo "å®‰è£…ç›®å½•: $INSTALL_PREFIX"
        echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"

    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4

    - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        echo "æ„å»ºç¯å¢ƒä¿¡æ¯:"
        uname -a
        lscpu | grep -E 'Model name|Architecture|CPU MHz|Core'
        free -h
        echo "å½“å‰æ¶æ„: $(uname -m)"
        echo "ç›®æ ‡æ¶æ„: $TARGET_ARCH"

    - name: å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        sudo sed -i "s/^Types: deb$/Types: deb deb-src/" /etc/apt/sources.list.d/ubuntu.sources
        sudo apt update
        
        # åŸºç¡€ä¾èµ–
        sudo apt install -y \
          glslang-tools libxrandr-dev libxxf86vm-dev libxcb-shm0-dev libxcb-glx0-dev \
          libxext-dev llvm-19 libx11-dev libx11-xcb-dev libxcb1-dev libxcb-dri3-dev \
          libxcb-present-dev libxcb-randr0-dev libxcb-sync-dev libxcb-xfixes0-dev \
          libxshmfence-dev libdrm-dev libgbm-dev libegl1-mesa-dev libexpat1-dev \
          libwayland-dev python3-pip python3-setuptools python3-wheel ninja-build \
          flex bison libtool pkg-config
        
        # æ ¹æ®ç›®æ ‡æ¶æ„å®‰è£…é¢å¤–çš„å·¥å…·é“¾
        if [ "$TARGET_ARCH" = "arm-linux-gnueabihf" ]; then
          echo "å®‰è£… ARM äº¤å‰ç¼–è¯‘å·¥å…·é“¾..."
          sudo apt install -y \
            gcc-arm-linux-gnueabihf \
            g++-arm-linux-gnueabihf \
            binutils-arm-linux-gnueabihf \
            libdrm-dev:armhf \
            libx11-dev:armhf \
            libxext-dev:armhf \
            libxfixes-dev:armhf \
            libxcb1-dev:armhf \
            libxcb-dri3-dev:armhf \
            libxcb-present-dev:armhf \
            libxcb-sync-dev:armhf \
            libxshmfence-dev:armhf \
            libxxf86vm-dev:armhf \
            libexpat1-dev:armhf
        fi

    - name: å®‰è£… Python æ„å»ºå·¥å…·
      run: |
        sudo pip3 install meson mako
        
        echo "æ£€æŸ¥å®‰è£…çš„ meson ç‰ˆæœ¬:"
        meson --version
        python3 -c "import mesonbuild; print('mesonbuild æ¨¡å—è·¯å¾„:', mesonbuild.__file__)"
        
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: å…‹éš† Mesa æºç 
      run: |
        echo "ğŸ“¥ å…‹éš† Mesa ä»“åº“..."
        
        if [ "$USE_UPSTREAM" = "true" ]; then
          echo "ä½¿ç”¨ä¸Šæ¸¸å®˜æ–¹ Mesa ä»“åº“"
          git clone https://gitlab.freedesktop.org/mesa/mesa.git
          cd mesa
        else
          echo "ä½¿ç”¨ lfdevs çš„ Mesa for Android Container ä»“åº“"
          git clone https://github.com/lfdevs/mesa-for-android-container.git mesa
          cd mesa
          
          # æ£€å‡ºæŒ‡å®šåˆ†æ”¯
          if [ -n "$MESA_BRANCH" ] && [ "$MESA_BRANCH" != "main" ]; then
            echo "æ£€å‡ºåˆ†æ”¯: $MESA_BRANCH"
            git checkout $MESA_BRANCH
          fi
        fi
        
        # è·å–ç‰ˆæœ¬ä¿¡æ¯
        GIT_HASH=$(git rev-parse --short HEAD)
        if [ -f "VERSION" ]; then
          OFFICIAL_VERSION=$(cat VERSION)
        else
          OFFICIAL_VERSION="git-$GIT_HASH"
        fi
        
        GIT_DESCRIBE=$(git describe --tags --always 2>/dev/null || echo "custom-$GIT_HASH")
        
        echo "MESA_GIT_HASH=$GIT_HASH" >> $GITHUB_ENV
        echo "MESA_VERSION=$OFFICIAL_VERSION" >> $GITHUB_ENV
        echo "GIT_DESCRIBE=$GIT_DESCRIBE" >> $GITHUB_ENV
        
        echo "âœ… æºç å…‹éš†å®Œæˆ"
        echo "ç‰ˆæœ¬: $OFFICIAL_VERSION"
        echo "æäº¤: $GIT_HASH"
        echo "æè¿°: $GIT_DESCRIBE"
        echo "åˆ†æ”¯: $(git branch --show-current)"

    - name: ä¸º armhf è®¾ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒ
      if: env.TARGET_ARCH == 'arm-linux-gnueabihf'
      run: |
        echo "è®¾ç½® ARM äº¤å‰ç¼–è¯‘ç¯å¢ƒ..."
        
        # åˆ›å»ºäº¤å‰ç¼–è¯‘é…ç½®æ–‡ä»¶
        cat > cross-file.txt << EOF
        [binaries]
        c = 'arm-linux-gnueabihf-gcc'
        cpp = 'arm-linux-gnueabihf-g++'
        ar = 'arm-linux-gnueabihf-ar'
        strip = 'arm-linux-gnueabihf-strip'
        pkgconfig = 'arm-linux-gnueabihf-pkg-config'
        
        [host_machine]
        system = 'linux'
        cpu_family = 'arm'
        cpu = '$MESON_CPU'
        endian = 'little'
        
        [properties]
        needs_exe_wrapper = true
        
        [paths]
        prefix = '$INSTALL_PREFIX'
        EOF
        
        echo "äº¤å‰ç¼–è¯‘é…ç½®æ–‡ä»¶:"
        cat cross-file.txt
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export CC="arm-linux-gnueabihf-gcc"
        export CXX="arm-linux-gnueabihf-g++"
        export AR="arm-linux-gnueabihf-ar"
        export STRIP="arm-linux-gnueabihf-strip"
        export PKG_CONFIG_PATH="/usr/lib/arm-linux-gnueabihf/pkgconfig"
        export PKG_CONFIG_SYSROOT_DIR="/usr/arm-linux-gnueabihf"
        
        echo "äº¤å‰ç¼–è¯‘ç¯å¢ƒå˜é‡å·²è®¾ç½®"

    - name: æ„å»º Mesa
      run: |
        cd mesa
        
        echo "ğŸ”¨ å¼€å§‹æ„å»º Mesa..."
        echo "ç›®æ ‡æ¶æ„: $TARGET_ARCH"
        BUILD_START=$(date +%s)
        
        # åˆ›å»ºå®‰è£…ç›®å½•
        sudo mkdir -p $INSTALL_PREFIX
        sudo chmod 777 -R /opt
        
        # åˆ›å»ºæ„å»ºç›®å½•
        mkdir -p builddir
        
        # éªŒè¯ä½¿ç”¨çš„å·¥å…·
        echo "æ£€æŸ¥æ„å»ºå·¥å…·:"
        which meson
        meson --version
        which ninja
        ninja --version
        
        if [ "$TARGET_ARCH" = "arm-linux-gnueabihf" ]; then
          echo "æ£€æŸ¥äº¤å‰ç¼–è¯‘å·¥å…·:"
          which arm-linux-gnueabihf-gcc
          arm-linux-gnueabihf-gcc --version
        fi
        
        # å‡†å¤‡æ„å»ºå‘½ä»¤
        MESON_CMD="meson setup builddir \
           -Dprefix=$INSTALL_PREFIX \
           -Dplatforms=x11 \
           -Dbuildtype=release \
           -Degl-native-platform=x11 \
           -Dvulkan-beta=true \
           -Dgallium-extra-hud=true \
           -Dgallium-drivers=freedreno,zink \
           -Dmediafoundation-codecs=all \
           -Dvulkan-drivers=freedreno \
           -Dfreedreno-kmds=kgsl \
           -Dshader-cache=enabled \
           -Dgles1=enabled \
           -Dgles2=enabled \
           -Dopengl=true \
           -Dgbm=enabled \
           -Dglx=dri \
           -Degl=enabled \
           -Dglvnd=enabled \
           -Dmicrosoft-clc=disabled \
           -Dllvm=enabled \
           -Dshared-llvm=enabled \
           -Dvulkan-beta=true \
           -Dvideo-codecs=all"
        
        # å¦‚æœæ˜¯äº¤å‰ç¼–è¯‘ï¼Œæ·»åŠ äº¤å‰ç¼–è¯‘æ–‡ä»¶
        if [ "$TARGET_ARCH" = "arm-linux-gnueabihf" ]; then
          MESON_CMD="$MESON_CMD --cross-file ../cross-file.txt"
        fi
        
        echo "æ‰§è¡Œé…ç½®å‘½ä»¤:"
        echo $MESON_CMD
        
        # é…ç½®æ„å»ºé€‰é¡¹
        eval $MESON_CMD
        
        # æ£€æŸ¥é…ç½®çŠ¶æ€
        echo "é…ç½®çŠ¶æ€æ£€æŸ¥:"
        meson configure builddir || true
        
        # å¼€å§‹æ„å»º
        echo "ğŸ—ï¸  æ­£åœ¨æ„å»º..."
        ninja -C builddir -j$(nproc)
        
        echo "ğŸ“¦ æ­£åœ¨å®‰è£…..."
        sudo ninja -C builddir install
        
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        echo "âœ… æ„å»ºå®Œæˆï¼Œè€—æ—¶: ${BUILD_TIME}ç§’"
        
        # éªŒè¯å®‰è£…
        echo "å®‰è£…éªŒè¯:"
        ls -la $INSTALL_PREFIX
        if [ -d "$INSTALL_PREFIX/lib" ]; then
          echo "åº“æ–‡ä»¶:"
          ls -la $INSTALL_PREFIX/lib/ || true
          
          # æ£€æŸ¥æ–‡ä»¶ç±»å‹
          echo "æ£€æŸ¥å…³é”®åº“æ–‡ä»¶çš„æ¶æ„:"
          find $INSTALL_PREFIX/lib -name "*.so*" | head -5 | while read -r lib; do
            if [ -f "$lib" ]; then
              echo "æ–‡ä»¶: $lib"
              file "$lib" || true
            fi
          done
        fi

    - name: æ‰“åŒ…æ„å»ºäº§ç‰©
      run: |
        echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…..."
        
        # åˆ›å»ºç‰ˆæœ¬åŒ–çš„åŒ…å
        PACKAGE_NAME="prootmesa-${MESA_VERSION}-${TARGET_ARCH}"
        
        # æ‰“åŒ…å®Œæ•´å®‰è£…ç›®å½•
        cd /opt
        tar -czvf "${HOME}/${PACKAGE_NAME}-full.tar.gz" $(basename $INSTALL_PREFIX)/
        
        # ä»…æ‰“åŒ… Vulkan é©±åŠ¨ï¼ˆå¯é€‰ï¼‰
        cd $INSTALL_PREFIX
        if [ -d "lib" ]; then
          # æŸ¥æ‰¾å¹¶æ‰“åŒ…æ‰€æœ‰ Vulkan é©±åŠ¨
          find lib -name "libvulkan_*.so" -o -name "*vulkan*.so*" 2>/dev/null | while read -r file; do
            echo "æ‰¾åˆ° Vulkan é©±åŠ¨: $file"
          done
          tar -czvf "${HOME}/${PACKAGE_NAME}-vulkan.tar.gz" $(find lib -name "libvulkan_*.so" -o -name "*vulkan*.so*" 2>/dev/null) 2>/dev/null || true
        fi
        
        # ç§»åŠ¨å›å·¥ä½œç›®å½•
        cd $GITHUB_WORKSPACE
        mv "${HOME}/${PACKAGE_NAME}-full.tar.gz" .
        if [ -f "${HOME}/${PACKAGE_NAME}-vulkan.tar.gz" ]; then
          mv "${HOME}/${PACKAGE_NAME}-vulkan.tar.gz" .
        fi
        
        # ç”Ÿæˆæ ¡éªŒå’Œ
        sha256sum ${PACKAGE_NAME}-*.tar.gz > checksums.txt
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
        echo "FULL_PACKAGE=${PACKAGE_NAME}-full.tar.gz" >> $GITHUB_ENV
        
        echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ:"
        ls -lh *.tar.gz

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v4
      with:
        name: prootmesa-${{ env.MESA_VERSION }}-${{ env.TARGET_ARCH }}
        path: |
          ${{ env.PACKAGE_NAME }}-*.tar.gz
          checksums.txt

    - name: åˆ›å»ºè½»é‡çº§å‘å¸ƒ
      uses: softprops/action-gh-release@v1
      if: ${{ github.event_name == 'workflow_dispatch' }}
      with:
        tag_name: prootmesa-${{ env.MESA_VERSION }}-${{ env.TARGET_ARCH }}-${{ env.BUILD_DATE }}
        name: Mesa proot ${{ env.MESA_VERSION }} (${{ env.TARGET_ARCH }})
        body: |
          Mesa 3D Graphics Library for Termux proot (proot) on ${{ env.TARGET_ARCH }}
          
          æ„å»ºä¿¡æ¯:
          - **ç‰ˆæœ¬**: ${{ env.MESA_VERSION }}
          - **ç›®æ ‡æ¶æ„**: ${{ env.TARGET_ARCH }}
          - **Git æè¿°**: ${{ env.GIT_DESCRIBE }}
          - **æäº¤å“ˆå¸Œ**: ${{ env.MESA_GIT_HASH }}
          - **æ„å»ºæ—¥æœŸ**: ${{ env.BUILD_DATE }}
          - **åˆ†æ”¯**: ${{ env.MESA_BRANCH }}
          - **ä»“åº“**: $(if [ "${{ env.USE_UPSTREAM }}" = "true" ]; then echo "ä¸Šæ¸¸å®˜æ–¹"; else echo "lfdevs/android-container"; fi)
          
          åŒ…å«æ–‡ä»¶:
          - `${{ env.FULL_PACKAGE }}` - å®Œæ•´ Mesa å®‰è£…åŒ…
          - `*-vulkan.tar.gz` - ä»… Vulkan é©±åŠ¨ (å¯é€‰)
          - `checksums.txt` - æ ¡éªŒå’Œæ–‡ä»¶
          
          å®‰è£…è¯´æ˜:
          1. ä¸‹è½½å®Œæ•´çš„ tar.gz åŒ…
          2. åœ¨ proot ç¯å¢ƒä¸­è§£å‹åˆ°æ ¹ç›®å½•: `tar -xzf package.tar.gz -C /`
          3. æˆ–è€…è§£å‹åˆ°è‡ªå®šä¹‰ç›®å½•å¹¶è®¾ç½®ç¯å¢ƒå˜é‡:
             ```bash
             export LD_LIBRARY_PATH=/path/to/mesa/lib:$LD_LIBRARY_PATH
             export LIBGL_DRIVERS_PATH=/path/to/mesa/lib/dri
             ```
          
          æ³¨æ„:
          - éœ€è¦ Termux çš„ proot ç¯å¢ƒ (å¦‚ prootdistro çš„ Ubuntu/Debian)
          - æ¨èåœ¨ proot å®¹å™¨ä¸­ä½¿ç”¨
          - å¯¹äº arm-linux-gnueabihf æ„å»ºï¼Œéœ€è¦åœ¨ 32 ä½ ARM ç¯å¢ƒä¸­ä½¿ç”¨
        files: |
          ${{ env.PACKAGE_NAME }}-*.tar.gz
          checksums.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: è¾“å‡ºæ€»ç»“
      run: |
        echo "âœ… Mesa proot æ„å»ºå®Œæˆ!"
        echo "================================"
        echo "ç‰ˆæœ¬: $MESA_VERSION"
        echo "æäº¤: $MESA_GIT_HASH"
        echo "æ„å»ºæ—¥æœŸ: $BUILD_DATE"
        echo "åˆ†æ”¯: $MESA_BRANCH"
        echo "ç›®æ ‡æ¶æ„: $TARGET_ARCH"
        echo "ç¯å¢ƒ: Termux (proot)"
        echo ""
        echo "ğŸ“¦ ç”Ÿæˆçš„æ–‡ä»¶:"
        ls -1 *.tar.gz | while read file; do
          echo "  - $file"
        done
        echo ""
        echo "é©±åŠ¨æ”¯æŒ:"
        echo "  âœ“ Gallium: zink, freedreno, llvmpipe, softpipe"
        echo "  âœ“ Vulkan: freedreno, swrast"
        echo "  âœ“ OpenGL, OpenGL ES 1.x/2.x"
        echo "  âœ“ EGL, GBM"
        echo ""
        echo "å®‰è£…ç›®å½•: $INSTALL_PREFIX"